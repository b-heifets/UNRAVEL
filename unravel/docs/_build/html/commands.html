
<!DOCTYPE html>


<html lang="en" data-content_root="./" data-theme="dark">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Commands &#8212; UNRAVEL 1.0.0-beta documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "dark";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "dark";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css?v=981a9575" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=3ee479438cf8b5e0d341"></script>

    <script src="_static/documentation_options.js?v=3fd7a760"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'commands';</script>
    <link rel="icon" href="_static/favicon.png"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="unravel" href="modules.html" />
    <link rel="prev" title="Guide" href="guide.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="dark">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
  
    <p class="title logo__title">UNRAVEL 1.0.0-beta documentation</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item pst-header-nav-item">
  <a class="nav-link nav-internal" href="installation.html">
    Installation
  </a>
</li>


<li class="nav-item pst-header-nav-item">
  <a class="nav-link nav-internal" href="guide.html">
    Guide
  </a>
</li>


<li class="nav-item pst-header-nav-item current active">
  <a class="nav-link nav-internal" href="#">
    Commands
  </a>
</li>


<li class="nav-item pst-header-nav-item">
  <a class="nav-link nav-internal" href="modules.html">
    unravel
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
    <button class="sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item pst-header-nav-item">
  <a class="nav-link nav-internal" href="installation.html">
    Installation
  </a>
</li>


<li class="nav-item pst-header-nav-item">
  <a class="nav-link nav-internal" href="guide.html">
    Guide
  </a>
</li>


<li class="nav-item pst-header-nav-item current active">
  <a class="nav-link nav-internal" href="#">
    Commands
  </a>
</li>


<li class="nav-item pst-header-nav-item">
  <a class="nav-link nav-internal" href="modules.html">
    unravel
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"></div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">Commands</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="commands">
<h1>Commands<a class="headerlink" href="#commands" title="Link to this heading">#</a></h1>
<p>This section provides an overview of common commands available in UNRAVEL, ~organized by their respective steps.</p>
<p>For a complete list of commands, please view the [project.scripts] section of the pyproject.toml in the root directory of the <a class="reference external" href="https://github.com/b-heifets/UNRAVEL/tree/dev">UNRAVEL repository</a>. Also look here for the name of scripts associated w/ each command.</p>
<p>For help, run</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">command</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">h</span>

<span class="c1"># Or </span>
<span class="o">&lt;</span><span class="n">script</span><span class="o">.</span><span class="n">py</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">h</span> 
</pre></div>
</div>
<p>Variables below (e.g., $XY) can be defined in a script (e.g., env_var.sh) that can be sourced to load them in the current terminal session. See the <a class="reference internal" href="guide.html"><span class="std std-doc">Guide</span></a> for more info.</p>
<ul class="simple">
<li><p><a class="reference internal" href="#registration">Registration</a></p>
<ul>
<li><p>metadata</p></li>
<li><p>prep_reg</p></li>
<li><p>copy_tifs</p></li>
<li><p>brain_mask</p></li>
<li><p>reg</p></li>
<li><p>check_reg</p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#segmentation">Segmentation</a></p>
<ul>
<li><p>copy_tifs</p></li>
<li><p>seg</p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#voxel-wise-stats">Voxel-wise stats</a></p>
<ul>
<li><p>prep_vstats</p></li>
<li><p>z_score</p></li>
<li><p>agg_files_from_dirs</p></li>
<li><p>whole_to_avg</p></li>
<li><p>avg</p></li>
<li><p>vstats</p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#cluster-correction">Cluster correction</a></p>
<ul>
<li><p>fdr_range</p></li>
<li><p>fdr</p></li>
<li><p>recursive_mirror_index</p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#cluster-validation">Cluster validation</a></p>
<ul>
<li><p>validate_clusters</p></li>
<li><p>summary</p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#region-wise-stats">Region-wise stats</a></p>
<ul>
<li><p>rstats</p></li>
<li><p>rstats_summary</p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#other">Other</a></p>
<ul>
<li><p>nii_info
<br>
<br>
<br></p></li>
</ul>
</li>
</ul>
<section id="registration">
<h2>Registration<a class="headerlink" href="#registration" title="Link to this heading">#</a></h2>
<section id="metadata">
<h3><code class="docutils literal notranslate"><span class="pre">metadata</span></code><a class="headerlink" href="#metadata" title="Link to this heading">#</a></h3>
<p>Extract or specify metadata (outputs to ./sample??/parameters/metadata.txt). Add the resolutions to env_var.sh.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>metadata<span class="w"> </span>-i<span class="w"> </span>&lt;rel_path/full_res_img&gt;<span class="w">  </span><span class="c1"># Glob patterns work for -i</span>
metadata<span class="w"> </span>-i<span class="w"> </span>&lt;tif_dir&gt;<span class="w"> </span>-x<span class="w"> </span><span class="nv">$XY</span><span class="w"> </span>-z<span class="w"> </span><span class="nv">$Z</span><span class="w">  </span><span class="c1"># Specifying x and z voxel sizes in microns</span>
</pre></div>
</div>
<br>
</section>
<section id="prep-reg">
<h3><code class="docutils literal notranslate"><span class="pre">prep_reg</span></code><a class="headerlink" href="#prep-reg" title="Link to this heading">#</a></h3>
<p>Prepare autofluo images for registration (resample to a lower resolution)</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>prep_reg<span class="w"> </span>-i<span class="w"> </span>*.czi<span class="w"> </span>-x<span class="w"> </span><span class="nv">$XY</span><span class="w"> </span>-z<span class="w"> </span><span class="nv">$Z</span><span class="w"> </span>-v<span class="w">  </span><span class="c1"># -i options: tif_dir, .h5, .zarr, .tif</span>
</pre></div>
</div>
<br>
</section>
<section id="copy-tifs">
<h3><code class="docutils literal notranslate"><span class="pre">copy_tifs</span></code><a class="headerlink" href="#copy-tifs" title="Link to this heading">#</a></h3>
<p>Copy resampled autofluo .tif files for segmenting the brain with ilastik</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>copy_tifs<span class="w"> </span>-i<span class="w"> </span>reg_inputs/autofl_??um_tifs<span class="w"> </span>-s<span class="w"> </span><span class="m">0000</span><span class="w"> </span><span class="m">0005</span><span class="w"> </span><span class="m">0050</span><span class="w"> </span>-o<span class="w"> </span><span class="k">$(</span>dirname<span class="w"> </span><span class="nv">$BRAIN_MASK_ILP</span><span class="k">)</span><span class="w"> </span>-e<span class="w"> </span><span class="nv">$DIRS</span>
</pre></div>
</div>
<br>
</section>
<section id="brain-mask">
<h3><code class="docutils literal notranslate"><span class="pre">brain_mask</span></code><a class="headerlink" href="#brain-mask" title="Link to this heading">#</a></h3>
<p>Makes reg_inputs/autofl_??um_brain_mask.nii.gz and reg_inputs/autofl_??um_masked.nii.gz</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>brain_mask<span class="w"> </span>-ilp<span class="w"> </span><span class="nv">$BRAIN_MASK_ILP</span><span class="w"> </span>-v<span class="w"> </span>-e<span class="w"> </span><span class="nv">$DIRS</span>
</pre></div>
</div>
<br>
</section>
<section id="reg">
<h3><code class="docutils literal notranslate"><span class="pre">reg</span></code><a class="headerlink" href="#reg" title="Link to this heading">#</a></h3>
<p>Register average template brain/atlas to resampled autofl brain.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>reg<span class="w"> </span>-m<span class="w"> </span><span class="nv">$TEMPLATE</span><span class="w"> </span>-bc<span class="w"> </span>-pad<span class="w"> </span>-sm<span class="w"> </span><span class="m">0</span>.4<span class="w"> </span>-ort<span class="w"> </span>RPS<span class="w"> </span>-a<span class="w"> </span><span class="nv">$ATLAS</span><span class="w"> </span>-v<span class="w"> </span>-e<span class="w"> </span><span class="nv">$DIRS</span><span class="w">  </span><span class="c1"># If all samples have the same RPS+ orientation</span>

<span class="c1"># If orientations vary, make a ./sample??/parameters/ort.txt with the 3 letter orientation for each sample and run</span>
<span class="k">for</span><span class="w"> </span>d<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nv">$DIRS</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span><span class="nv">$d</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>s<span class="w"> </span><span class="k">in</span><span class="w"> </span>sample??<span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span>reg<span class="w"> </span>-m<span class="w"> </span><span class="nv">$TEMPLATE</span><span class="w"> </span>-bc<span class="w"> </span>-pad<span class="w"> </span>-sm<span class="w"> </span><span class="m">0</span>.4<span class="w"> </span>-ort<span class="w"> </span><span class="k">$(</span>cat<span class="w"> </span><span class="nv">$s</span>/parameters/ort.txt<span class="k">)</span><span class="w"> </span>-a<span class="w"> </span><span class="nv">$ATLAS</span><span class="w"> </span>-v<span class="w"> </span>-d<span class="w"> </span><span class="nv">$PWD</span>/<span class="nv">$s</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">done</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">done</span><span class="w"> </span>
</pre></div>
</div>
<br>
</section>
<section id="check-reg">
<h3><code class="docutils literal notranslate"><span class="pre">check_reg</span></code><a class="headerlink" href="#check-reg" title="Link to this heading">#</a></h3>
<p>Check the registration of images by copying the following to a common location:</p>
<ul class="simple">
<li><p>sample??/reg_outputs/autofl_??um_masked_fixed_reg_input.nii.gz</p></li>
<li><p>sample??/reg_outputs/atlas_in_tissue_space.nii.gz</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>check_reg<span class="w"> </span>-e<span class="w"> </span><span class="nv">$DIRS</span><span class="w"> </span>-td<span class="w"> </span><span class="nv">$BASE</span>/reg_results
</pre></div>
</div>
<ul class="simple">
<li><p>View these images with <a class="reference external" href="https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/FSLeyes">FSLeyes</a></p></li>
<li><p>Allen brain atlas coloring:</p>
<ul>
<li><p>Replace this /home/user/.config/fsleyes/luts/random.lut (location on Linux) with UNRAVEL/_other/fsleyes_luts/random.lut</p></li>
<li><p>Select the atlas and change “3D/4D volume” to “Label image”</p></li>
</ul>
</li>
</ul>
<br>
<br>
<br>
</section>
</section>
<section id="segmentation">
<h2>Segmentation<a class="headerlink" href="#segmentation" title="Link to this heading">#</a></h2>
<section id="id1">
<h3><code class="docutils literal notranslate"><span class="pre">copy_tifs</span></code><a class="headerlink" href="#id1" title="Link to this heading">#</a></h3>
<p>Copy full res tif files to a common location for training Ilastik to segment labels of interest (e.g., 3 tifs from each sample or 3 tifs from 3 samples / condition)</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>copy_tifs<span class="w"> </span>-i<span class="w"> </span>&lt;raw_tif_dir&gt;<span class="w"> </span>-s<span class="w"> </span><span class="m">0100</span><span class="w"> </span><span class="m">0500</span><span class="w"> </span><span class="m">1000</span><span class="w"> </span>-o<span class="w"> </span>ilastik_segmentation<span class="w"> </span>-e<span class="w"> </span><span class="nv">$DIRS</span><span class="w"> </span>-v
</pre></div>
</div>
<br>
</section>
<section id="seg">
<h3><code class="docutils literal notranslate"><span class="pre">seg</span></code><a class="headerlink" href="#seg" title="Link to this heading">#</a></h3>
<p>Perform pixel classification using Ilastik.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>seg<span class="w"> </span>-i<span class="w"> </span>&lt;*.czi,<span class="w"> </span>*.h5,<span class="w"> </span>or<span class="w"> </span>dir<span class="w"> </span>w/<span class="w"> </span>tifs&gt;<span class="w"> </span>-o<span class="w"> </span>seg_dir<span class="w"> </span>-ilp<span class="w"> </span><span class="nv">$BASE</span>/ilastik_segmentation/trained_ilastik_project.ilp<span class="w"> </span>-l<span class="w"> </span><span class="m">1</span><span class="w"> </span>-v<span class="w"> </span>-e<span class="w"> </span><span class="nv">$DIRS</span><span class="w"> </span>
<span class="c1"># Make binary segmentation for multiple labels like: -l 1 2</span>
</pre></div>
</div>
<br>
<br>
<br>
</section>
</section>
<section id="voxel-wise-stats">
<h2>Voxel-wise stats<a class="headerlink" href="#voxel-wise-stats" title="Link to this heading">#</a></h2>
<section id="prep-vstats">
<h3><code class="docutils literal notranslate"><span class="pre">prep_vstats</span></code><a class="headerlink" href="#prep-vstats" title="Link to this heading">#</a></h3>
<p>Preprocess immunofluo images and warp them to atlas space for voxel-wise statistics.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>prep_vstats<span class="w"> </span>-i<span class="w"> </span>cFos<span class="w"> </span>-rb<span class="w"> </span><span class="m">4</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">$XY</span><span class="w"> </span>-z<span class="w"> </span><span class="nv">$Z</span><span class="w"> </span>-o<span class="w"> </span>cFos_rb4_atlas_space.nii.gz<span class="w"> </span>-v<span class="w"> </span>-e<span class="w"> </span><span class="nv">$DIRS</span>
<span class="c1"># Use -s 3 for 3x3x3 spatial averaging if images are noisey</span>
<span class="c1"># Use a larger rolling ball radius if you want to preserve more diffuse signal (e.g., 20)</span>
</pre></div>
</div>
<br>
</section>
<section id="z-score">
<h3><code class="docutils literal notranslate"><span class="pre">z_score</span></code><a class="headerlink" href="#z-score" title="Link to this heading">#</a></h3>
<p>Z-score atlas space images using tissue masks (from brain_mask) and/or an atlas mask.</p>
<ul class="simple">
<li><p>atlas_space is a folder in ./sample??/</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>z-score<span class="w"> </span>-i<span class="w"> </span>atlas_space/sample??_cFos_rb4_atlas_space.nii.gz<span class="w"> </span>-v<span class="w"> </span>-e<span class="w"> </span><span class="nv">$DIRS</span>
</pre></div>
</div>
<br>
</section>
<section id="agg-files-from-dirs">
<h3><code class="docutils literal notranslate"><span class="pre">agg_files_from_dirs</span></code><a class="headerlink" href="#agg-files-from-dirs" title="Link to this heading">#</a></h3>
<p>Aggregate images for voxel-wise stats</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>agg_files_from_dirs<span class="w"> </span>-i<span class="w"> </span>atlas_space/sample??_cFos_rb4_atlas_space_z.nii.gz<span class="w"> </span>-e<span class="w"> </span><span class="nv">$DIRS</span><span class="w"> </span>-v
</pre></div>
</div>
<br>
</section>
<section id="whole-to-avg">
<h3><code class="docutils literal notranslate"><span class="pre">whole_to_avg</span></code><a class="headerlink" href="#whole-to-avg" title="Link to this heading">#</a></h3>
<p>Smooth and average left and right hemispheres together</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run this in the folder with all of the .nii.gz images</span>
whole_to_LR_avg<span class="w"> </span>-k<span class="w"> </span><span class="m">0</span>.1<span class="w"> </span>-tp<span class="w"> </span>-v<span class="w"> </span><span class="c1"># A 0.05 mm - 0.1 mm kernel radius is recommended for smoothing</span>
</pre></div>
</div>
<br>
</section>
<section id="prepend-conditions">
<h3><code class="docutils literal notranslate"><span class="pre">prepend_conditions</span></code><a class="headerlink" href="#prepend-conditions" title="Link to this heading">#</a></h3>
<p>Prepend conditions to filenames based on a CSV w/ this organization</p>
<ul class="simple">
<li><p>dir_name,condition</p></li>
<li><p>sample01,control</p></li>
<li><p>sample02,treatment</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>prepend_conditions<span class="w"> </span>-sk<span class="w"> </span><span class="nv">$SAMPLE_KEY</span><span class="w"> </span>-f
</pre></div>
</div>
<br>
</section>
<section id="vstats">
<h3><code class="docutils literal notranslate"><span class="pre">vstats</span></code><a class="headerlink" href="#vstats" title="Link to this heading">#</a></h3>
<p>Run voxel-wise stats using FSL’s randomise_parallel command.</p>
<ul class="simple">
<li><p>Outputs in ./stats/</p>
<ul>
<li><p>vox_p maps are uncorrected 1 - p value maps</p></li>
<li><p>tstat1: group1 &gt; group2</p></li>
<li><p>tstat2: group2 &gt; group1</p></li>
<li><p>fstat*: f contrast w/ ANOVA design (non-directional p value map)</p></li>
</ul>
</li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>vstats<span class="w"> </span>-mas<span class="w"> </span>mask.nii.gz<span class="w"> </span>-v
</pre></div>
</div>
<br>
<br>
<br>
</section>
</section>
<section id="cluster-correction">
<h2>Cluster correction<a class="headerlink" href="#cluster-correction" title="Link to this heading">#</a></h2>
<p>These commands are useful for multiple comparison correction of 1 - p value maps to define clusters of significant voxels.</p>
<section id="avg">
<h3><code class="docutils literal notranslate"><span class="pre">avg</span></code><a class="headerlink" href="#avg" title="Link to this heading">#</a></h3>
<p>Average *.nii.gz images</p>
<ul class="simple">
<li><p>Visualize absolute and relative differences in intensity</p></li>
<li><p>Use averages from each group to convert non-directioanl 1 - p value maps into directional cluster indices</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>avg<span class="w"> </span>-i<span class="w"> </span>*.nii.gz<span class="w"> </span><span class="c1"># outputs avg.nii.gz (process one group at a time or separate into folders)</span>
</pre></div>
</div>
<br>
</section>
<section id="fdr-range">
<h3><code class="docutils literal notranslate"><span class="pre">fdr_range</span></code><a class="headerlink" href="#fdr-range" title="Link to this heading">#</a></h3>
<p>Outputs a list of FDR q values that yeild clusters.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Basic usage</span>
fdr_range<span class="w"> </span>-i<span class="w"> </span>vox_p_tstat1.nii.gz<span class="w"> </span>-mas<span class="w"> </span>mask.nii.gz

<span class="c1"># Perform FDR correction on multiple directional 1 - p value maps</span>
<span class="k">for</span><span class="w"> </span>j<span class="w"> </span><span class="k">in</span><span class="w"> </span>*_vox_p_*.nii.gz<span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="nv">q_values</span><span class="o">=</span><span class="k">$(</span>fdr_range<span class="w"> </span>-mas<span class="w"> </span><span class="nv">$MASK</span><span class="w"> </span>-i<span class="w"> </span><span class="nv">$j</span><span class="k">)</span><span class="w"> </span><span class="p">;</span><span class="w"> </span>fdr_<span class="w"> </span>-mas<span class="w"> </span><span class="nv">$MASK</span><span class="w"> </span>-i<span class="w"> </span><span class="nv">$j</span><span class="w"> </span>-q<span class="w"> </span><span class="nv">$q_values</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">done</span>

<span class="c1"># Convert a non-directioanl 1 - p value map into a directional cluster index</span>
<span class="nv">q_values</span><span class="o">=</span><span class="k">$(</span>fdr_range<span class="w"> </span>-i<span class="w"> </span>vox_p_fstat1.nii.gz<span class="w"> </span>-mas<span class="w"> </span><span class="nv">$MASK</span><span class="k">)</span><span class="w"> </span><span class="p">;</span><span class="w"> </span>fdr_<span class="w"> </span>-i<span class="w"> </span>vox_p_fstat1.nii.gz<span class="w"> </span>-mas<span class="w"> </span><span class="nv">$MASK</span><span class="w"> </span>-o<span class="w"> </span>fstat1<span class="w"> </span>-v<span class="w"> </span>-a1<span class="w"> </span>Control_avg.nii.gz<span class="w"> </span>-a2<span class="w"> </span>Deep_avg.nii.gz<span class="w"> </span>-q<span class="w"> </span><span class="nv">$q_values</span>
</pre></div>
</div>
<br>
</section>
<section id="fdr">
<h3><code class="docutils literal notranslate"><span class="pre">fdr_</span></code><a class="headerlink" href="#fdr" title="Link to this heading">#</a></h3>
<p>Perform FDR correction on a 1 - p value map to define clusters</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>fdr_<span class="w"> </span>-i<span class="w"> </span>vox_p_tstat1.nii.gz<span class="w"> </span>-mas<span class="w"> </span>mask.nii.gz<span class="w"> </span>-q<span class="w"> </span><span class="m">0</span>.05
</pre></div>
</div>
<br>
</section>
<section id="recursive-mirror-index">
<h3><code class="docutils literal notranslate"><span class="pre">recursive_mirror_index</span></code><a class="headerlink" href="#recursive-mirror-index" title="Link to this heading">#</a></h3>
<p>Recursively flip the content of rev_cluster_index.nii.gz images</p>
<ul class="simple">
<li><p>Run this in the ./stats/ folder to process all subdirs with reverse cluster maps (cluster IDs go from large to small)</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use -m RH if a right hemisphere mask was used (otherwise use -m LH)</span>
recursive_mirror_index<span class="w"> </span>-m<span class="w"> </span>RH<span class="w"> </span>-v
</pre></div>
</div>
<br>
<br>
<br>
</section>
</section>
<section id="cluster-validation">
<h2>Cluster validation<a class="headerlink" href="#cluster-validation" title="Link to this heading">#</a></h2>
<section id="validate-clusters">
<h3><code class="docutils literal notranslate"><span class="pre">validate_clusters</span></code><a class="headerlink" href="#validate-clusters" title="Link to this heading">#</a></h3>
<p>Warps cluster index from atlas space to tissue space, crops clusters, applies segmentation mask, and quantifies cell/label densities</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Basic usage:</span>
validate_clusters<span class="w"> </span>-e<span class="w"> </span>&lt;experiment<span class="w"> </span>paths&gt;<span class="w"> </span>-m<span class="w"> </span>&lt;path/rev_cluster_index_to_warp_from_atlas_space.nii.gz&gt;<span class="w"> </span>-s<span class="w"> </span>seg_dir<span class="w"> </span>-v

<span class="c1"># Processing multiple FDR q value thresholds and both hemispheres:</span>
<span class="k">for</span><span class="w"> </span>q<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.005<span class="w"> </span><span class="m">0</span>.01<span class="w"> </span><span class="m">0</span>.05<span class="w"> </span><span class="m">0</span>.1<span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>side<span class="w"> </span><span class="k">in</span><span class="w"> </span>LH<span class="w"> </span>RH<span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span>validate_clusters<span class="w"> </span>-e<span class="w"> </span><span class="nv">$DIRS</span><span class="w"> </span>-m<span class="w"> </span>path/vstats/contrast/stats/contrast_vox_p_tstat1_q<span class="si">${</span><span class="nv">q</span><span class="si">}</span>/contrast_vox_p_tstat1_q<span class="si">${</span><span class="nv">q</span><span class="si">}</span>_rev_cluster_index_<span class="si">${</span><span class="nv">side</span><span class="si">}</span>.nii.gz<span class="w"> </span>-s<span class="w"> </span>seg_dir/sample??_seg_dir_1.nii.gz<span class="w"> </span>-v<span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">done</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">done</span>
</pre></div>
</div>
<br>
</section>
<section id="summary">
<h3><code class="docutils literal notranslate"><span class="pre">summary</span></code><a class="headerlink" href="#summary" title="Link to this heading">#</a></h3>
<p>Aggregates and analyzes cluster validation data from validate_clusters</p>
<ul class="simple">
<li><p>Update parameters in /UNRAVEL/unravel/cluster_stats/valid_clusters_summary.ini and save it with the experiment</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>summary<span class="w"> </span>-c<span class="w"> </span>path/valid_clusters_summary.ini<span class="w"> </span>-e<span class="w"> </span><span class="nv">$DIRS</span><span class="w"> </span>-cvd<span class="w"> </span><span class="s1">&#39;*&#39;</span><span class="w"> </span>-vd<span class="w"> </span>path/vstats_dir<span class="w"> </span>-sk<span class="w"> </span><span class="nv">$SAMPLE_KEY</span><span class="w"> </span>--groups<span class="w"> </span>group1<span class="w"> </span>group2<span class="w"> </span>-v
</pre></div>
</div>
<p>group1 and group2 must match conditions in the sample_key.csv
<br>
<br>
<br></p>
</section>
</section>
<section id="region-wise-stats">
<h2>Region-wise stats<a class="headerlink" href="#region-wise-stats" title="Link to this heading">#</a></h2>
<section id="rstats">
<h3><code class="docutils literal notranslate"><span class="pre">rstats</span></code><a class="headerlink" href="#rstats" title="Link to this heading">#</a></h3>
<p>Perform regional cell counting (label density measurements needs to be added)</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use if atlas is already in native space from to_native.py</span>
rstats<span class="w"> </span>-s<span class="w"> </span>rel_path/segmentation_image.nii.gz<span class="w"> </span>-a<span class="w"> </span>rel_path/native_atlas_split.nii.gz<span class="w"> </span>-c<span class="w"> </span>Saline<span class="w"> </span>--dirs<span class="w"> </span>sample14<span class="w"> </span>sample36

<span class="c1"># Use if native atlas is not available; it is not saved (faster)</span>
rstats<span class="w"> </span>-s<span class="w"> </span>rel_path/segmentation_image.nii.gz<span class="w"> </span>-m<span class="w"> </span>path/atlas_split.nii.gz<span class="w"> </span>-c<span class="w"> </span>Saline<span class="w"> </span>--dirs<span class="w"> </span>sample14<span class="w"> </span>sample36
</pre></div>
</div>
<br>
</section>
<section id="rstats-summary">
<h3><code class="docutils literal notranslate"><span class="pre">rstats_summary</span></code><a class="headerlink" href="#rstats-summary" title="Link to this heading">#</a></h3>
<p>Plot cell densities for each region and summarize results.</p>
<ul class="simple">
<li><p>CSV columns:</p>
<ul>
<li><p>Region_ID,Side,Name,Abbr,Saline_sample06,Saline_sample07,…,MDMA_sample01,…,Meth_sample23,…</p></li>
</ul>
</li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>rstats_summary<span class="w"> </span>--groups<span class="w"> </span>Saline<span class="w"> </span>MDMA<span class="w"> </span>Meth<span class="w"> </span>-d<span class="w"> </span><span class="m">10000</span><span class="w"> </span>-hemi<span class="w"> </span>r
</pre></div>
</div>
<br>
<br>
<br>
</section>
</section>
<section id="other">
<h2>Other<a class="headerlink" href="#other" title="Link to this heading">#</a></h2>
<section id="nii-info">
<h3><code class="docutils literal notranslate"><span class="pre">nii_info</span></code><a class="headerlink" href="#nii-info" title="Link to this heading">#</a></h3>
<p>Display information about a NIfTI image.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>nii_info<span class="w"> </span>-i<span class="w"> </span>image.nii.gz
</pre></div>
</div>
<br>
</section>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="guide.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Guide</p>
      </div>
    </a>
    <a class="right-next"
       href="modules.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">unravel</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#registration">Registration</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#metadata"><code class="docutils literal notranslate"><span class="pre">metadata</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#prep-reg"><code class="docutils literal notranslate"><span class="pre">prep_reg</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#copy-tifs"><code class="docutils literal notranslate"><span class="pre">copy_tifs</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#brain-mask"><code class="docutils literal notranslate"><span class="pre">brain_mask</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reg"><code class="docutils literal notranslate"><span class="pre">reg</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#check-reg"><code class="docutils literal notranslate"><span class="pre">check_reg</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#segmentation">Segmentation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1"><code class="docutils literal notranslate"><span class="pre">copy_tifs</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#seg"><code class="docutils literal notranslate"><span class="pre">seg</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#voxel-wise-stats">Voxel-wise stats</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#prep-vstats"><code class="docutils literal notranslate"><span class="pre">prep_vstats</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#z-score"><code class="docutils literal notranslate"><span class="pre">z_score</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#agg-files-from-dirs"><code class="docutils literal notranslate"><span class="pre">agg_files_from_dirs</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#whole-to-avg"><code class="docutils literal notranslate"><span class="pre">whole_to_avg</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#prepend-conditions"><code class="docutils literal notranslate"><span class="pre">prepend_conditions</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#vstats"><code class="docutils literal notranslate"><span class="pre">vstats</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cluster-correction">Cluster correction</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#avg"><code class="docutils literal notranslate"><span class="pre">avg</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fdr-range"><code class="docutils literal notranslate"><span class="pre">fdr_range</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fdr"><code class="docutils literal notranslate"><span class="pre">fdr_</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#recursive-mirror-index"><code class="docutils literal notranslate"><span class="pre">recursive_mirror_index</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cluster-validation">Cluster validation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#validate-clusters"><code class="docutils literal notranslate"><span class="pre">validate_clusters</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#summary"><code class="docutils literal notranslate"><span class="pre">summary</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#region-wise-stats">Region-wise stats</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#rstats"><code class="docutils literal notranslate"><span class="pre">rstats</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#rstats-summary"><code class="docutils literal notranslate"><span class="pre">rstats_summary</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#other">Other</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#nii-info"><code class="docutils literal notranslate"><span class="pre">nii_info</span></code></a></li>
</ul>
</li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  <div class="tocsection sourcelink">
    <a href="_sources/commands.md.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2024, Daniel Ryskamp Rijsketic, Austen Casey, Boris Heifets.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.3.7.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.3.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>