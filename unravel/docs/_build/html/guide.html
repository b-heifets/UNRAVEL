
<!DOCTYPE html>


<html lang="en" data-content_root="./" data-theme="dark">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Guide &#8212; UNRAVEL docs</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "dark";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "dark";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=87e54e7c" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css?v=872d93e8" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=3ee479438cf8b5e0d341"></script>

    <script src="_static/documentation_options.js?v=8d563738"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="https://unpkg.com/mermaid@10.2.0/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true});</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'guide';</script>
    <link rel="icon" href="_static/favicon.png"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="unravel package" href="unravel/toc.html" />
    <link rel="prev" title="Installation" href="installation.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="dark">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
  
    <p class="title logo__title">UNRAVEL docs</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item pst-header-nav-item">
  <a class="nav-link nav-internal" href="installation.html">
    Installation
  </a>
</li>


<li class="nav-item pst-header-nav-item current active">
  <a class="nav-link nav-internal" href="#">
    Guide
  </a>
</li>


<li class="nav-item pst-header-nav-item">
  <a class="nav-link nav-internal" href="unravel/toc.html">
    unravel package
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/b-heifets/UNRAVEL" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fab fa-github-square fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
    <button class="sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item pst-header-nav-item">
  <a class="nav-link nav-internal" href="installation.html">
    Installation
  </a>
</li>


<li class="nav-item pst-header-nav-item current active">
  <a class="nav-link nav-internal" href="#">
    Guide
  </a>
</li>


<li class="nav-item pst-header-nav-item">
  <a class="nav-link nav-internal" href="unravel/toc.html">
    unravel package
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/b-heifets/UNRAVEL" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fab fa-github-square fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"></div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">Guide</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="guide">
<h1>Guide<a class="headerlink" href="#guide" title="Link to this heading">#</a></h1>
<ul class="simple">
<li><p>This guide focuses on our most common workflow (IF/iDISCO –&gt; LSFM –&gt; atlas registration –&gt; voxel-wise stats –&gt; cluster validation).</p></li>
<li><p>These <a class="reference external" href="https://drive.google.com/drive/folders/1y5G0A1vnQhfM41FlJyMnOf7KIDZ7o3sD?usp=sharing">video tutorials</a> cover roughly similar content, but please refer to this guide and command help guides for additional info.</p></li>
<li><p>For getting started, test commands using these downsampled images from an <a class="reference external" href="https://drive.google.com/drive/folders/1bKgN9UWaBq5b4LrafzgDD3XyiYZk8k9R?usp=sharing">example mouse</a>.</p>
<ul>
<li><p>For instructions, see this <a class="reference external" href="https://docs.google.com/document/d/103njLFFiqHuf4flz3OlyHnf_Rauqj5gG_Ztfjk3y8NU/edit?usp=sharing">UNRAVEL_commands.txt</a></p></li>
</ul>
</li>
</ul>
<hr class="docutils" />
<br>
<ul class="simple">
<li><p>If you are unfamiliar with the terminal, start here:</p>
<ul>
<li><p><a class="reference external" href="https://www.youtube.com/watch?v=rrB13utjYV4">Linux in 100 seconds</a></p></li>
<li><p><a class="reference external" href="https://www.youtube.com/watch?v=I4EWvMFj37g">Bash in 100 seconds</a></p></li>
<li><p><a class="reference external" href="https://linuxsurvival.com/">Interactive Linux Survival guide</a></p></li>
<li><p>Refer to common commands and tips in this cheat sheet (click to expand dropdown):</p></li>
</ul>
</li>
</ul>
<div class="hint dropdown admonition">
<p class="admonition-title">Terminal command cheat sheet</p>
<h3 class="rubric" id="working-directory">Working Directory</h3>
<p>The working directory, or current directory, is the folder in the file system that a user or program is currently accessing.</p>
<ul class="simple">
<li><p><strong>Default Location</strong>: The terminal typically starts in your home directory.</p></li>
<li><p><strong>Relative Paths</strong>: Commands use paths relative to the working directory.</p></li>
<li><p><strong>Changing Directories</strong>: Use <code class="docutils literal notranslate"><span class="pre">cd</span> <span class="pre">/path/to/directory</span></code> to change the working directory.</p></li>
<li><p><strong>Viewing the Directory</strong>: Use <code class="docutils literal notranslate"><span class="pre">pwd</span></code> to display the current working directory.</p></li>
<li><p><strong>Importance</strong>: Knowing your working directory is often crucial for executing commands and managing files as intended.</p></li>
</ul>
<h3 class="rubric" id="stopping-commands">Stopping Commands</h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Ctrl</span> <span class="pre">+</span> <span class="pre">C</span></code>: Interrupt the command</p></li>
</ul>
<h3 class="rubric" id="learning-about-commands">Learning About Commands</h3>
<ul class="simple">
<li><p><strong>Help Option</strong>: Many commands offer a <code class="docutils literal notranslate"><span class="pre">--help</span></code> option to provide a quick overview of usage. For example, <code class="docutils literal notranslate"><span class="pre">ls</span> <span class="pre">--help</span></code> or <code class="docutils literal notranslate"><span class="pre">ls</span> <span class="pre">-h</span></code>.</p></li>
<li><p><strong>Manual Pages</strong>: Use <code class="docutils literal notranslate"><span class="pre">man</span> <span class="pre">&lt;command&gt;</span></code> to access the manual page for detailed information about a command. For example, <code class="docutils literal notranslate"><span class="pre">man</span> <span class="pre">ls</span></code> provides options and descriptions for the <code class="docutils literal notranslate"><span class="pre">ls</span></code> command.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">which</span></code></strong>: Use <code class="docutils literal notranslate"><span class="pre">which</span> <span class="pre">&lt;command&gt;</span></code> to locate the executable file for a command. For example, <code class="docutils literal notranslate"><span class="pre">which</span> <span class="pre">python</span></code> shows where the Python interpreter is installed.</p></li>
</ul>
<h3 class="rubric" id="listing-files">Listing Files</h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ls</span></code>: List files and directories.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ls</span> <span class="pre">-l</span></code>: List files in long format, including details like permissions, size, and modification date.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ls</span> <span class="pre">-a</span></code>: List all files, including hidden files, which start with a “.” (unravel commands are logged in a hidden file [.command_log.txt]).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ls</span> <span class="pre">-1</span></code>: List files in a single column.</p></li>
</ul>
<h3 class="rubric" id="viewing-and-creating-files">Viewing and Creating Files</h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">cat</span> <span class="pre">&lt;filename&gt;</span></code>: Display the contents of a file.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">echo</span> <span class="pre">&quot;string&quot;</span> <span class="pre">&gt;</span> <span class="pre">new.txt</span></code>: Create a new file named <code class="docutils literal notranslate"><span class="pre">new.txt</span></code> and write “string” to it.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">echo</span> <span class="pre">&quot;string&quot;</span> <span class="pre">&gt;&gt;</span> <span class="pre">new.txt</span></code>: Append “string” to the existing <code class="docutils literal notranslate"><span class="pre">new.txt</span></code> file.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">touch</span> <span class="pre">new.txt</span></code>: Create a new file that is empty</p></li>
</ul>
<h3 class="rubric" id="file-folder-management">File/Folder Management</h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">mkdir</span> <span class="pre">&lt;dir_name&gt;</span></code>: Make directory</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rm</span> <span class="pre">-rf</span> <span class="pre">&lt;dir_name&gt;</span></code>: Delete folder and all contents recursively (be careful where you run this and what patterns you use)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rm</span> <span class="pre">&lt;file&gt;</span></code> or <code class="docutils literal notranslate"><span class="pre">rm</span> <span class="pre">&lt;path/file&gt;</span></code></p></li>
</ul>
<h3 class="rubric" id="navigation-and-shortcuts">Navigation and Shortcuts</h3>
<ul class="simple">
<li><p><strong>Tab completion</strong>: Use tab to auto-complete file and directory names.</p></li>
<li><p><strong>Up arrow</strong>: Scroll through command history. In zsh, type a partial command and press the up arrow to find past commands starting with the typed string.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cd</span> <span class="pre">&lt;path&gt;</span></code>: Change the current directory to <code class="docutils literal notranslate"><span class="pre">&lt;path&gt;</span></code>. Drag/drop a file or folder into the terminal to paste the path to it. Or select the file/folder, hit Ctrl + C, select the terminal, and press Ctrl + Shift + V.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cd</span> <span class="pre">&lt;Tab&gt;</span></code> or <code class="docutils literal notranslate"><span class="pre">cd</span> <span class="pre">&lt;Tab</span> <span class="pre">Tab&gt;</span></code>: To see folders in the working dir that you can cd to (with zsh use Tab and Shift + Tab to cycle –&gt; enter or space)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cd</span> <span class="pre">..</span></code>: Move up one directory level.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cd</span> <span class="pre">../..</span></code>: Move up two directory levels.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cd</span> <span class="pre">../dir</span></code>: Move up one directory and then into <code class="docutils literal notranslate"><span class="pre">dir</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cd</span> <span class="pre">-</span></code>: Switch to the previous directory.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cd</span></code>: Change to the home directory.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cd</span> <span class="pre">~/</span></code>: Change to the home directory using the tilde shortcut.</p></li>
</ul>
<h3 class="rubric" id="command-history">Command History</h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">history</span></code>: Print the history of terminal commands</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">!3</span></code>: Run the third command in the history</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cat</span> <span class="pre">.command_log.txt</span></code>: Print the history of unravel commands</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cat</span> <span class="pre">.command_log.txt</span> <span class="pre">|</span> <span class="pre">tail</span> <span class="pre">-10</span></code>: Print the last 10 lines</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cat</span> <span class="pre">.command_log.txt</span> <span class="pre">|</span> <span class="pre">head</span> <span class="pre">-10</span></code>: Print the first 10 lines</p></li>
</ul>
<h3 class="rubric" id="keyboard-shortcuts">Keyboard Shortcuts</h3>
<ul class="simple">
<li><p><strong>Copy/Paste</strong>:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">Ctrl</span> <span class="pre">+</span> <span class="pre">Shift</span> <span class="pre">+</span> <span class="pre">C</span></code>: Copy text</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Ctrl</span> <span class="pre">+</span> <span class="pre">Shift</span> <span class="pre">+</span> <span class="pre">V</span></code>: Paste text.</p></li>
<li><p>Or select text and click the middle wheel on the mouse to copy and paste.</p></li>
</ul>
</li>
<li><p><strong>Movement</strong>:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">Ctrl</span> <span class="pre">+</span> <span class="pre">A</span></code>: Move to the beginning of the line.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Ctrl</span> <span class="pre">+</span> <span class="pre">E</span></code>: Move to the end of the line.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Ctrl</span> <span class="pre">+</span> <span class="pre">Arrow</span></code>: Move word by word.</p></li>
</ul>
</li>
<li><p><strong>Deleting</strong>:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">Ctrl</span> <span class="pre">+</span> <span class="pre">W</span></code>: Delete the word before the cursor (space-separated for bash, additional delimiters for zsh).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Ctrl</span> <span class="pre">+</span> <span class="pre">U</span></code>: Delete from the cursor to the beginning of the line.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Ctrl</span> <span class="pre">+</span> <span class="pre">K</span></code>: Delete from the cursor to the end of the line.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Ctrl</span> <span class="pre">+</span> <span class="pre">Y</span></code>: Paste the last killed text.</p></li>
</ul>
</li>
<li><p><strong>Find</strong>:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">Ctrl</span> <span class="pre">+</span> <span class="pre">Shift</span> <span class="pre">+</span> <span class="pre">F</span></code>: Open the search bar to find text.</p></li>
</ul>
</li>
</ul>
<h3 class="rubric" id="command-execution-and-scripting">Command Execution and Scripting</h3>
<ul class="simple">
<li><p>Using <code class="docutils literal notranslate"><span class="pre">;</span></code> vs. <code class="docutils literal notranslate"><span class="pre">&amp;</span></code>: <code class="docutils literal notranslate"><span class="pre">;</span></code> chains commands to execute sequentially, while <code class="docutils literal notranslate"><span class="pre">&amp;</span></code> runs a command in the background.</p></li>
<li><p>Another way to chain commands is to “pipe” (“|” character) the output from one command (what would be printed to the terminal) so it is used as the input of the next command</p>
<ul>
<li><p>For example, <code class="docutils literal notranslate"><span class="pre">cat</span> <span class="pre">&lt;filename&gt;</span> <span class="pre">|</span> <span class="pre">wc</span> <span class="pre">-l</span></code>: Cat would print the contents of <filename>, but here this is used as the input for wc, which counts the number of lines (e.g., rows in a csv)</p></li>
</ul>
</li>
<li><p>Parentheses <code class="docutils literal notranslate"><span class="pre">()</span></code> for multi-line commands: Group commands to execute them in a subshell.</p></li>
</ul>
<h3 class="rubric" id="global-variables">Global Variables</h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">$PWD</span></code>: Variable with the current working directory path.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">$PATH</span></code>: List of directories that have executable files. Allows for executing scripts without providing the full path (e.g., path/script.py –&gt; script.py). Folders with UNRAVEL scripts don’t need to be added to the $PATH if it installed w/ <code class="docutils literal notranslate"><span class="pre">pip</span></code>.</p></li>
<li><p>See this <strong><a class="reference external" href="https://b-heifets.github.io/UNRAVEL/guide.html#defining-common-variables-for-command-arguments">guide</a></strong> to define common command arguments as global variables in env_var.sh (so they can be loaded in each terminal session)</p></li>
</ul>
<h3 class="rubric" id="batch-processing-via-loops">Batch Processing Via Loops</h3>
<ul class="simple">
<li><p>For loops examples:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">for</span> <span class="pre">d</span> <span class="pre">in</span> <span class="pre">dir*</span> <span class="pre">;</span> <span class="pre">do</span> <span class="pre">original_dir=$PWD</span> <span class="pre">;</span> <span class="pre">cd</span> <span class="pre">$d</span> <span class="pre">;</span> <span class="pre">pwd</span> <span class="pre">;</span> <span class="pre">cd</span> <span class="pre">$original_dir</span> <span class="pre">;</span> <span class="pre">done</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">for</span> <span class="pre">s</span> <span class="pre">in</span> <span class="pre">sample??</span> <span class="pre">;</span> <span class="pre">do</span> <span class="pre">cat</span> <span class="pre">$s/parameters/metadata.txt</span> <span class="pre">;</span> <span class="pre">done</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">for</span> <span class="pre">d</span> <span class="pre">in</span> <span class="pre">&lt;space</span> <span class="pre">separated</span> <span class="pre">list</span> <span class="pre">of</span> <span class="pre">experiment</span> <span class="pre">folder&gt;</span> <span class="pre">;</span> <span class="pre">do</span> <span class="pre">cd</span> <span class="pre">$d</span> <span class="pre">;</span> <span class="pre">for</span> <span class="pre">s</span> <span class="pre">in</span> <span class="pre">sample??</span> <span class="pre">;</span> <span class="pre">do</span> <span class="pre">echo</span> <span class="pre">$s</span> <span class="pre">;</span> <span class="pre">done</span> <span class="pre">;</span> <span class="pre">done</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">for</span> <span class="pre">i</span> <span class="pre">in</span> <span class="pre">1</span> <span class="pre">2</span> <span class="pre">3</span> <span class="pre">4;</span> <span class="pre">do</span> <span class="pre">echo</span> <span class="pre">$i</span> <span class="pre">;</span> <span class="pre">done</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">for</span> <span class="pre">i</span> <span class="pre">in</span> <span class="pre">{1..10};</span> <span class="pre">do</span> <span class="pre">echo</span> <span class="pre">$i</span> <span class="pre">;</span> <span class="pre">done</span></code></p></li>
<li><p>Parallel processing w/ &amp;: <code class="docutils literal notranslate"><span class="pre">for</span> <span class="pre">i</span> <span class="pre">in</span> <span class="pre">*.nii.gz</span> <span class="pre">;</span> <span class="pre">do</span> <span class="pre">fslmaths</span> <span class="pre">$i</span> <span class="pre">-bin</span> <span class="pre">${i::-7}_bin</span> <span class="pre">-odt</span> <span class="pre">char</span> <span class="pre">&amp;</span> <span class="pre">done</span>&#160; <span class="pre">#</span> <span class="pre">Binarizes</span> <span class="pre">all</span> <span class="pre">images,</span> <span class="pre">output</span> <span class="pre">data</span> <span class="pre">type</span> <span class="pre">8-bit,</span> <span class="pre">${i::-7}</span> <span class="pre">trims</span> <span class="pre">last</span> <span class="pre">7</span> <span class="pre">characters</span> <span class="pre">in</span> <span class="pre">bash</span> <span class="pre">(does</span> <span class="pre">not</span> <span class="pre">work</span> <span class="pre">in</span> <span class="pre">zsh)</span></code> (run <code class="docutils literal notranslate"><span class="pre">echo</span></code> to see when processes are done).</p></li>
</ul>
</li>
</ul>
<h3 class="rubric" id="variables-and-substitution">Variables and Substitution</h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">$PWD</span></code>: Variable with the current working directory path.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">$()</span></code>: Command substitution to capture output for use in commands (e.g., <code class="docutils literal notranslate"><span class="pre">x=$(for</span> <span class="pre">)</span></code>)</p></li>
</ul>
<h3 class="rubric" id="file-searching-and-manipulation">File Searching and Manipulation</h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">find</span></code>: Search for files in a directory hierarchy.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">find</span> <span class="pre">.</span> <span class="pre">-name</span> <span class="pre">&quot;*.txt&quot;</span></code>: Search for text files matching this pattern.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">find</span> <span class="pre">$PWD</span> <span class="pre">-name</span> <span class="pre">&quot;*.txt&quot;</span> <span class="pre">-exec</span> <span class="pre">rm</span> <span class="pre">{}</span> <span class="pre">\;</span></code>: Find all <code class="docutils literal notranslate"><span class="pre">.txt</span></code> files and delete them.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">grep</span></code>: Search text using patterns.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">grep</span> <span class="pre">-r</span> <span class="pre">&lt;string_in_files&gt;</span></code>: Recursively search for a pattern</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">grep</span> <span class="pre">-r</span> <span class="pre">--exclude-dir=docs</span> <span class="pre">&lt;pattern&gt;</span></code>: Search for a pattern while excluding specific directories.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">grep</span> <span class="pre">-r</span> <span class="pre">&lt;pattern1&gt;</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">&lt;pattern2&gt;</span></code>: Search for a pattern filter to preserve lines with a second string</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">grep</span> <span class="pre">-r</span> <span class="pre">&lt;pattern1&gt;</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">-v</span> <span class="pre">&lt;pattern2&gt;</span></code>: Search for a pattern filter to exlude lines with a second string</p></li>
</ul>
</li>
<li><p><a class="reference external" href="https://github.com/junegunn/fzf"><code class="docutils literal notranslate"><span class="pre">fzf</span></code></a>: A command-line fuzzy finder that allows you to search and filter items interactively, providing a fast and efficient way to locate files, commands, or history entries.</p></li>
</ul>
<h3 class="rubric" id="text-processing">Text Processing</h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">sed</span></code>: Stream editor for filtering and transforming text.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">sed</span> <span class="pre">'s/old/new/g'</span> <span class="pre">file</span></code>: Replace all occurrences of <code class="docutils literal notranslate"><span class="pre">old</span></code> with <code class="docutils literal notranslate"><span class="pre">new</span></code> in <code class="docutils literal notranslate"><span class="pre">file</span></code> (use *.txt for multiple files)</p></li>
</ul>
</li>
</ul>
<h3 class="rubric" id="aliases">Aliases</h3>
<p>Aliases are shortcuts for longer commands or sequences of commands, making it easier and quicker to execute frequently used commands. You can create aliases in your shell configuration file (like <code class="docutils literal notranslate"><span class="pre">.bashrc</span></code> for Bash or <code class="docutils literal notranslate"><span class="pre">.zshrc</span></code> for Zsh).</p>
<h4 class="rubric" id="how-to-create-aliases">How to Create Aliases:</h4>
<ul>
<li><p>Open your shell configuration file (.bashrc or .zshrc) with <strong><a class="reference external" href="https://code.visualstudio.com/download">VS Code</a></strong> or <strong><a class="reference external" href="https://www.youtube.com/watch?v=DLeATFgGM-A">nano</a></strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># For example:</span>
nano<span class="w"> </span>~/.bashrc<span class="w">  </span><span class="c1"># For Bash users</span>
</pre></div>
</div>
</li>
<li><p>Add alias definitions in the format:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">alias</span><span class="w"> </span><span class="nv">shortname</span><span class="o">=</span><span class="s1">&#39;full command&#39;</span>
</pre></div>
</div>
<p>For example:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">alias</span><span class="w"> </span><span class="nv">ll</span><span class="o">=</span><span class="s1">&#39;ls -l&#39;</span>
<span class="nb">alias</span><span class="w"> </span><span class="nv">ilastik</span><span class="o">=</span><span class="s1">&#39;path/to/ilastik_executable&#39;</span><span class="w">  </span><span class="c1"># For launching Ilastik via the terminal by running: ilastik</span>
<span class="nb">alias</span><span class="w"> </span><span class="nv">i</span><span class="o">=</span><span class="s2">&quot;io_nii_info -i &quot;</span>
<span class="nb">alias</span><span class="w"> </span><span class="nv">gs</span><span class="o">=</span><span class="s1">&#39;git status&#39;</span>
</pre></div>
</div>
</li>
<li><p>Save the file and reload your configuration:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">source</span><span class="w"> </span>~/.bashrc<span class="w">  </span><span class="c1"># For Bash users</span>
</pre></div>
</div>
</li>
</ul>
<h3 class="rubric" id="fsl-commands-for-nifti-files-nii-gz-extension">FSL Commands for NIfTI files (.nii.gz extension)</h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">fslmaths</span></code>: Perform mathematical operations on images.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">add</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sub</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bin</span></code> (binarize)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">uthr</span></code> (Zero out intenisties above upper threshold)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">thr</span></code> (Zero out intenisties below  threshold)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mas</span></code> (mask).</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">-odt</span></code> at end to set output data type (char for 8-bit and short for unsigned 16-bit). Default is float 32-bit. Pay attention to the max range that each data type can represent (e.g., 255 for 8-bit and 65,535 for 16-bit).</p></li>
<li><p>“.nii.gz” is automatically added</p></li>
<li><p>Examples:</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fslmaths</span> <span class="pre">img_1</span> <span class="pre">-bin</span> <span class="pre">img_1_bin</span> <span class="pre">-odt</span> <span class="pre">char</span>&#160; <span class="pre">#</span> <span class="pre">char</span> <span class="pre">is</span> <span class="pre">for</span> <span class="pre">8-bit</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fslmaths</span> <span class="pre">img_2</span> <span class="pre">-mas</span> <span class="pre">img_1_bin</span> <span class="pre">-odt</span> <span class="pre">short</span>&#160; <span class="pre">#</span> <span class="pre">This</span> <span class="pre">used</span> <span class="pre">img_1_bin</span> <span class="pre">as</span> <span class="pre">a</span> <span class="pre">mask</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fslmaths</span> <span class="pre">img_1_bin</span> <span class="pre">-mul</span> <span class="pre">-1</span> <span class="pre">-add</span> <span class="pre">1</span> <span class="pre">img_1_bin_inv</span> <span class="pre">-odt</span> <span class="pre">char</span>&#160; <span class="pre">#</span> <span class="pre">This</span> <span class="pre">inverts</span> <span class="pre">a</span> <span class="pre">mask</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fslmaths</span> <span class="pre">img_1</span> <span class="pre">-sub</span> <span class="pre">img_2</span> <span class="pre">diff</span>&#160; <span class="pre">#</span> <span class="pre">Then</span> <span class="pre">check</span> <span class="pre">if</span> <span class="pre">the</span> <span class="pre">images</span> <span class="pre">are</span> <span class="pre">the</span> <span class="pre">same:</span> <span class="pre">fslstats</span> <span class="pre">diff</span> <span class="pre">-R</span> </code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fslmaths</span> <span class="pre">img_1</span> <span class="pre">-sub</span> <span class="pre">img_1</span> <span class="pre">blank</span>&#160; <span class="pre">#</span> <span class="pre">Make</span> <span class="pre">an</span> <span class="pre">empty</span> <span class="pre">image</span> <span class="pre">for</span> <span class="pre">adding</span> <span class="pre">masks</span> <span class="pre">of</span> <span class="pre">each</span> <span class="pre">region</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">for</span> <span class="pre">i</span> <span class="pre">in</span> <span class="pre">1</span> <span class="pre">56</span> <span class="pre">672</span> <span class="pre">;</span> <span class="pre">do</span> <span class="pre">fslmaths</span> <span class="pre">atlas</span> <span class="pre">-thr</span> <span class="pre">$i</span> <span class="pre">-uthr</span> <span class="pre">$i</span> <span class="pre">region_${i}</span> <span class="pre">-odt</span> <span class="pre">short</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">for</span> <span class="pre">i</span> <span class="pre">in</span> <span class="pre">region_mask*.nii.gz</span> <span class="pre">;</span> <span class="pre">do</span> <span class="pre">fslmaths</span> <span class="pre">blank</span> <span class="pre">-add</span> <span class="pre">$i</span> <span class="pre">blank</span> <span class="pre">;</span> <span class="pre">done</span> <span class="pre">;</span> <span class="pre">mv</span> <span class="pre">blank.nii.gz</span> <span class="pre">all_regions.nii.gz</span></code></p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">fslstats</span></code>: Compute statistics on images (-R, -V, -M)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fslroi</span></code>: Crop or expand images.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fslcpgeom</span></code>: Copy header info (e.g., resolution and position in global space for viewing) from one image to another.</p></li>
</ul>
<h3 class="rubric" id="killing-a-process">Killing a Process</h3>
<p>If <code class="docutils literal notranslate"><span class="pre">Ctrl</span> <span class="pre">+</span> <span class="pre">C</span></code> doesn’t stop the command, you can kill the process:</p>
<ul class="simple">
<li><p><strong>Find the Process ID (PID)</strong>:</p>
<ul>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">ps</span> <span class="pre">aux</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">&lt;process_name&gt;</span></code> to find the PID of the process. Replace <code class="docutils literal notranslate"><span class="pre">&lt;process_name&gt;</span></code> with the name of the command or process you want to stop.</p></li>
<li><p>Alternatively, use <code class="docutils literal notranslate"><span class="pre">pgrep</span> <span class="pre">&lt;process_name&gt;</span></code> to directly get the PID.</p></li>
</ul>
</li>
<li><p><strong>Kill the Process</strong>:</p>
<ul>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">kill</span> <span class="pre">&lt;PID&gt;</span></code> to send a termination signal to the process. Replace <code class="docutils literal notranslate"><span class="pre">&lt;PID&gt;</span></code> with the actual process ID.</p></li>
<li><p>If the process doesn’t stop, force it with <code class="docutils literal notranslate"><span class="pre">kill</span> <span class="pre">-9</span> <span class="pre">&lt;PID&gt;</span></code>.</p></li>
</ul>
</li>
</ul>
</div>
<hr class="docutils" />
<br>
<section id="command-help-guides">
<h2>Command Help Guides<a class="headerlink" href="#command-help-guides" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>For help on a command, run this in the terminal:</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&lt;command&gt;<span class="w"> </span>-h
</pre></div>
</div>
<ul class="simple">
<li><p>Help guides often include info on prereqs, inputs, outputs, next steps, usage, and other notes.</p></li>
<li><p>Viewing the terminal help provides default values and additional options not covered in this guide.</p></li>
<li><p>Provide -v when running commands for verbose mode (to see info about function calls, parameters, etc.)</p></li>
</ul>
<div class="hint dropdown admonition">
<p class="admonition-title">Syntax related to commands</p>
<ul class="simple">
<li><p>The symbols &lt; and &gt; indicate placeholders. Replace &lt;command&gt; with the actual command name you want to learn more about.</p></li>
<li><p>Square brackets [ ] in command syntax signify optional elements.</p></li>
<li><p>Double backticks are used in help guides to indicate a command. (e.g., ``command``)</p></li>
<li><p>Asterisks act as wildcards for matching patterns in strings</p></li>
<li><p>?? means two digits</p></li>
</ul>
</div>
<p>To view help on arguments for each command in the online documentation, go to the page for that module/script, scroll to the parse_args() function, and click the link for viewing the source code.</p>
<hr class="docutils" />
<br>
</section>
<section id="listing-commands">
<h2>Listing Commands<a class="headerlink" href="#listing-commands" title="Link to this heading">#</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># List common commands</span>
unravel_commands<span class="w"> </span>-c

<span class="c1"># List common commands, aliases, and descriptions:</span>
uc<span class="w"> </span>-cad

<span class="c1"># List all commands matching a string (e.g., vstats):</span>
uc<span class="w"> </span>-ad<span class="w"> </span>-f<span class="w"> </span>vstats<span class="w">  </span><span class="c1"># Find commands related to voxel-wise stats </span>

<span class="c1"># List all commands and the modules/scripts that they run:</span>
uc<span class="w"> </span>-m
</pre></div>
</div>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<ul class="simple">
<li><p><strong>Prefixes</strong> group together related commands. Use <strong>tab completion</strong> in the terminal to quickly view and access sets of commands within each group.</p></li>
</ul>
</div>
<hr class="docutils" />
<br>
</section>
<section id="common-commands">
<h2>Common Commands<a class="headerlink" href="#common-commands" title="Link to this heading">#</a></h2>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-0" name="sd-tab-set-0" type="radio">
<label class="sd-tab-label" for="sd-tab-item-0">
Registration</label><div class="sd-tab-content docutils">
<ul class="simple">
<li><p><a class="reference internal" href="unravel/register/reg_prep.html#unravel-register-reg-prep"><span class="std std-ref"><strong>reg_prep</strong></span></a>: Prepare registration (resample the autofluo image to lower res).</p></li>
<li><p><a class="reference internal" href="unravel/register/reg.html#unravel-register-reg"><span class="std std-ref"><strong>reg</strong></span></a>: Perform registration (e.g., register the autofluo image to an average template).</p></li>
<li><p><a class="reference internal" href="unravel/register/reg_check.html#unravel-register-reg-check"><span class="std std-ref"><strong>reg_check</strong></span></a>: Check registration (aggregate the autofluo and warped atlas images).</p></li>
</ul>
</div>
<input id="sd-tab-item-1" name="sd-tab-set-0" type="radio">
<label class="sd-tab-label" for="sd-tab-item-1">
Warping</label><div class="sd-tab-content docutils">
<ul class="simple">
<li><p><a class="reference internal" href="unravel/warp/to_atlas.html#unravel-warp-to-atlas"><span class="std std-ref"><strong>warp_to_atlas</strong></span></a>: Warp full res tissue space images to atlas space.</p></li>
<li><p><a class="reference internal" href="unravel/warp/to_native.html#unravel-warp-to-native"><span class="std std-ref"><strong>warp_to_native</strong></span></a>: Warp images to native img space, unpad, and scale to full res.</p></li>
<li><p><a class="reference internal" href="unravel/warp/to_fixed.html#unravel-warp-to-fixed"><span class="std std-ref"><strong>warp_to_fixed</strong></span></a>: Warp full res tissue space images to fixed img space and unpad.</p></li>
</ul>
</div>
<input id="sd-tab-item-2" name="sd-tab-set-0" type="radio">
<label class="sd-tab-label" for="sd-tab-item-2">
Segmentation</label><div class="sd-tab-content docutils">
<ul class="simple">
<li><p><a class="reference internal" href="unravel/segment/copy_tifs.html#unravel-segment-copy-tifs"><span class="std std-ref"><strong>seg_copy_tifs</strong></span></a>: Copy TIF images (copy select tifs to target dir for training ilastik).</p></li>
<li><p><a class="reference internal" href="unravel/segment/brain_mask.html#unravel-segment-brain-mask"><span class="std std-ref"><strong>seg_brain_mask</strong></span></a>: Create brain mask (segment resampled autofluo tifs).</p></li>
<li><p><a class="reference internal" href="unravel/segment/ilastik_pixel_classification.html#unravel-segment-ilastik-pixel-classification"><span class="std std-ref"><strong>seg_ilastik</strong></span></a>: Perform pixel classification w/ Ilastik to segment features of interest.</p></li>
</ul>
</div>
<input id="sd-tab-item-3" name="sd-tab-set-0" type="radio">
<label class="sd-tab-label" for="sd-tab-item-3">
Voxel-wise stats</label><div class="sd-tab-content docutils">
<ul class="simple">
<li><p><a class="reference internal" href="unravel/voxel_stats/vstats_prep.html#unravel-voxel-stats-vstats-prep"><span class="std std-ref"><strong>vstats_prep</strong></span></a>: Prepare immunofluo images for voxel statistics (e.g., background subtract and warp to atlas space).</p></li>
<li><p><a class="reference internal" href="unravel/voxel_stats/z_score.html#unravel-voxel-stats-z-score"><span class="std std-ref"><strong>vstats_z_score</strong></span></a>: Z-score images.</p></li>
<li><p><a class="reference internal" href="unravel/voxel_stats/whole_to_LR_avg.html#unravel-voxel-stats-whole-to-lr-avg"><span class="std std-ref"><strong>vstats_whole_to_avg</strong></span></a>: Average left and right hemispheres together.</p></li>
<li><p><a class="reference internal" href="unravel/voxel_stats/vstats.html#unravel-voxel-stats-vstats"><span class="std std-ref"><strong>vstats</strong></span></a>: Compute voxel statistics.</p></li>
</ul>
</div>
<input id="sd-tab-item-4" name="sd-tab-set-0" type="radio">
<label class="sd-tab-label" for="sd-tab-item-4">
Cluster-wise stats</label><div class="sd-tab-content docutils">
<ul class="simple">
<li><p><a class="reference internal" href="unravel/cluster_stats/fdr_range.html#unravel-cluster-stats-fdr-range"><span class="std std-ref"><strong>cstats_fdr_range</strong></span></a>: Get FDR q value range yielding clusters.</p></li>
<li><p><a class="reference internal" href="unravel/cluster_stats/fdr.html#unravel-cluster-stats-fdr"><span class="std std-ref"><strong>cstats_fdr</strong></span></a>: FDR-correct 1-p value map → cluster map.</p></li>
<li><p><a class="reference internal" href="unravel/cluster_stats/recursively_mirror_rev_cluster_indices.html#unravel-cluster-stats-recursively-mirror-rev-cluster-indices"><span class="std std-ref"><strong>cstats_mirror_indices</strong></span></a>: Recursively mirror cluster maps for validating clusters in left and right hemispheres.</p></li>
<li><p><a class="reference internal" href="unravel/cluster_stats/validation.html#unravel-cluster-stats-validation"><span class="std std-ref"><strong>cstats_validation</strong></span></a>: Validate clusters w/ cell/label density measurements.</p></li>
<li><p><a class="reference internal" href="unravel/cluster_stats/summary.html#unravel-cluster-stats-summary"><span class="std std-ref"><strong>cstats_summary</strong></span></a>: Summarize info on valid clusters (run after cluster_validation).</p></li>
</ul>
</div>
<input id="sd-tab-item-5" name="sd-tab-set-0" type="radio">
<label class="sd-tab-label" for="sd-tab-item-5">
Region-wise stats</label><div class="sd-tab-content docutils">
<ul class="simple">
<li><p><a class="reference internal" href="unravel/region_stats/rstats.html#unravel-region-stats-rstats"><span class="std std-ref"><strong>rstats</strong></span></a>: Compute regional cell counts, regional volumes, or regional cell densities.</p></li>
<li><p><a class="reference internal" href="unravel/region_stats/rstats_summary.html#unravel-region-stats-rstats-summary"><span class="std std-ref"><strong>rstats_summary</strong></span></a>: Summarize regional cell densities.</p></li>
</ul>
</div>
<input id="sd-tab-item-6" name="sd-tab-set-0" type="radio">
<label class="sd-tab-label" for="sd-tab-item-6">
Image I/O</label><div class="sd-tab-content docutils">
<ul class="simple">
<li><p><a class="reference internal" href="unravel/image_io/metadata.html#unravel-image-io-metadata"><span class="std std-ref"><strong>io_metadata</strong></span></a>: Save raw voxel dimensions in microns and image dimensions to parameters/metadata.txt.</p></li>
<li><p><a class="reference internal" href="unravel/image_io/nii_info.html#unravel-image-io-nii-info"><span class="std std-ref"><strong>io_nii_info</strong></span></a>: Print info about NIfTI files.</p></li>
</ul>
</div>
<input id="sd-tab-item-7" name="sd-tab-set-0" type="radio">
<label class="sd-tab-label" for="sd-tab-item-7">
Image tools</label><div class="sd-tab-content docutils">
<ul class="simple">
<li><p><a class="reference internal" href="unravel/image_tools/avg.html#unravel-image-tools-avg"><span class="std std-ref"><strong>img_avg</strong></span></a>: Average NIfTI images.</p></li>
<li><p><a class="reference internal" href="unravel/image_tools/unique_intensities.html#unravel-image-tools-unique-intensities"><span class="std std-ref"><strong>img_unique</strong></span></a>: Find unique intensities in images.</p></li>
<li><p><a class="reference internal" href="unravel/image_tools/max.html#unravel-image-tools-max"><span class="std std-ref"><strong>img_max</strong></span></a>: Print the max intensity value in an image.</p></li>
<li><p><a class="reference internal" href="unravel/image_tools/spatial_averaging.html#unravel-image-tools-spatial-averaging"><span class="std std-ref"><strong>img_spatial_avg</strong></span></a>: Perform spatial averaging on images.</p></li>
<li><p><a class="reference internal" href="unravel/image_tools/rb.html#unravel-image-tools-rb"><span class="std std-ref"><strong>img_rb</strong></span></a>: Apply rolling ball filter to TIF images.</p></li>
</ul>
</div>
<input id="sd-tab-item-8" name="sd-tab-set-0" type="radio">
<label class="sd-tab-label" for="sd-tab-item-8">
Utilities</label><div class="sd-tab-content docutils">
<ul class="simple">
<li><p><a class="reference internal" href="unravel/utilities/aggregate_files_from_sample_dirs.html#unravel-utilities-aggregate-files-from-sample-dirs"><span class="std std-ref"><strong>utils_agg_files</strong></span></a>: Aggregate files from sample directories.</p></li>
<li><p><a class="reference internal" href="unravel/utilities/prepend_conditions.html#unravel-utilities-prepend-conditions"><span class="std std-ref"><strong>utils_prepend</strong></span></a>: Prepend conditions to files using sample_key.csv.</p></li>
<li><p><a class="reference internal" href="unravel/utilities/rename.html#unravel-utilities-rename"><span class="std std-ref"><strong>utils_rename</strong></span></a>: Rename files.</p></li>
</ul>
</div>
</div>
<div class="note dropdown admonition">
<p class="admonition-title">All commands</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-9" name="sd-tab-set-1" type="radio">
<label class="sd-tab-label" for="sd-tab-item-9">
Registration</label><div class="sd-tab-content docutils">
<ul class="simple">
<li><p><a class="reference internal" href="unravel/register/reg_prep.html#unravel-register-reg-prep"><span class="std std-ref"><strong>reg_prep</strong></span></a>: Prepare registration (resample the autofluo image to lower res).</p></li>
<li><p><a class="reference internal" href="unravel/register/reg.html#unravel-register-reg"><span class="std std-ref"><strong>reg</strong></span></a>: Perform registration (e.g., register the autofluo image to an average template).</p></li>
<li><p><a class="reference internal" href="unravel/register/affine_initializer.html#unravel-register-affine-initializer"><span class="std std-ref"><strong>reg_affine_initializer</strong></span></a>: Part of reg. Roughly aligns the template to the autofl image.</p></li>
<li><p><a class="reference internal" href="unravel/register/reg_check.html#unravel-register-reg-check"><span class="std std-ref"><strong>reg_check</strong></span></a>: Check registration (aggregate the autofluo and warped atlas images).</p></li>
<li><p><a class="reference internal" href="unravel/register/reg_check_brain_mask.html#unravel-register-reg-check-brain-mask"><span class="std std-ref"><strong>reg_check_brain_mask</strong></span></a>: Check brain mask for over/under segmentation.</p></li>
</ul>
</div>
<input id="sd-tab-item-10" name="sd-tab-set-1" type="radio">
<label class="sd-tab-label" for="sd-tab-item-10">
Warping</label><div class="sd-tab-content docutils">
<ul class="simple">
<li><p><a class="reference internal" href="unravel/warp/to_atlas.html#unravel-warp-to-atlas"><span class="std std-ref"><strong>warp_to_atlas</strong></span></a>: Warp full res tissue space images to atlas space.</p></li>
<li><p><a class="reference internal" href="unravel/warp/to_fixed.html#unravel-warp-to-fixed"><span class="std std-ref"><strong>warp_to_fixed</strong></span></a>: Warp full res tissue space images to fixed img space and unpad.</p></li>
<li><p><a class="reference internal" href="unravel/warp/to_native.html#unravel-warp-to-native"><span class="std std-ref"><strong>warp_to_native</strong></span></a>: Warp images to native img space, unpad, and scale to full res.</p></li>
<li><p><a class="reference internal" href="unravel/warp/points_to_atlas.html#unravel-warp-points-to-atlas"><span class="std std-ref"><strong>warp_points_to_atlas</strong></span></a>: Warp cell centroids in tissue space to atlas space.</p></li>
<li><p><a class="reference internal" href="unravel/warp/warp.html#unravel-warp-warp"><span class="std std-ref"><strong>warp</strong></span></a>: Warp between moving and fixed images (these have 15% padding from reg)</p></li>
</ul>
</div>
<input id="sd-tab-item-11" name="sd-tab-set-1" type="radio">
<label class="sd-tab-label" for="sd-tab-item-11">
Segmentation</label><div class="sd-tab-content docutils">
<ul class="simple">
<li><p><a class="reference internal" href="unravel/segment/copy_tifs.html#unravel-segment-copy-tifs"><span class="std std-ref"><strong>seg_copy_tifs</strong></span></a>: Copy TIF images (copy select tifs to target dir for training ilastik).</p></li>
<li><p><a class="reference internal" href="unravel/segment/brain_mask.html#unravel-segment-brain-mask"><span class="std std-ref"><strong>seg_brain_mask</strong></span></a>: Create brain mask (segment resampled autofluo tifs).</p></li>
<li><p><a class="reference internal" href="unravel/segment/ilastik_pixel_classification.html#unravel-segment-ilastik-pixel-classification"><span class="std std-ref"><strong>seg_ilastik</strong></span></a>: Perform pixel classification w/ Ilastik to segment features of interest.</p></li>
<li><p><a class="reference internal" href="unravel/segment/labels_to_masks.html#unravel-segment-labels-to-masks"><span class="std std-ref"><strong>seg_labels_to_masks</strong></span></a>: Convert each label to a binary .nii.gz.</p></li>
</ul>
</div>
<input id="sd-tab-item-12" name="sd-tab-set-1" type="radio">
<label class="sd-tab-label" for="sd-tab-item-12">
Voxel-wise stats</label><div class="sd-tab-content docutils">
<ul class="simple">
<li><p><a class="reference internal" href="unravel/voxel_stats/apply_mask.html#unravel-voxel-stats-apply-mask"><span class="std std-ref"><strong>vstats_apply_mask</strong></span></a>: Apply mask to image (e.g., nullify artifacts or isolate signals).</p></li>
<li><p><a class="reference internal" href="unravel/voxel_stats/vstats_prep.html#unravel-voxel-stats-vstats-prep"><span class="std std-ref"><strong>vstats_prep</strong></span></a>: Prepare immunofluo images for voxel statistics (e.g., background subtract and warp to atlas space).</p></li>
<li><p><a class="reference internal" href="unravel/voxel_stats/z_score.html#unravel-voxel-stats-z-score"><span class="std std-ref"><strong>vstats_z_score</strong></span></a>: Z-score images.</p></li>
<li><p><a class="reference internal" href="unravel/voxel_stats/whole_to_LR_avg.html#unravel-voxel-stats-whole-to-lr-avg"><span class="std std-ref"><strong>vstats_whole_to_avg</strong></span></a>: Average left and right hemispheres together.</p></li>
<li><p><a class="reference internal" href="unravel/voxel_stats/hemi_to_LR_avg.html#unravel-voxel-stats-hemi-to-lr-avg"><span class="std std-ref"><strong>vstats_hemi_to_avg</strong></span></a>: If left and right hemispheres were processed separately (less common), average them together.</p></li>
<li><p><a class="reference internal" href="unravel/voxel_stats/vstats.html#unravel-voxel-stats-vstats"><span class="std std-ref"><strong>vstats</strong></span></a>: Compute voxel statistics.</p></li>
<li><p><a class="reference internal" href="unravel/voxel_stats/mirror.html#unravel-voxel-stats-mirror"><span class="std std-ref"><strong>vstats_mirror</strong></span></a>: Flip and optionally shift content of images in atlas space.</p></li>
</ul>
</div>
<input id="sd-tab-item-13" name="sd-tab-set-1" type="radio">
<label class="sd-tab-label" for="sd-tab-item-13">
Cluster-wise stats</label><div class="sd-tab-content docutils">
<ul class="simple">
<li><p><a class="reference internal" href="unravel/cluster_stats/fdr_range.html#unravel-cluster-stats-fdr-range"><span class="std std-ref"><strong>cstats_fdr_range</strong></span></a>: Get FDR q value range yielding clusters.</p></li>
<li><p><a class="reference internal" href="unravel/cluster_stats/fdr.html#unravel-cluster-stats-fdr"><span class="std std-ref"><strong>cstats_fdr</strong></span></a>: FDR-correct 1-p value map → cluster map.</p></li>
<li><p><a class="reference internal" href="unravel/cluster_stats/recursively_mirror_rev_cluster_indices.html#unravel-cluster-stats-recursively-mirror-rev-cluster-indices"><span class="std std-ref"><strong>cstats_mirror_indices</strong></span></a>: Recursively mirror cluster maps for validating clusters in left and right hemispheres.</p></li>
<li><p><a class="reference internal" href="unravel/cluster_stats/validation.html#unravel-cluster-stats-validation"><span class="std std-ref"><strong>cstats_validation</strong></span></a>: Validate clusters w/ cell/label density measurements.</p></li>
<li><p><a class="reference internal" href="unravel/cluster_stats/summary.html#unravel-cluster-stats-summary"><span class="std std-ref"><strong>cstats_summary</strong></span></a>: Summarize info on valid clusters (run after cluster_validation).</p></li>
<li><p><a class="reference internal" href="unravel/cluster_stats/org_data.html#unravel-cluster-stats-org-data"><span class="std std-ref"><strong>cstats_org_data</strong></span></a>: Organize CSVs from cluster_validation.</p></li>
<li><p><a class="reference internal" href="unravel/cluster_stats/group_bilateral_data.html#unravel-cluster-stats-group-bilateral-data"><span class="std std-ref"><strong>cstats_group_data</strong></span></a>: Group bilateral cluster data.</p></li>
<li><p><a class="reference internal" href="unravel/cluster_stats/cstats.html#unravel-cluster-stats-cstats"><span class="std std-ref"><strong>cstats</strong></span></a>: Compute cluster validation statistics.</p></li>
<li><p><a class="reference internal" href="unravel/cluster_stats/mean_IF.html#unravel-cluster-stats-index"><span class="std std-ref"><strong>cstats_index</strong></span></a>: Make a valid cluster map and sunburst plots.</p></li>
<li><p><a class="reference internal" href="unravel/cluster_stats/brain_model.html#module-unravel.cluster_stats.brain_model" title="unravel.cluster_stats.brain_model"><span class="xref myst py py-mod"><strong>cstats_brain_model</strong></span></a>: Make a 3D brain model from a cluster map (for DSI studio).</p></li>
<li><p><a class="reference internal" href="unravel/cluster_stats/table.html#unravel-cluster-stats-table"><span class="std std-ref"><strong>cstats_table</strong></span></a>: Create a table of cluster validation data.</p></li>
<li><p><a class="reference internal" href="unravel/cluster_stats/prism.html#unravel-cluster-stats-prism"><span class="std std-ref"><strong>cstats_prism</strong></span></a>: Generate CSVs for bar charts in Prism.</p></li>
<li><p><a class="reference internal" href="unravel/cluster_stats/legend.html#unravel-cluster-stats-legend"><span class="std std-ref"><strong>cstats_legend</strong></span></a>: Make a legend of regions in cluster maps.</p></li>
<li><p><a class="reference internal" href="unravel/cluster_stats/sunburst.html#unravel-cluster-stats-sunburst"><span class="std std-ref"><strong>cstats_sunburst</strong></span></a>: Make CSVs for a sunburst plot of regional volumes.</p></li>
<li><p><a class="reference internal" href="unravel/cluster_stats/find_incongruent_clusters.html#unravel-cluster-stats-find-incongruent-clusters"><span class="std std-ref"><strong>cstats_find_incongruent_clusters</strong></span></a>: Find clusters where the effect direction does not match the prediction of cstats_fdr (for validation of non-directional p value maps).</p></li>
<li><p><a class="reference internal" href="unravel/cluster_stats/crop.html#unravel-cluster-stats-crop"><span class="std std-ref"><strong>cstats_crop</strong></span></a>: Crop clusters to a bounding box.</p></li>
<li><p><a class="reference internal" href="unravel/cluster_stats/index.html#unravel-cluster-stats-mean-if"><span class="std std-ref"><strong>cstats_mean_IF</strong></span></a>: Compute mean immunofluo intensities for each cluster.</p></li>
<li><p><a class="reference internal" href="unravel/cluster_stats/mean_IF_summary.html#unravel-cluster-stats-mean-if-summary"><span class="std std-ref"><strong>cstats_mean_IF_summary</strong></span></a>: Plot mean immunofluo intensities for each cluster.</p></li>
<li><p><a class="reference internal" href="unravel/cluster_stats/effect_sizes/effect_sizes.html#unravel-cluster-stats-effect-sizes-effect-sizes"><span class="std std-ref"><strong>effect_sizes</strong></span></a>: Calculate effect sizes for clusters.</p></li>
<li><p><a class="reference internal" href="unravel/cluster_stats/effect_sizes/effect_sizes_by_sex__absolute.html#unravel-cluster-stats-effect-sizes-effect-sizes-by-sex-absolute"><span class="std std-ref"><strong>effect_sizes_sex_abs</strong></span></a>: Calculate absolute effect sizes by sex.</p></li>
<li><p><a class="reference internal" href="unravel/cluster_stats/effect_sizes/effect_sizes_by_sex__relative.html#unravel-cluster-stats-effect-sizes-effect-sizes-by-sex-relative"><span class="std std-ref"><strong>effect_sizes_sex_rel</strong></span></a>: Calculate relative effect sizes by sex.</p></li>
</ul>
</div>
<input id="sd-tab-item-14" name="sd-tab-set-1" type="radio">
<label class="sd-tab-label" for="sd-tab-item-14">
Region-wise stats</label><div class="sd-tab-content docutils">
<ul class="simple">
<li><p><a class="reference internal" href="unravel/region_stats/rstats.html#unravel-region-stats-rstats"><span class="std std-ref"><strong>rstats</strong></span></a>: Compute regional cell counts, regional volumes, or regional cell densities.</p></li>
<li><p><a class="reference internal" href="unravel/region_stats/rstats_summary.html#unravel-region-stats-rstats-summary"><span class="std std-ref"><strong>rstats_summary</strong></span></a>: Summarize regional cell densities.</p></li>
<li><p><a class="reference internal" href="unravel/region_stats/rstats_mean_IF.html#unravel-region-stats-rstats-mean-if"><span class="std std-ref"><strong>rstats_mean_IF</strong></span></a>: Compute mean immunofluo intensities for regions.</p></li>
<li><p><a class="reference internal" href="unravel/region_stats/rstats_mean_IF_in_segmented_voxels.html#unravel-region-stats-rstats-mean-if-in-segmented-voxels"><span class="std std-ref"><strong>rstats_mean_IF_in_seg</strong></span></a>: Compute mean immunofluo intensities in segmented voxels.</p></li>
<li><p><a class="reference internal" href="unravel/region_stats/rstats_mean_IF_summary.html#unravel-region-stats-rstats-mean-if-summary"><span class="std std-ref"><strong>rstats_mean_IF_summary</strong></span></a>: Plot mean immunofluo intensities for regions.</p></li>
</ul>
</div>
<input id="sd-tab-item-15" name="sd-tab-set-1" type="radio">
<label class="sd-tab-label" for="sd-tab-item-15">
Image I/O</label><div class="sd-tab-content docutils">
<ul class="simple">
<li><p><a class="reference internal" href="unravel/image_io/metadata.html#unravel-image-io-metadata"><span class="std std-ref"><strong>io_metadata</strong></span></a>: Save raw voxel dimensions in microns and image dimensions to parameters/metadata.txt.</p></li>
<li><p><a class="reference internal" href="unravel/image_io/io_img.html#unravel-image-io-io-img"><span class="std std-ref"><strong>io_img</strong></span></a>: Image I/O operations.</p></li>
<li><p><a class="reference internal" href="unravel/image_io/nii_info.html#unravel-image-io-nii-info"><span class="std std-ref"><strong>io_nii_info</strong></span></a>: Print info about NIfTI files.</p></li>
<li><p><a class="reference internal" href="unravel/image_io/nii_hd.html#unravel-image-io-nii-hd"><span class="std std-ref"><strong>io_nii_hd</strong></span></a>: Print NIfTI headers.</p></li>
<li><p><a class="reference internal" href="unravel/image_io/io_nii.html#unravel-image-io-io-nii"><span class="std std-ref"><strong>io_nii</strong></span></a>: NIfTI I/O operations (binarize, convert data type, scale, etc).</p></li>
<li><p><a class="reference internal" href="unravel/image_io/reorient_nii.html#unravel-image-io-reorient-nii"><span class="std std-ref"><strong>io_reorient_nii</strong></span></a>: Reorient NIfTI files.</p></li>
<li><p><a class="reference internal" href="unravel/image_io/nii_to_tifs.html#unravel-image-io-nii-to-tifs"><span class="std std-ref"><strong>io_nii_to_tifs</strong></span></a>: Convert NIfTI files to TIFFs.</p></li>
<li><p><a class="reference internal" href="unravel/image_io/nii_to_zarr.html#unravel-image-io-nii-to-zarr"><span class="std std-ref"><strong>io_nii_to_zarr</strong></span></a>: Convert NIfTI files to Zarr.</p></li>
<li><p><a class="reference internal" href="unravel/image_io/zarr_to_nii.html#unravel-image-io-zarr-to-nii"><span class="std std-ref"><strong>io_zarr_to_nii</strong></span></a>: Convert Zarr format to NIfTI.</p></li>
<li><p><a class="reference internal" href="unravel/image_io/h5_to_tifs.html#unravel-image-io-h5-to-tifs"><span class="std std-ref"><strong>io_h5_to_tifs</strong></span></a>: Convert H5 files to TIFFs.</p></li>
<li><p><a class="reference internal" href="unravel/image_io/tif_to_tifs.html#unravel-image-io-tif-to-tifs"><span class="std std-ref"><strong>io_tif_to_tifs</strong></span></a>: Convert TIF to TIFF series.</p></li>
<li><p><a class="reference internal" href="unravel/image_io/img_to_npy.html#unravel-image-io-img-to-npy"><span class="std std-ref"><strong>io_img_to_npy</strong></span></a>: Convert images to Numpy arrays.</p></li>
<li><p><a class="reference internal" href="unravel/image_io/points_to_img.html#unravel-image-io-points-to-img"><span class="std std-ref"><strong>io_points_to_img</strong></span></a>: Populate an empty image with point coordinates</p></li>
<li><p><a class="reference internal" href="unravel/image_io/img_to_points.html#unravel-image-io-img-to-points"><span class="std std-ref"><strong>io_img_to_points</strong></span></a>: Convert and image into points coordinates</p></li>
</ul>
</div>
<input id="sd-tab-item-16" name="sd-tab-set-1" type="radio">
<label class="sd-tab-label" for="sd-tab-item-16">
Image tools</label><div class="sd-tab-content docutils">
<ul class="simple">
<li><p><a class="reference internal" href="unravel/image_tools/avg.html#unravel-image-tools-avg"><span class="std std-ref"><strong>img_avg</strong></span></a>: Average NIfTI images.</p></li>
<li><p><a class="reference internal" href="unravel/image_tools/unique_intensities.html#unravel-image-tools-unique-intensities"><span class="std std-ref"><strong>img_unique</strong></span></a>: Find unique intensities in images.</p></li>
<li><p><a class="reference internal" href="unravel/image_tools/max.html#unravel-image-tools-max"><span class="std std-ref"><strong>img_max</strong></span></a>: Print the max intensity value in an image.</p></li>
<li><p><a class="reference internal" href="unravel/image_tools/bbox.html#unravel-image-tools-bbox"><span class="std std-ref"><strong>img_bbox</strong></span></a>: Compute bounding box of non-zero voxels in an image.</p></li>
<li><p><a class="reference internal" href="unravel/image_tools/spatial_averaging.html#unravel-image-tools-spatial-averaging"><span class="std std-ref"><strong>img_spatial_avg</strong></span></a>: Perform spatial averaging on images.</p></li>
<li><p><a class="reference internal" href="unravel/image_tools/rb.html#unravel-image-tools-rb"><span class="std std-ref"><strong>img_rb</strong></span></a>: Apply rolling ball filter to TIF images.</p></li>
<li><p><a class="reference internal" href="unravel/image_tools/DoG.html#unravel-image-tools-dog"><span class="std std-ref"><strong>img_DoG</strong></span></a>: Apply Difference of Gaussian filter to TIF images.</p></li>
<li><p><a class="reference internal" href="unravel/image_tools/pad.html#unravel-image-tools-pad"><span class="std std-ref"><strong>img_pad</strong></span></a>: Pad images.</p></li>
<li><p><a class="reference internal" href="unravel/image_tools/resample.html#unravel-image-tools-resample"><span class="std std-ref"><strong>img_resample</strong></span></a>: Resample images.</p></li>
<li><p><a class="reference internal" href="unravel/image_tools/extend.html#unravel-image-tools-extend"><span class="std std-ref"><strong>img_extend</strong></span></a>: Extend images (add padding to one side).</p></li>
<li><p><a class="reference internal" href="unravel/image_tools/transpose_axes.html#unravel-image-tools-transpose-axes"><span class="std std-ref"><strong>img_transpose</strong></span></a>: Transpose image axes.</p></li>
<li><p><a class="reference internal" href="unravel/image_tools/resample_points.html#unravel-image-tools-resample-points"><span class="std std-ref"><strong>img_resample_points</strong></span></a>: Resample a set of points [and save as an image].</p></li>
</ul>
</div>
<input id="sd-tab-item-17" name="sd-tab-set-1" type="radio">
<label class="sd-tab-label" for="sd-tab-item-17">
Atlas tools</label><div class="sd-tab-content docutils">
<ul class="simple">
<li><p><a class="reference internal" href="unravel/image_tools/atlas/relabel_nii.html#unravel-image-tools-atlas-relabel-nii"><span class="std std-ref"><strong>atlas_relabel</strong></span></a>: Relabel atlas IDs.</p></li>
<li><p><a class="reference internal" href="unravel/image_tools/atlas/wireframe.html#unravel-image-tools-atlas-wireframe"><span class="std std-ref"><strong>atlas_wireframe</strong></span></a>: Make an atlas wireframe.</p></li>
</ul>
</div>
<input id="sd-tab-item-18" name="sd-tab-set-1" type="radio">
<label class="sd-tab-label" for="sd-tab-item-18">
Utilities</label><div class="sd-tab-content docutils">
<ul class="simple">
<li><p><a class="reference internal" href="unravel/utilities/get_samples.html#unravel-utilities-get-samples"><span class="std std-ref"><strong>utils_get_samples</strong></span></a>: Test –pattern and –dirs args of script that batch process sample?? dirs.</p></li>
<li><p><a class="reference internal" href="unravel/utilities/aggregate_files_from_sample_dirs.html#unravel-utilities-aggregate-files-from-sample-dirs"><span class="std std-ref"><strong>utils_agg_files</strong></span></a>: Aggregate files from sample directories.</p></li>
<li><p><a class="reference internal" href="unravel/utilities/aggregate_files_recursively.html#unravel-utilities-aggregate-files-recursively"><span class="std std-ref"><strong>utils_agg_files_rec</strong></span></a>: Recursively aggregate files.</p></li>
<li><p><a class="reference internal" href="unravel/utilities/prepend_conditions.html#unravel-utilities-prepend-conditions"><span class="std std-ref"><strong>utils_prepend</strong></span></a>: Prepend conditions to files using sample_key.csv.</p></li>
<li><p><a class="reference internal" href="unravel/utilities/rename.html#unravel-utilities-rename"><span class="std std-ref"><strong>utils_rename</strong></span></a>: Rename files.</p></li>
<li><p><a class="reference internal" href="unravel/utilities/toggle_samples.html#unravel-utilities-toggle-samples"><span class="std std-ref"><strong>utils_toggle</strong></span></a>: Toggle sample?? folders for select batch processing.</p></li>
<li><p><a class="reference internal" href="unravel/utilities/clean_tif_dirs.html#unravel-utilities-clean-tif-dirs"><span class="std std-ref"><strong>utils_clean_tifs</strong></span></a>: Clean TIF directories (no spaces, move non-tifs).</p></li>
<li><p><a class="reference internal" href="unravel/utilities/points_compressor.html#unravel-utilities-points-compressor"><span class="std std-ref"><strong>utils_points_compressor</strong></span></a>: Pack or unpack point data in a CSV file or summarize the number of points per region.</p></li>
</ul>
</div>
</div>
</div>
<div class="note dropdown admonition">
<p class="admonition-title">More info on commands</p>
<p>unravel_commands runs ./&lt;repo_root_dir&gt;/unravel/unravel_commands.py</p>
<p>Its help guide is here: <a class="reference internal" href="unravel/unravel_commands.html#module-unravel.unravel_commands" title="unravel.unravel_commands"><code class="xref py py-mod docutils literal notranslate"><span class="pre">unravel.unravel_commands</span></code></a></p>
<p>Commands are defined in the <code class="docutils literal notranslate"><span class="pre">[project.scripts]</span></code> section of the <a class="reference external" href="https://github.com/b-heifets/UNRAVEL/blob/main/pyproject.toml">pyproject.toml</a> in the root directory of the UNRAVEL repository (repo).</p>
<p>If new commands are added to run new scripts (a.k.a. modules), reinstall the unravel package with pip.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>&lt;path<span class="w"> </span>to<span class="w"> </span>the<span class="w"> </span>root<span class="w"> </span>directory<span class="w"> </span>of<span class="w"> </span>the<span class="w"> </span>UNRAVEL<span class="w"> </span>repo&gt;
pip<span class="w"> </span>install<span class="w"> </span>-e<span class="w"> </span>.
</pre></div>
</div>
</div>
<hr class="docutils" />
<br>
</section>
<section id="set-up">
<h2>Set Up<a class="headerlink" href="#set-up" title="Link to this heading">#</a></h2>
<p>Recommended steps to set up for analysis:</p>
<section id="back-up-raw-data">
<h3>Back Up Raw Data<a class="headerlink" href="#back-up-raw-data" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>For Heifets lab members, we keep one copy of raw data on an external drive and another on a remote server (Dan and Austen have access)</p></li>
</ul>
</section>
<section id="stitch-z-stacks">
<h3>Stitch Z-stacks<a class="headerlink" href="#stitch-z-stacks" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>We use <a class="reference external" href="https://www.micro-shop.zeiss.com/en/us/softwarefinder/software-categories/zen-blue/">ZEN (blue edition)</a> since we have a <a class="reference external" href="https://www.zeiss.com/microscopy/en/products/light-microscopes/light-sheet-microscopes/lightsheet-7.html">Zeiss Lightsheet 7</a></p></li>
</ul>
<div class="note dropdown admonition">
<p class="admonition-title">Batch stitching settings</p>
<figure class="align-center" id="id2">
<a class="reference internal image-reference" href="_images/batch_stitching_1.JPG"><img alt="_images/batch_stitching_1.JPG" src="_images/batch_stitching_1.JPG" style="width: 50%;" />
</a>
<figcaption>
<p><span class="caption-text">Select a mid-stack reference slice. Ideally, tissue will be present in each tile of the reference slice.</span><a class="headerlink" href="#id2" title="Link to this image">#</a></p>
</figcaption>
</figure>
</div>
<div class="note dropdown admonition">
<p class="admonition-title">Running batch stitching</p>
<figure class="align-center">
<a class="reference internal image-reference" href="_images/batch_stitching_2.JPG"><img alt="_images/batch_stitching_2.JPG" src="_images/batch_stitching_2.JPG" style="width: 100%;" />
</a>
</figure>
<ul class="simple">
<li><p>Drag and drop images to be stitched into this section.</p></li>
<li><p>For each image in the list, apply the stitching settings one by one (do not go back to a prior image, as settings will no longer stick).</p></li>
<li><p>Select all images (control + A or shift and click)</p></li>
<li><p>Click “Check All”</p></li>
<li><p>Click “Run Selected”</p></li>
</ul>
</div>
<div class="tip dropdown admonition">
<p class="admonition-title">Open source options for stitching</p>
<ul class="simple">
<li><p><a class="reference external" href="https://abria.github.io/TeraStitcher/">TeraStitcher</a></p></li>
<li><p><a class="reference external" href="https://github.com/lens-biophotonics/ZetaStitcher">ZetaStitched</a></p></li>
</ul>
</div>
</section>
<section id="make-sample-folders">
<h3>Make Sample Folders<a class="headerlink" href="#make-sample-folders" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Make a folder named after each condition in the experiment folder(s)</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>. # This root level folder is referred to as the experiment directory (exp dir) 
├── Control
└── Treatment
</pre></div>
</div>
<ul class="simple">
<li><p>Make sample folders in the directories named after each condition</p></li>
</ul>
<div class="tip dropdown admonition">
<p class="admonition-title">Name sample folders like sample01, sample02, …</p>
<p>This makes batch processing easy.</p>
<p>Use a csv, Google sheet, or whatever else for linking sample IDs to IDs w/ this convention.</p>
<p>Other patterns (e.g., sample???) may be used (commands have a -p option for that).</p>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>.
├── Control
│   ├── sample01
│   └── sample02
└── Treatment
    ├── sample03
    └── sample04
</pre></div>
</div>
</section>
<section id="add-images-to-sample-directories">
<h3>Add Images to sample?? Directories<a class="headerlink" href="#add-images-to-sample-directories" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>For example, image.czi, image.h5, folder(s) with tif series, or an .ome.tif.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>.
├── Control
│   ├── sample01
│   │   └── &lt;raw/stitched image(s)&gt;
│   └── sample02
│       └── &lt;raw/stitched image(s)&gt;
└── Treatment
    ├── sample03
    │   └── &lt;raw/stitched image(s)&gt;
    └── sample04
        └── &lt;raw/stitched image(s)&gt;
</pre></div>
</div>
<div class="tip dropdown admonition">
<p class="admonition-title">Data can be distributed across multiple drives</p>
<p>Paths to each experiment directory may be passed into scripts using the -d flag for batch processing</p>
<p>This is useful if there is not enough storage on a single drive.</p>
<p>Also, spreading data across ~2-4 external drives allows for faster parallel processing (minimizes i/o botlenecks)</p>
<p>If SSDs are used, distrubuting data may not speed up processing as much.</p>
</div>
</section>
<section id="log-paths-commands-etc">
<h3>Log Paths, Commands, etc.<a class="headerlink" href="#log-paths-commands-etc" title="Link to this heading">#</a></h3>
<div class="tip dropdown admonition">
<p class="admonition-title">Make an exp_notes.txt</p>
<p>This helps with keeping track of paths, commands, etc..</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>&lt;path/to/dir/with/sample??<span class="w"> </span>folders&gt;
touch<span class="w"> </span>exp_notes.txt<span class="w">  </span><span class="c1"># Make the .txt file</span>
</pre></div>
</div>
</div>
<div class="tip dropdown admonition">
<p class="admonition-title">Automatic logging of scripts</p>
<p>Most scripts log the command used to run them, appending to ./.command_log.txt.</p>
<p>This is a hidden file. Use control+h to view it on Linux or command+shift+. to view it on MacOS.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># View command history for the current working directory</span>
cat<span class="w"> </span>.command_log.txt<span class="w">  </span>

<span class="c1"># View last 10 lines</span>
cat<span class="w"> </span>.command_log.txt<span class="w"> </span><span class="p">|</span><span class="w"> </span>tail<span class="w"> </span>-10<span class="w">  </span>
</pre></div>
</div>
</div>
</section>
<section id="make-a-sample-key-csv">
<h3>Make a sample_key.csv:<a class="headerlink" href="#make-a-sample-key-csv" title="Link to this heading">#</a></h3>
<p>It should have these columns:</p>
<ul class="simple">
<li><p>dir_name,condition</p></li>
<li><p>sample01,control</p></li>
<li><p>sample02,treatment</p></li>
<li><p>…</p></li>
</ul>
</section>
<section id="defining-common-variables-for-command-arguments">
<h3>Defining Common Variables for Command Arguments<a class="headerlink" href="#defining-common-variables-for-command-arguments" title="Link to this heading">#</a></h3>
<div class="note dropdown admonition">
<p class="admonition-title">To simplify running commands, define common variables in a shell script (e.g., env_var.sh).</p>
<ul class="simple">
<li><p>For example, $BASE is global variable representing the path to the main experiment folder, a place to aggregate analyses and sample?? folders</p></li>
<li><p>Example: $BASE represents the main experiment folder where analyses and sample?? folders (or condition folders with sample?? folders) are stored.</p></li>
<li><p>Source the script to load variables in each terminal session</p></li>
<li><p>Copy /UNRAVEL/unravel/env_var.sh to your experiment directory and update each variable with a code editor (e.g., <strong><a class="reference external" href="https://code.visualstudio.com/download">VS Code</a></strong> or <strong><a class="reference external" href="https://www.youtube.com/watch?v=DLeATFgGM-A">nano</a></strong>)</p></li>
<li><p>Using your editor, add this line to your terminal config file (.bashrc or .zshrc) to easily load variables:</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">alias</span><span class="w"> </span><span class="nv">exp</span><span class="o">=</span><span class="s2">&quot;. /path/to/env_var.sh&quot;</span><span class="w">  </span><span class="c1"># Update the path. Use a short name for `exp`.</span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Reopen the terminal or source your terminal config file to apply changes</span>
.<span class="w"> </span>~/.bashrc<span class="w">  </span><span class="c1"># or . ~/.zshrc</span>

<span class="c1"># Run the alias before using commands</span>
exp

<span class="c1"># Echo a variable to see its value:</span>
<span class="nb">echo</span><span class="w"> </span><span class="nv">$DIRS</span><span class="w">  </span><span class="c1"># This variable contains a space-separated list of paths to sample?? folders or directories containing them (for batch processing with `-d`)</span>

<span class="c1"># Example:</span>
utils_get_samples<span class="w"> </span>-d<span class="w"> </span><span class="nv">$DIRS</span><span class="w">  </span><span class="c1"># Finds all sample?? folders in the paths from $DIRS.</span>
</pre></div>
</div>
</div>
</section>
<section id="optional-clean-tiffs">
<h3>Optional: Clean TIFFs<a class="headerlink" href="#optional-clean-tiffs" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>If raw data is in the form of a tif series, consider running:</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>utils_clean_tifs<span class="w"> </span>-t<span class="w"> </span>&lt;path<span class="w"> </span>to<span class="w"> </span>directories<span class="w"> </span>with<span class="w"> </span>tifs<span class="w"> </span>relative<span class="w"> </span>to<span class="w"> </span>./sample??<span class="w"> </span>folders&gt;<span class="w"> </span>-m
</pre></div>
</div>
<ul class="simple">
<li><p>This will remove spaces from files names and move files other than *.tif to the parent directory</p></li>
</ul>
<hr class="docutils" />
<br>
</section>
</section>
<section id="analysis-overview">
<h2>Analysis Overview<a class="headerlink" href="#analysis-overview" title="Link to this heading">#</a></h2>
<p>Overview of a typical workflow (voxel-wise analyses followed by cluster validation):</p>
<div class="mermaid">
            flowchart TD
    A(((LSFM))) 
    A --&gt; B[Stitched 3D autofluorescence image]
    B --&gt; C(Resample image to 50 µm resolution)
    C --&gt; D(Segment tissue with Ilastik to mask external voxels)
    D --&gt; E(Register image to an average template brain) 
    A --&gt; F[Stitched 3D immunofluorescence image]
    F --&gt; G(Remove autofluorescence from IF images)
    G --&gt; H(Warp IF images to atlas space)
    E --&gt; H
    H --&gt; I(Preprocess IF images: z-score, smooth, and average left/right sides)
    I --&gt; J(Perform voxel-wise statistical analyses)
    J --&gt; K(Apply FDR correction of 1-p value maps)
    K --&gt; L(Warp significant voxel clusters back to tissue space)
    F --&gt; N(Segment c-Fos+ cells or other features using Ilastik)
    L --&gt; M(Validate clusters with cell/label density measurements)
    N --&gt; M
    D --&gt; I
    E --&gt; L
        </div><hr class="docutils" />
<br>
</section>
<section id="training-ilastik">
<h2>Training Ilastik<a class="headerlink" href="#training-ilastik" title="Link to this heading">#</a></h2>
<p>Ilastik has two purposes for our typical workflow:</p>
<ol class="arabic simple">
<li><p>During registration, Ilastik is used to segment tissue, creating brain masks that refine registration of autofluo images and z-scoring of IF images. After training Ilastik, segmentation of 50 µm autolfluo images is automated with <a class="reference internal" href="unravel/segment/brain_mask.html#unravel-segment-brain-mask"><span class="std std-ref"><strong>seg_brain_mask</strong></span></a>.</p></li>
</ol>
<figure class="align-center">
<a class="reference internal image-reference" href="_images/Ilastik_brain_mask_example.jpg"><img alt="_images/Ilastik_brain_mask_example.jpg" src="_images/Ilastik_brain_mask_example.jpg" style="width: 70%;" />
</a>
</figure>
<ol class="arabic simple" start="2">
<li><p>During cluster validation, Ilastik labels c-Fos+ cells or other features of interest for quantification of cell or label densities within clusters from voxel-wise statistics. Segmentation of full-res IF images is automated with <a class="reference internal" href="unravel/segment/ilastik_pixel_classification.html#unravel-segment-ilastik-pixel-classification"><span class="std std-ref"><strong>seg_ilastik</strong></span></a>.</p></li>
</ol>
<figure class="align-center">
<a class="reference internal image-reference" href="_images/Ilastik_c-Fos_example.jpg"><img alt="_images/Ilastik_c-Fos_example.jpg" src="_images/Ilastik_c-Fos_example.jpg" style="width: 70%;" />
</a>
</figure>
<p><a class="reference external" href="https://www.ilastik.org/documentation/pixelclassification/pixelclassification">Pixel classification documentation</a></p>
<div class="note admonition">
<p class="admonition-title">Setting up Ilastik for batch processing</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.ilastik.org/download">Install Ilastik</a></p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add this to your ~/.bashrc or ~/.zshrc terminal config file:</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span>/usr/local/ilastik-1.4.0.post1-Linux:<span class="nv">$PATH</span><span class="w">   </span><span class="c1"># Update the path and version</span>

<span class="c1"># Optional: add a shortcut command for launching Ilastik via the terminal</span>
<span class="nb">alias</span><span class="w"> </span><span class="nv">ilastik</span><span class="o">=</span>run_ilastik.sh<span class="w">  </span><span class="c1"># run_ilastik.sh could be replaced w/ the full path to the executable file</span>

<span class="c1"># Ilastik executable files for each OS:</span>
<span class="c1">#     - Linux and WSL: /usr/local/ilastik-1.4.0.post1-Linux/run_ilastik.sh</span>
<span class="c1">#     - Mac: /Applications/Ilastik.app/Contents/ilastik-release/run_ilastik.sh</span>
<span class="c1">#     - Windows: C:\Program Files\ilastik-1.3.3post3\run_ilastik.bat</span>

<span class="c1"># Source your terminal config file for these edits to take effect: </span>
.<span class="w"> </span>~/.bashrc<span class="w">  </span><span class="c1"># Or close and reopen the terminal</span>
</pre></div>
</div>
</div>
<div class="note admonition">
<p class="admonition-title">Training Ilastik</p>
<p><strong>Launch Ilastik</strong></p>
<ul class="simple">
<li><p>Either double click on the application or run: <code class="docutils literal notranslate"><span class="pre">ilastik</span></code> (if you set up an alias)</p></li>
</ul>
<ol class="arabic simple">
<li><p><strong>Input Data</strong></p>
<ul class="simple">
<li><p>Gather training slices to a folder from all samples with <a class="reference internal" href="unravel/segment/copy_tifs.html#unravel-segment-copy-tifs"><span class="std std-ref"><strong>seg_copy_tifs</strong></span></a></p></li>
<li><p>Drag and drop training slices into the ilastik GUI (e.g., from a dir w/ 3 slices per sample and &gt; 2 samples per condition)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ctrl+A</span></code> to select training slices -&gt; right-click -&gt; Edit shared properties -&gt; Storage: Copy into project file -&gt; Ok</p></li>
</ul>
</li>
<li><p><strong>Feature Selection</strong></p>
<ul class="simple">
<li><p>Select Features… -&gt; select all features (<code class="docutils literal notranslate"><span class="pre">control+a</span></code>) or an optimized subset (faster but less accurate).</p></li>
<li><p>Optional: to find an optimal subset of features, select all features, train Ilastik, turn off Live Updates, click Suggest Features, select a subset, and refine training.</p></li>
</ul>
</li>
<li><p><strong>Training</strong></p>
<ul class="simple">
<li><p><em><strong>Brightness/contrast</strong></em>: select the gradient button and click and drag in the image (faster if zoomed in)</p></li>
<li><p><em><strong>Zoom</strong></em>: <code class="docutils literal notranslate"><span class="pre">control/command</span> <span class="pre">+</span> <span class="pre">mouse</span> <span class="pre">wheel</span> <span class="pre">scroll</span></code>, <code class="docutils literal notranslate"><span class="pre">control/command</span> <span class="pre">+</span> <span class="pre">2</span> <span class="pre">finger</span> <span class="pre">scroll</span></code>, or <code class="docutils literal notranslate"><span class="pre">-</span></code> and <code class="docutils literal notranslate"><span class="pre">+</span></code> (i.e., <code class="docutils literal notranslate"><span class="pre">shift</span> <span class="pre">+</span> <span class="pre">=</span></code>)</p></li>
<li><p><em><strong>Pan</strong></em>: <code class="docutils literal notranslate"><span class="pre">shift</span></code> + <code class="docutils literal notranslate"><span class="pre">left</span> <span class="pre">click</span> <span class="pre">and</span> <span class="pre">drag</span></code> or <code class="docutils literal notranslate"><span class="pre">click</span> <span class="pre">mouse</span> <span class="pre">wheel</span> <span class="pre">and</span> <span class="pre">drag</span></code></p></li>
<li><p>With <code class="docutils literal notranslate"><span class="pre">label</span> <span class="pre">1</span></code> and the <code class="docutils literal notranslate"><span class="pre">brush</span> <span class="pre">tool</span></code> selected, paint on c-Fos+ cells or another feature of interest</p></li>
<li><p>With <code class="docutils literal notranslate"><span class="pre">label</span> <span class="pre">2</span></code> and the <code class="docutils literal notranslate"><span class="pre">brush</span> <span class="pre">tool</span></code> selected, paint on the background (e.g., any pixel that is not a cell)</p></li>
<li><p>Turn on <code class="docutils literal notranslate"><span class="pre">Live</span> <span class="pre">Update</span></code> to preview pixel classification (faster if zoomed in) and refine training (e.g., if some cells are classified as background, paint more cells with label 1).</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">s</span></code> will toggle the segmentation on and off.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">p</span></code> will toggle the prediction on and off.</p></li>
<li><p>Toggle eyes to show/hide layers and/or adjust transparency of layers.</p></li>
</ul>
</li>
<li><p>Change <code class="docutils literal notranslate"><span class="pre">Current</span> <span class="pre">View</span></code> to see other training slices. Check segmentation for these and refine as needed.</p></li>
<li><p>Save the project in the experiment summary folder and close if using this script to run ilastik in headless mode for segmenting all images.</p></li>
<li><p><a class="reference external" href="https://b-heifets.github.io/UNRAVEL/guide.html#seg-brain-mask">Segment 50 µm autofluo images</a></p></li>
<li><p><a class="reference external" href="https://b-heifets.github.io/UNRAVEL/guide.html#segmentation-of-full-resolution-fluorescence-images">Segment immunofluo images</a> to segment c-Fos+ cells or other features</p></li>
</ul>
</li>
</ol>
<p><strong>Notes</strong></p>
<ul class="simple">
<li><p>If you want to go back to steps 1 &amp; 2, turn Live Updates off</p></li>
<li><p>It is possible at add extra labels with <code class="docutils literal notranslate"><span class="pre">a</span></code> (e.g., if you want to segment somata with one label and axons with another label)</p></li>
<li><p>If you accidentally press <code class="docutils literal notranslate"><span class="pre">a</span></code>, turn off Live Updates and press <code class="docutils literal notranslate"><span class="pre">x</span></code> next to the extra label to delete it.</p></li>
<li><p>If the segmentation for label 1 fuses neighboring cells, draw a thin line in between them with label 2.</p></li>
</ul>
</div>
<hr class="docutils" />
<br>
</section>
<section id="registration">
<h2>Registration<a class="headerlink" href="#registration" title="Link to this heading">#</a></h2>
<div class="mermaid">
            flowchart TD
    A(((LSFM))) 
    A --&gt; B[Stitch z-stacks if necessary]
    B --&gt; C(io_metadata: Save raw voxel dimentions in microns to ./sample??/parameters/metadata.txt)
    C --&gt; D(reg_prep: Resample autofluorescence images to 50 µm resolution for registration)
    D --&gt; E(seg_copy_tifs: Copy select slices from 50 µm autofl images to create brain masks using Ilastik)
    E --&gt; F(Train Ilastik using pixel classification to segment autofl brains)
    F --&gt; G(seg_brain_mask: Generate autofl brain masks with Ilastik and apply them to the 50 µm images)
    G --&gt; H(Optionally use 3D Slicer to make the masked autofl image and mask better match the average template)
    H --&gt; I(reg: Register the template brain with the masked autofl images and warp the atlas)
    I --&gt; J(reg_check: Aggregate padded autofl images and warped atlas images from reg)
    J --&gt; K(Assess registration quality in FSLeyes and refine if necessary by repeating the 3D Slicer step, etc.)

        </div><section id="io-metadata">
<h3><code class="docutils literal notranslate"><span class="pre">io_metadata</span></code><a class="headerlink" href="#io-metadata" title="Link to this heading">#</a></h3>
<p><a class="reference internal" href="unravel/image_io/metadata.html#module-unravel.image_io.metadata" title="unravel.image_io.metadata"><code class="xref py py-mod docutils literal notranslate"><span class="pre">unravel.image_io.metadata</span></code></a></p>
<ul class="simple">
<li><p>Extract or specify x and z voxel sizes in microns (saves to ./sample??/parameters/metadata.txt).</p></li>
<li><p>You can add these resolutions to env_var.sh as global variables (e.g., $XY and $Z) and load them before running commands with: <code class="docutils literal notranslate"><span class="pre">source</span> <span class="pre">path/to/env_var.sh</span></code></p></li>
<li><p><strong><a class="reference external" href="https://b-heifets.github.io/UNRAVEL/guide.html#defining-common-variables-for-command-arguments">Guide on defining common command arguments in env_var.sh</a></strong></p></li>
<li><p>For batch processing, run the io_metadata command from a directory containing sample?? folders, within a sample?? folder, or use -d to pass in a list of paths to sample folders or directories containing sample folders.</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># To specify x and z voxel sizes in microns, use the -x and -z flags.</span>
io_metadata<span class="w"> </span>-i<span class="w"> </span>&lt;path<span class="w"> </span>to<span class="w"> </span>image<span class="w"> </span>or<span class="w"> </span>directory<span class="w"> </span>with<span class="w"> </span>TIFFs<span class="w"> </span>relative<span class="w"> </span>to<span class="w"> </span>sample??/&gt;<span class="w"> </span>-x<span class="w"> </span><span class="nv">$XY</span><span class="w"> </span>-z<span class="w"> </span><span class="nv">$Z</span><span class="w"> </span><span class="o">[</span>-d<span class="w"> </span><span class="nv">$DIRS</span><span class="o">]</span><span class="w"> </span><span class="c1"># Remove square brackets from optional arguments</span>
<span class="c1"># If env_var.sh is not used, pass in the voxel sizes like this: -x 3.5232 -z 6.</span>

<span class="c1"># If -x and -z are omitted, io_metadata will attempt to extract this information from the image metadata.</span>
io_metadata<span class="w"> </span>-i<span class="w"> </span>&lt;rel_path/full_res_img&gt;<span class="w"> </span><span class="o">[</span>-d<span class="w"> </span><span class="nv">$DIRS</span><span class="o">]</span>
<span class="c1"># &#39;rel_path&#39; refers to the relative path from within the sample?? folders.</span>
<span class="c1"># Glob patterns can be used for -i (e.g., *.czi).</span>
</pre></div>
</div>
</section>
<section id="reg-prep">
<h3><code class="docutils literal notranslate"><span class="pre">reg_prep</span></code><a class="headerlink" href="#reg-prep" title="Link to this heading">#</a></h3>
<p><a class="reference internal" href="unravel/register/reg_prep.html#module-unravel.register.reg_prep" title="unravel.register.reg_prep"><code class="xref py py-mod docutils literal notranslate"><span class="pre">unravel.register.reg_prep</span></code></a></p>
<ul class="simple">
<li><p>Prepare autofluorescence images for registration (resample them to 50 µm isotropic resolution and save to ./sample??/reg_inputs/)</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>reg_prep<span class="w"> </span>-i<span class="w"> </span>&lt;rel_path/image&gt;<span class="w"> </span><span class="o">[</span>-d<span class="w"> </span><span class="nv">$DIRS</span><span class="o">]</span><span class="w"> </span><span class="c1"># -i options: tif_dir, .czi, .h5, .zarr, or .tif (e.g., *.czi)</span>
<span class="c1"># If using *.czi, by default the first channel is used (--channel 0), since that is usually the autofluo channel</span>
</pre></div>
</div>
</section>
<section id="seg-copy-tifs">
<h3><code class="docutils literal notranslate"><span class="pre">seg_copy_tifs</span></code><a class="headerlink" href="#seg-copy-tifs" title="Link to this heading">#</a></h3>
<p><a class="reference internal" href="unravel/segment/copy_tifs.html#module-unravel.segment.copy_tifs" title="unravel.segment.copy_tifs"><code class="xref py py-mod docutils literal notranslate"><span class="pre">unravel.segment.copy_tifs</span></code></a></p>
<ul class="simple">
<li><p>Copy resampled autofluo .tif files from each sample for making a brain mask with ilastik</p></li>
<li><p>In the example below -s 0000 0005 0050 means that the 1st, 6th, and 51st tif will be copied to the target directory</p></li>
<li><p>The target directory is the current working directory unless -td is used to specify an output path.</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>seg_copy_tifs<span class="w"> </span>-i<span class="w"> </span>reg_inputs/autofl_??um_tifs<span class="w"> </span>-s<span class="w"> </span><span class="m">0000</span><span class="w"> </span><span class="m">0005</span><span class="w"> </span><span class="m">0050</span><span class="w"> </span><span class="o">[</span>-td<span class="w"> </span>brain_mask<span class="o">]</span><span class="w"> </span><span class="o">[</span>-d<span class="w"> </span><span class="nv">$DIRS</span><span class="o">]</span><span class="w">  </span>
</pre></div>
</div>
<p><strong><a class="reference external" href="https://b-heifets.github.io/UNRAVEL/guide.html#training-ilastik">Train Ilastik</a> to segment autofluo tissue to make a brain mask</strong></p>
</section>
<section id="seg-brain-mask">
<h3><code class="docutils literal notranslate"><span class="pre">seg_brain_mask</span></code><a class="headerlink" href="#seg-brain-mask" title="Link to this heading">#</a></h3>
<p><a class="reference internal" href="unravel/segment/brain_mask.html#module-unravel.segment.brain_mask" title="unravel.segment.brain_mask"><code class="xref py py-mod docutils literal notranslate"><span class="pre">unravel.segment.brain_mask</span></code></a></p>
<ul class="simple">
<li><p>Makes reg_inputs/autofl_??um_brain_mask.nii.gz and reg_inputs/autofl_??um_masked.nii.gz for <code class="docutils literal notranslate"><span class="pre">reg</span></code></p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>seg_brain_mask<span class="w"> </span>-ie<span class="w"> </span>&lt;path/ilastik_executable&gt;<span class="w"> </span>-ilp<span class="w"> </span>&lt;path/trained_ilastik_project.ilp&gt;<span class="w"> </span><span class="o">[</span>-d<span class="w"> </span><span class="nv">$DIRS</span><span class="o">]</span>
</pre></div>
</div>
<div class="hint admonition">
<p class="admonition-title">Making the autofluorescence image better match the average template image</p>
<ul class="simple">
<li><p>seg_brain_mask zeros out voxels outside of the brain. This prevents the average template (moving image) from being pulled outward during registration (reg).</p></li>
<li><p>If non-zero voxles outside the brain remain and are affecting reg quality, use 3D slicer to zero them out by painting in 3D (segmentation module).</p></li>
<li><p>If there is missing tissue, use 3D slicer to fill in gaps.</p></li>
</ul>
</div>
</section>
<section id="reg">
<h3><code class="docutils literal notranslate"><span class="pre">reg</span></code><a class="headerlink" href="#reg" title="Link to this heading">#</a></h3>
<p><a class="reference internal" href="unravel/register/reg.html#module-unravel.register.reg" title="unravel.register.reg"><code class="xref py py-mod docutils literal notranslate"><span class="pre">unravel.register.reg</span></code></a></p>
<ul class="simple">
<li><p>Register an average template brain/atlas to a resampled autofluo brain.</p></li>
</ul>
<div class="note dropdown admonition">
<p class="admonition-title">Determining the 3 letter orientation code</p>
<ul class="simple">
<li><p>Letter options:</p>
<ul>
<li><p>A/P=Anterior/Posterior</p></li>
<li><p>L/R=Left/Right</p></li>
<li><p>S/I=Superior/Interior</p></li>
</ul>
</li>
<li><p>Letter order:</p>
<ul>
<li><p>The side of the brain at the positive direction of the x, y, and z axes determines the 3 letters</p></li>
<li><p>Letter 1: Side of the brain right of z-stack</p></li>
<li><p>Letter 2: Side of the brain facing bottom of z-stack</p></li>
<li><p>Letter 3: Side of the brain facing back of z-stack</p></li>
</ul>
</li>
</ul>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>reg<span class="w"> </span>-m<span class="w"> </span>&lt;path/template.nii.gz&gt;<span class="w"> </span>-bc<span class="w"> </span>-sm<span class="w"> </span><span class="m">0</span>.4<span class="w"> </span>-ort<span class="w"> </span>&lt;<span class="m">3</span><span class="w"> </span>letter<span class="w"> </span>orientation<span class="w"> </span>code&gt;<span class="w"> </span>-m2<span class="w"> </span>&lt;path/atlas_CCFv3_2020_30um.nii.gz&gt;<span class="w"> </span><span class="o">[</span>-d<span class="w"> </span><span class="nv">$DIRS</span><span class="o">]</span>

<span class="c1"># Example if using env_var.sh (assuming an RPS orientation):</span>
reg<span class="w"> </span>-m<span class="w"> </span><span class="nv">$TEMPLATE</span><span class="w"> </span>-bc<span class="w"> </span>-pad<span class="w"> </span>-sm<span class="w"> </span><span class="m">0</span>.4<span class="w"> </span>-ort<span class="w"> </span>RPS<span class="w"> </span>-a<span class="w"> </span><span class="nv">$ATLAS</span><span class="w"> </span>-d<span class="w"> </span><span class="nv">$DIRS</span>

<span class="c1"># -bc performs N4 bias field correction to make image intensities more uniform</span>
<span class="c1"># -sm smooths the autofluo image by the amount specified</span>
<span class="c1"># If you want to use an unmasked autofluo image, provide: -mas None -f reg_inputs/autofl_50um.nii.gz. Other commands alos assume that a masked autofluo image was used, so check each help guide for default arguments.</span>
</pre></div>
</div>
<div class="tip dropdown admonition">
<p class="admonition-title">If sample orientations vary</p>
<p>Make a ./sample??/parameters/ort.txt with the 3 letter orientation for each sample and run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span>d<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nv">$DIRS</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span><span class="nv">$d</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>s<span class="w"> </span><span class="k">in</span><span class="w"> </span>sample??<span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span>reg<span class="w"> </span>-m<span class="w"> </span><span class="nv">$TEMPLATE</span><span class="w"> </span>-bc<span class="w"> </span>-pad<span class="w"> </span>-sm<span class="w"> </span><span class="m">0</span>.4<span class="w"> </span>-ort<span class="w"> </span><span class="k">$(</span>cat<span class="w"> </span><span class="nv">$s</span>/parameters/ort.txt<span class="k">)</span><span class="w"> </span>-a<span class="w"> </span><span class="nv">$ATLAS</span><span class="w"> </span>-v<span class="w"> </span>-d<span class="w"> </span><span class="nv">$PWD</span>/<span class="nv">$s</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">done</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">done</span><span class="w"> </span>
</pre></div>
</div>
</div>
</section>
<section id="reg-check">
<h3><code class="docutils literal notranslate"><span class="pre">reg_check</span></code><a class="headerlink" href="#reg-check" title="Link to this heading">#</a></h3>
<p><a class="reference internal" href="unravel/register/reg_check.html#module-unravel.register.reg_check" title="unravel.register.reg_check"><code class="xref py py-mod docutils literal notranslate"><span class="pre">unravel.register.reg_check</span></code></a></p>
<ul class="simple">
<li><p>Check registration by copying these images from each sample??/reg_ouputs folder to a target directory:</p>
<ul>
<li><p>autofl_??um_masked_fixed_reg_input.nii.gz</p></li>
<li><p>atlas_in_tissue_space.nii.gz</p></li>
</ul>
</li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>reg_check<span class="w"> </span><span class="o">[</span>-td<span class="w"> </span>reg_results<span class="o">]</span><span class="w"> </span><span class="o">[</span>-d<span class="w"> </span><span class="nv">$DIRS</span><span class="o">]</span><span class="w">  </span><span class="c1"># Default for -td: copy images to the current dir.</span>
<span class="c1"># The default warped atlas from reg is atlas_CCFv3_2020_30um_in_tissue_space.nii.gz (in ./sample??/.reg_outputs). Use -wa &lt;image_name.nii.gz&gt; to set this.</span>
</pre></div>
</div>
<ul class="simple">
<li><p>View these images with <a class="reference external" href="https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/FSLeyes">FSLeyes</a> <a class="reference external" href="https://open.win.ox.ac.uk/pages/fsl/fsleyes/fsleyes/userdoc/index.html">docs</a></p></li>
<li><p>FSLeyes might not work in Windows without additional set up: <a class="reference external" href="https://fsl.fmrib.ox.ac.uk/fsl/docs/#/install/windows">Installation on Windows</a></p></li>
</ul>
<div class="note admonition">
<p class="admonition-title">Checking registration with FSLeyes</p>
<figure class="align-center" id="id3">
<a class="reference internal image-reference" href="_images/FSLeyes_autofl_image_from_reg.jpg"><img alt="_images/FSLeyes_autofl_image_from_reg.jpg" src="_images/FSLeyes_autofl_image_from_reg.jpg" style="width: 100%;" />
</a>
<figcaption>
<p><span class="caption-text">Use FSLeyes to view the autofluo image from <code class="docutils literal notranslate"><span class="pre">reg</span></code> (sample??/reg_ouputs/autofl_50um_masked_fixed_reg_input.nii.gz).</span><a class="headerlink" href="#id3" title="Link to this image">#</a></p>
</figcaption>
</figure>
<figure class="align-center" id="id4">
<a class="reference internal image-reference" href="_images/FSLeyes_atlas_warped_to_tissue_from_reg.jpg"><img alt="_images/FSLeyes_atlas_warped_to_tissue_from_reg.jpg" src="_images/FSLeyes_atlas_warped_to_tissue_from_reg.jpg" style="width: 100%;" />
</a>
<figcaption>
<p><span class="caption-text">Use FSLeyes to view the atlas warped to the the tissue (sample??/reg_ouputs/atlas_CCFv3_2020_30um_in_tissue_space.nii.gz)</span><a class="headerlink" href="#id4" title="Link to this image">#</a></p>
</figcaption>
</figure>
</div>
<div class="note admonition">
<p class="admonition-title">Setting up Allen brain atlas coloring in FSLeyes</p>
<ul class="simple">
<li><p>Add <code class="docutils literal notranslate"><span class="pre">UNRAVEL/_other/fsleyes_luts/ccfv3_2020.lut</span></code> to the following location:</p>
<ul>
<li><p><strong>Linux</strong>: <code class="docutils literal notranslate"><span class="pre">/home/&lt;your_username&gt;/.config/fsleyes/luts/ccfv3_2020.lut</span></code></p></li>
<li><p><strong>MacOS</strong>: <code class="docutils literal notranslate"><span class="pre">/usr/local/fsl/fslpython/envs/fslpython/lib/python3.8/site-packages/fsleyes/assets/luts/ccfv3_2020.lut</span></code></p></li>
<li><p><strong>Windows</strong>: <code class="docutils literal notranslate"><span class="pre">C:\Users\&lt;your_username&gt;\AppData\Roaming\fsleyes\luts\ccfv3_2020.lut</span></code></p></li>
</ul>
</li>
<li><p>On <strong>MacOS</strong>, run the following command to add write permissions to the LUT folder:</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>chmod<span class="w"> </span>a+w<span class="w"> </span>/usr/local/fsl/fslpython/envs/fslpython/lib/python3.8/site-packages/fsleyes/assets/luts
</pre></div>
</div>
<ul class="simple">
<li><p>On <strong>MacOS</strong>, edit <code class="docutils literal notranslate"><span class="pre">order.txt</span></code> to include <code class="docutils literal notranslate"><span class="pre">ccfv3_2020.lut</span></code>.</p></li>
<li><p>To remove other LUTs, move them up a directory level, but keep <code class="docutils literal notranslate"><span class="pre">random.lut</span></code> in place.</p></li>
<li><p>Open <code class="docutils literal notranslate"><span class="pre">atlas_CCFv3_2020_30um.nii.gz</span></code> in FSLeyes.</p></li>
<li><p>Select the atlas and change “3D/4D volume” to “Label image.”</p></li>
<li><p>Switch the lookup table from <code class="docutils literal notranslate"><span class="pre">random</span></code> to <code class="docutils literal notranslate"><span class="pre">ccfv3_2020</span></code>.</p></li>
<li><p>Click the circle icon at the top to convert the atlas to a wireframe view.</p></li>
<li><p>If you don’t want to select the LUT every time, make a copy of <code class="docutils literal notranslate"><span class="pre">random.lut</span></code> and replace its contents with those of <code class="docutils literal notranslate"><span class="pre">ccfv3_2020.lut</span></code>.</p></li>
</ul>
</div>
<hr class="docutils" />
<br>
</section>
</section>
<section id="voxel-wise-statistics">
<h2>Voxel-wise Statistics<a class="headerlink" href="#voxel-wise-statistics" title="Link to this heading">#</a></h2>
<div class="mermaid">
            flowchart TD
    A(((LSFM))) 
    A --&gt; B[Stitch z-stacks if required]
    B --&gt; C(vstats_prep: Optionally remove autofluorescence and warp immunofluo images to atlas space)
    C --&gt; D(vstats_z_score: Optionally z-score IF images from each brain individually)
    D --&gt; E(utils_agg_files: Aggregate atlas-space IF images from all sample folders into the current directory)
    E --&gt; F(vstats_whole_to_avg: Optionally smooth image and average left/right sides)
    F --&gt; G(Check inputs for vstats: Open IF images and the atlas in FSLeyes to confirm aligment with the atlas and other IF images)
    G --&gt; H(Prep inputs for vstats: Add IF images to the current directory, without other .nii.gz files)
    H --&gt; I(utils_prepend: Prepend a one-word condition to each IF image)
    I --&gt; J(For ANOVA designs, run fsl and set up the design. If two groups are present, proceed to the next step)
    J --&gt; K(vstats: Run voxel-wise analyses using FSL's randomise tool)
    K --&gt; L(View 1-p value maps in FSLeyes and consult 'Cluster-wise stats' for multiple comparisons correction and cluster validation)
        </div><section id="vstats-prep">
<h3><code class="docutils literal notranslate"><span class="pre">vstats_prep</span></code><a class="headerlink" href="#vstats-prep" title="Link to this heading">#</a></h3>
<p><a class="reference internal" href="unravel/voxel_stats/vstats_prep.html#module-unravel.voxel_stats.vstats_prep" title="unravel.voxel_stats.vstats_prep"><code class="xref py py-mod docutils literal notranslate"><span class="pre">unravel.voxel_stats.vstats_prep</span></code></a></p>
<ul class="simple">
<li><p>Preprocess immunofluo images and warp them to atlas space for voxel-wise statistics.</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example with rolling ball background subtration (pixel radius of 4):</span>
vstats_prep<span class="w"> </span>-i<span class="w"> </span>cfos<span class="w"> </span>-o<span class="w"> </span>cFos_rb4_atlas_space.nii.gz<span class="w"> </span>-rb<span class="w"> </span><span class="m">4</span><span class="w"> </span>-a<span class="w"> </span><span class="nv">$ATLAS</span><span class="w"> </span><span class="o">[</span>-d<span class="w"> </span><span class="nv">$DIRS</span><span class="o">]</span>

<span class="c1"># Usage:</span>
vstats_prep<span class="w"> </span>-i<span class="w"> </span>&lt;rel_path/image&gt;<span class="w"> </span>-o<span class="w"> </span>cFos_rb4_atlas_space.nii.gz<span class="w"> </span>-a<span class="w"> </span><span class="nv">$ATLAS</span><span class="w"> </span><span class="o">[</span>-sa<span class="w"> </span><span class="m">3</span><span class="o">]</span><span class="w"> </span><span class="o">[</span>-rb<span class="w"> </span><span class="m">4</span><span class="o">]</span><span class="w"> </span><span class="o">[</span>--channel<span class="w"> </span><span class="m">1</span><span class="o">]</span><span class="w"> </span><span class="o">[</span>-d<span class="w"> </span><span class="nv">$DIRS</span><span class="o">]</span>
<span class="c1"># --channel is for .czi images (1 is the second channel)</span>
</pre></div>
</div>
<div class="tip dropdown admonition">
<p class="admonition-title">Info on background subtraction</p>
<ul class="simple">
<li><p>Removing autofluorescence from immunolabeling improves the sensitivity of voxel-wise comparisons.</p></li>
<li><p>Use -sa 3 for 3x3x3 spatial averaging if there is notable noise from voxel to voxel.</p></li>
<li><p>Use -rb for rolling ball background subtraction.</p></li>
<li><p>Use a smaller rolling ball radius if you want to preserve punctate signal like c-Fos+ nuclei (e.g., 4)</p></li>
<li><p>Use a larger rolling ball radius if you want to preserve more diffuse signal (e.g., 20).</p></li>
<li><p>The radius should be similar to the largest feature that you want to preserve.</p></li>
</ul>
<p>You can test parameters for background subtraction with:</p>
<ul class="simple">
<li><p><a class="reference internal" href="unravel/image_tools/spatial_averaging.html#module-unravel.image_tools.spatial_averaging" title="unravel.image_tools.spatial_averaging"><code class="xref py py-mod docutils literal notranslate"><span class="pre">unravel.image_tools.spatial_averaging</span></code></a></p></li>
<li><p><a class="reference internal" href="unravel/image_tools/rb.html#module-unravel.image_tools.rb" title="unravel.image_tools.rb"><code class="xref py py-mod docutils literal notranslate"><span class="pre">unravel.image_tools.rb</span></code></a></p>
<ul>
<li><p>Copy a tif to a test dir for this (e.g., with <code class="docutils literal notranslate"><span class="pre">seg_copy_tifs</span></code>)</p></li>
<li><p>Use <a class="reference internal" href="unravel/image_io/io_img.html#module-unravel.image_io.io_img" title="unravel.image_io.io_img"><code class="xref py py-mod docutils literal notranslate"><span class="pre">unravel.image_io.io_img</span></code></a> to create a tif series</p></li>
</ul>
</li>
</ul>
</div>
<figure class="align-center" id="id5">
<a class="reference internal image-reference" href="_images/FSLeyes_Ai14_image_in_CCFv3_30um_space.jpg"><img alt="_images/FSLeyes_Ai14_image_in_CCFv3_30um_space.jpg" src="_images/FSLeyes_Ai14_image_in_CCFv3_30um_space.jpg" style="width: 100%;" />
</a>
<figcaption>
<p><span class="caption-text">Use FSLeyes to view the fluorescently labeled image in atlas space.</span><a class="headerlink" href="#id5" title="Link to this image">#</a></p>
</figcaption>
</figure>
</section>
<section id="vstats-z-score">
<h3><code class="docutils literal notranslate"><span class="pre">vstats_z_score</span></code><a class="headerlink" href="#vstats-z-score" title="Link to this heading">#</a></h3>
<p><a class="reference internal" href="unravel/voxel_stats/z_score.html#module-unravel.voxel_stats.z_score" title="unravel.voxel_stats.z_score"><code class="xref py py-mod docutils literal notranslate"><span class="pre">unravel.voxel_stats.z_score</span></code></a></p>
<ul class="simple">
<li><p>Z-score atlas space images using tissue masks (from brain_mask) and/or an atlas mask.</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Z-scoring using the brain mask (-i and -tmas paths are relative to the sample?? folder)</span>
vstats_z_score<span class="w"> </span>-i<span class="w"> </span>atlas_space/sample??_cFos_rb4_atlas_space.nii.gz<span class="w"> </span><span class="o">[</span>-d<span class="w"> </span><span class="nv">$DIRS</span><span class="o">]</span><span class="w"> </span>

<span class="c1"># Z-scoring using an atlas mask</span>
vstats_z_score<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;atlas_space/*.nii.gz&#39;</span><span class="w"> </span>-amas<span class="w"> </span><span class="nv">$MASK</span><span class="w"> </span><span class="o">[</span>-d<span class="w"> </span><span class="nv">$DIRS</span><span class="o">]</span><span class="w"> </span>

<span class="c1"># Using a tissue mask and an atlas mask</span>
vstats_z_score<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;atlas_space/*.nii.gz&#39;</span><span class="w"> </span>-tmas<span class="w"> </span>reg_inputs/autofl_50um_brain_mask.nii.gz<span class="w"> </span>-amas<span class="w"> </span><span class="nv">$MASK</span><span class="w"> </span><span class="o">[</span>-d<span class="w"> </span><span class="nv">$DIRS</span><span class="o">]</span><span class="w"> </span>
</pre></div>
</div>
</section>
<section id="utils-agg-files">
<h3><code class="docutils literal notranslate"><span class="pre">utils_agg_files</span></code><a class="headerlink" href="#utils-agg-files" title="Link to this heading">#</a></h3>
<p><a class="reference internal" href="unravel/utilities/aggregate_files_from_sample_dirs.html#module-unravel.utilities.aggregate_files_from_sample_dirs" title="unravel.utilities.aggregate_files_from_sample_dirs"><code class="xref py py-mod docutils literal notranslate"><span class="pre">unravel.utilities.aggregate_files_from_sample_dirs</span></code></a></p>
<ul class="simple">
<li><p>Aggregate pre-processed immunofluorescence (IF) images for voxel-wise stats</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>utils_agg_files<span class="w"> </span>-i<span class="w"> </span>atlas_space/*_cFos_rb4_atlas_space_z.nii.gz<span class="w"> </span><span class="o">[</span>-td<span class="w"> </span>path/target_dir<span class="o">]</span><span class="w"> </span><span class="o">[</span>-d<span class="w"> </span><span class="nv">$DIRS</span><span class="o">]</span>
</pre></div>
</div>
</section>
<section id="vstats-whole-to-avg">
<h3><code class="docutils literal notranslate"><span class="pre">vstats_whole_to_avg</span></code><a class="headerlink" href="#vstats-whole-to-avg" title="Link to this heading">#</a></h3>
<p><a class="reference internal" href="unravel/voxel_stats/whole_to_LR_avg.html#module-unravel.voxel_stats.whole_to_LR_avg" title="unravel.voxel_stats.whole_to_LR_avg"><code class="xref py py-mod docutils literal notranslate"><span class="pre">unravel.voxel_stats.whole_to_LR_avg</span></code></a></p>
<ul class="simple">
<li><p>Smooth and average left and right hemispheres together</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run this in the folder with the .nii.gz images to process</span>
vstats_whole_to_avg<span class="w"> </span>-k<span class="w"> </span><span class="m">0</span>.1<span class="w"> </span>--parallel<span class="w"> </span>-v<span class="w">  </span><span class="c1"># A 0.05 mm - 0.1 mm kernel radius is recommended for smoothing</span>

<span class="c1"># Process all *.nii.gz files in the current directory with no smoothing:</span>
vstats_whole_to_avg<span class="w"> </span><span class="o">[</span>-tp<span class="o">]</span><span class="w"> </span><span class="o">[</span>-amas<span class="w"> </span><span class="nv">$MASK</span><span class="o">]</span><span class="w"> </span><span class="c1"># Provide -tp for parallel processing.</span>

<span class="c1"># Process files matching the pattern with smoothing:</span>
vstats_whole_to_avg<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;*_cFos_rb4_atlas_space_z.nii.gz.nii.gz&#39;</span><span class="w"> </span>-k<span class="w"> </span><span class="m">0</span>.1<span class="w"> </span><span class="o">[</span>-tp<span class="o">]</span><span class="w"> </span><span class="o">[</span>-amas<span class="w"> </span><span class="nv">$MASK</span><span class="o">]</span>
<span class="c1"># A 0.1 mm kernel radius is recommended for smoothing (-k)</span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="unravel/voxel_stats/hemi_to_LR_avg.html#module-unravel.voxel_stats.hemi_to_LR_avg" title="unravel.voxel_stats.hemi_to_LR_avg"><code class="xref py py-mod docutils literal notranslate"><span class="pre">unravel.voxel_stats.hemi_to_LR_avg</span></code></a></p>
</div>
<div class="note admonition">
<p class="admonition-title">Setting up voxel-wise stats</p>
<ol class="arabic simple">
<li><p><strong>Create a vstats folder and subfolders for each analysis</strong>:</p>
<ul class="simple">
<li><p>Name subfolders succinctly (this name is added to other folder and file names).</p></li>
</ul>
</li>
<li><p><strong>Generate and add .nii.gz files to vstats subfolders</strong>:</p>
<ul class="simple">
<li><p>Input images are from <code class="docutils literal notranslate"><span class="pre">vstats_prep</span></code> and may have been z-scored with <code class="docutils literal notranslate"><span class="pre">vstats_z_score</span></code> (we z-score c-Fos labeling as intensities are not extreme)</p></li>
<li><p>For bilateral data, left and right sides can be averaged with <code class="docutils literal notranslate"><span class="pre">vstats_whole_to_avg</span></code> (then use a unilateral hemisphere mask for <code class="docutils literal notranslate"><span class="pre">vstats</span></code> and <code class="docutils literal notranslate"><span class="pre">cstats_fdr</span></code>).</p></li>
<li><p>We smooth data (e.g., with a 100 µm kernel) to account for innacuracies in registration</p>
<ul>
<li><p>This can be performed with <code class="docutils literal notranslate"><span class="pre">vstats_whole_to_avg</span></code> or <code class="docutils literal notranslate"><span class="pre">vstats</span></code></p></li>
</ul>
</li>
<li><p>Prepend filenames with a one word condition (e.g., <code class="docutils literal notranslate"><span class="pre">drug_sample01_atlas_space_z.nii.gz</span></code>).</p>
<ul>
<li><p>Camel case is ok for the condition.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">utils_prepend</span></code> can add conditions to filenames.</p></li>
<li><p>Group order is alphabetical (e.g., drug is group 1 and saline is group 2).</p></li>
</ul>
</li>
<li><p>View the images in <a class="reference external" href="https://open.win.ox.ac.uk/pages/fsl/fsleyes/fsleyes/userdoc/index.html">FSLeyes</a> to ensure they are aligned with the atlas and the sides are correct.</p></li>
<li><p>Other .nii.gz images unrelated to voxel-wise analyses should be excluded from the vstats subfolder.</p></li>
</ul>
</li>
<li><p><strong>Determine Analysis Type</strong>:</p>
<ul class="simple">
<li><p>If there are 2 groups, <code class="docutils literal notranslate"><span class="pre">vstats</span></code> may be used after pre-processing.</p></li>
<li><p>If there are more than 2 groups, prepare for an ANOVA as described below</p></li>
</ul>
</li>
</ol>
<h3 class="rubric" id="vstats-outputs"><code class="docutils literal notranslate"><span class="pre">vstats</span></code> Outputs</h3>
<ul class="simple">
<li><p><strong>T-test outputs</strong>:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">vox_p_tstat1.nii.gz</span></code>: Uncorrected p-values for tstat1 (group 1 &gt; group 2).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">vox_p_tstat2.nii.gz</span></code>: Uncorrected p-values for tstat2 (group 1 &lt; group 2).</p></li>
</ul>
</li>
<li><p><strong>ANOVA outputs</strong>:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">vox_p_fstat1.nii.gz</span></code>: Uncorrected p-values for fstat1 (1st contrast, e.g., drug vs. saline).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">vox_p_fstat2.nii.gz</span></code>: Uncorrected p-values for fstat2 (2nd contrast, e.g., context1 vs. context2).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">vox_p_fstat3.nii.gz</span></code>: Uncorrected p-values for fstat3 (3rd contrast, e.g., interaction).</p></li>
</ul>
</li>
</ul>
<h3 class="rubric" id="example-preparing-for-an-anova">Example: Preparing for an ANOVA</h3>
<ol class="arabic simple">
<li><p><strong>Setup Design Matrix</strong>:</p>
<ul class="simple">
<li><p>For an ANOVA, create <code class="docutils literal notranslate"><span class="pre">./vstats/vstats_dir/stats/design/</span></code>.</p></li>
<li><p>Open terminal from <code class="docutils literal notranslate"><span class="pre">./stats</span></code> and run: <code class="docutils literal notranslate"><span class="pre">fsl</span></code>.</p></li>
<li><p>Navigate to <code class="docutils literal notranslate"><span class="pre">Misc</span> <span class="pre">-&gt;</span> <span class="pre">GLM</span> <span class="pre">Setup</span></code>.</p></li>
</ul>
</li>
<li><p><strong>GLM Setup Window</strong>:</p>
<ul class="simple">
<li><p>Select <code class="docutils literal notranslate"><span class="pre">Higher-level</span> <span class="pre">/</span> <span class="pre">non-timeseries</span> <span class="pre">design</span></code>.</p></li>
<li><p>Set <code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">inputs</span></code> to the total number of samples.</p></li>
</ul>
</li>
<li><p><strong>EVs Tab in GLM Window</strong>:</p>
<ul class="simple">
<li><p>Set <code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">of</span> <span class="pre">main</span> <span class="pre">EVs</span></code> to 4.</p></li>
<li><p>Name EVs (e.g., <code class="docutils literal notranslate"><span class="pre">EV1</span> <span class="pre">=</span> <span class="pre">group</span> <span class="pre">1</span></code>).</p></li>
<li><p>Set Group to 1 for all.</p></li>
</ul>
</li>
<li><p><strong>Design Matrix</strong>:</p>
<ul class="simple">
<li><p>Under <code class="docutils literal notranslate"><span class="pre">EV1</span></code>, enter 1 for each subject in group 1 (1 row/subject). EV2-4 are 0 for these rows.</p></li>
<li><p>Under <code class="docutils literal notranslate"><span class="pre">EV2</span></code>, enter 1 for each subject in group 2, starting with the row after the last row for group 1.</p></li>
<li><p>Follow this pattern for EV3 and EV4.</p></li>
</ul>
</li>
<li><p><strong>Contrasts &amp; F-tests Tab in GLM Window</strong>:</p>
<ul class="simple">
<li><p>Set <code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">of</span> <span class="pre">Contrasts</span></code> to 3 for a 2x2 ANOVA:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">C1</span></code>: <code class="docutils literal notranslate"><span class="pre">Main_effect_&lt;e.g.,drug&gt;</span></code> 1 1 -1 -1 (e.g., EV1/2 are drug groups and EV3/4 are saline groups).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">C2</span></code>: <code class="docutils literal notranslate"><span class="pre">Main_effect_&lt;e.g.,</span> <span class="pre">context&gt;</span></code> 1 -1 1 -1 (e.g., EV1/3 were in context1 and EV2/4 were in context2).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">C3</span></code>: <code class="docutils literal notranslate"><span class="pre">Interaction</span></code> 1 -1 -1 1.</p></li>
</ul>
</li>
<li><p>Set <code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">of</span> <span class="pre">F-tests</span></code> to 3:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">F1</span></code>: Click upper left box.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">F2</span></code>: Click middle box.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">F3</span></code>: Click lower right box.</p></li>
</ul>
</li>
</ul>
</li>
<li><p><strong>Finalize GLM Setup</strong>:</p>
<ul class="simple">
<li><p>In the GLM Setup window, click <code class="docutils literal notranslate"><span class="pre">Save</span></code>, then click <code class="docutils literal notranslate"><span class="pre">design</span></code>, and click <code class="docutils literal notranslate"><span class="pre">OK</span></code>.</p></li>
</ul>
</li>
<li><p><strong>Run Voxel-wise Stats</strong>:</p>
<ul class="simple">
<li><p>From the vstats_dir, run: <code class="docutils literal notranslate"><span class="pre">vstats</span></code>.</p></li>
</ul>
</li>
</ol>
<h3 class="rubric" id="background-on-fsl-s-randomise-tool">Background on FSL’s Randomise Tool</h3>
<ul class="simple">
<li><p><a class="reference external" href="https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/GLM">FSL GLM Guide</a></p></li>
<li><p><a class="reference external" href="https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/Randomise/UserGuide">FSL Randomise User Guide</a></p></li>
</ul>
</div>
</section>
<section id="vstats">
<h3><code class="docutils literal notranslate"><span class="pre">vstats</span></code><a class="headerlink" href="#vstats" title="Link to this heading">#</a></h3>
<p><a class="reference internal" href="unravel/voxel_stats/vstats.html#module-unravel.voxel_stats.vstats" title="unravel.voxel_stats.vstats"><code class="xref py py-mod docutils literal notranslate"><span class="pre">unravel.voxel_stats.vstats</span></code></a></p>
<ul class="simple">
<li><p>Run voxel-wise stats using FSL’s randomise_parallel command</p></li>
<li><p>Outputs saved in stats/</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run this in the folder with the input IF images (the current directory name will be prepended to outputs)</span>
vstats<span class="w"> </span>-mas<span class="w"> </span><span class="nv">$MASK</span><span class="w"> </span>-a<span class="w"> </span><span class="nv">$ATLAS</span><span class="w"> </span><span class="o">[</span>-p<span class="w"> </span><span class="m">18000</span><span class="o">]</span><span class="w"> </span><span class="o">[</span>-k<span class="w"> </span><span class="m">0</span>.1<span class="o">]</span>
<span class="c1"># -p sets the number of permutations.</span>
<span class="c1"># -k is for smoothing if inputs have not yet been smoothed (-k is the kernel size in mm)</span>
<span class="c1"># See the vstats help for providing additional arguments to FSL&#39;s randomise_parallel</span>
</pre></div>
</div>
<div class="note admonition">
<p class="admonition-title">Outputs from voxel-wise stats</p>
<ul class="simple">
<li><p>Outputs in ./stats/</p>
<ul>
<li><p>vox_p maps are uncorrected 1-p value maps</p></li>
<li><p>tstat1: group1 &gt; group2</p></li>
<li><p>tstat2: group2 &gt; group1</p></li>
<li><p>fstat*: f contrast w/ ANOVA design (non-directional p value maps)</p></li>
<li><p>fstat1 corresponds to the first Contrast defined in step 5 above.</p></li>
</ul>
</li>
</ul>
</div>
<hr class="docutils" />
<br>
</section>
</section>
<section id="cluster-wise-statistics">
<h2>Cluster-wise Statistics<a class="headerlink" href="#cluster-wise-statistics" title="Link to this heading">#</a></h2>
<div class="mermaid">
            flowchart TD
    A(vstats: Generates 1-p value maps with vox_p in the filename)
    A --&gt; B(cstats_fdr_range: Input a 1-p map to find FDR q values that yield clusters)
    B --&gt; C(cstats_fdr: Apply FDR correction on the 1-p map to identify clusters of significant voxels)
    C --&gt; D(cstats_mirror_indices: For whole-brains, recursively mirror cluster maps in ./stats/)
    D --&gt; E(seg_copy_tifs: Copy select full resolution TIFFs for Ilastik training)
    E --&gt; F(seg_ilastik: Perform pixel classification with a trained Ilastik project)
    F --&gt; G(cstats_validation: Warp clusters from atlas to full resolution tissue space, count cells, and calculate cluster volumes)
    G --&gt; H(cstats_summary: Aggregate and analyze cluster validation data)
        </div><section id="false-discovery-rate-fdr-correction">
<h3>False Discovery Rate (FDR) Correction<a class="headerlink" href="#false-discovery-rate-fdr-correction" title="Link to this heading">#</a></h3>
</section>
<section id="cstats-fdr-range">
<h3><code class="docutils literal notranslate"><span class="pre">cstats_fdr_range</span></code><a class="headerlink" href="#cstats-fdr-range" title="Link to this heading">#</a></h3>
<p><a class="reference internal" href="unravel/cluster_stats/fdr_range.html#module-unravel.cluster_stats.fdr_range" title="unravel.cluster_stats.fdr_range"><code class="xref py py-mod docutils literal notranslate"><span class="pre">unravel.cluster_stats.fdr_range</span></code></a></p>
<ul class="simple">
<li><p>Outputs a list of FDR q values that yield clusters.</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cstats_fdr_range<span class="w"> </span>-i<span class="w"> </span>&lt;path/vox_p_tstat1.nii.gz&gt;<span class="w"> </span>-mas<span class="w"> </span><span class="nv">$MASK</span>
</pre></div>
</div>
</section>
<section id="cstats-fdr">
<h3><code class="docutils literal notranslate"><span class="pre">cstats_fdr</span></code><a class="headerlink" href="#cstats-fdr" title="Link to this heading">#</a></h3>
<p><a class="reference internal" href="unravel/cluster_stats/fdr.html#module-unravel.cluster_stats.fdr" title="unravel.cluster_stats.fdr"><code class="xref py py-mod docutils literal notranslate"><span class="pre">unravel.cluster_stats.fdr</span></code></a></p>
<ul class="simple">
<li><p>Perform FDR correction on a 1-p value map to define clusters</p></li>
<li><p>Outputs are saved to a new folder in stats/ named after the input image and q value</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cstats_fdr<span class="w"> </span>-i<span class="w"> </span>&lt;path/vox_p_tstat1.nii.gz&gt;<span class="w"> </span>-mas<span class="w"> </span><span class="nv">$MASK</span><span class="w"> </span>-q<span class="w"> </span><span class="m">0</span>.05<span class="w"> </span><span class="m">0</span>.01<span class="w"> </span><span class="m">0</span>.001<span class="w"> </span><span class="o">[</span>-ms<span class="w"> </span><span class="m">100</span><span class="o">]</span><span class="w"> </span>
<span class="c1"># For -q, copy the output from cstats_fdr_range</span>
<span class="c1"># For -ms, set the number of voxels for a cluster (e.g., 100 for c-Fos or 400 if labeling is sparse)</span>

<span class="c1"># Perform FDR correction on multiple directional 1-p value maps</span>
<span class="k">for</span><span class="w"> </span>j<span class="w"> </span><span class="k">in</span><span class="w"> </span>*_vox_p_*.nii.gz<span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="nv">q_values</span><span class="o">=</span><span class="k">$(</span>cstats_fdr_range<span class="w"> </span>-mas<span class="w"> </span><span class="nv">$MASK</span><span class="w"> </span>-i<span class="w"> </span><span class="nv">$j</span><span class="k">)</span><span class="w"> </span><span class="p">;</span><span class="w"> </span>cstats_fdr<span class="w"> </span>-mas<span class="w"> </span><span class="nv">$MASK</span><span class="w"> </span>-i<span class="w"> </span><span class="nv">$j</span><span class="w"> </span>-q<span class="w"> </span><span class="nv">$q_values</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">done</span>

<span class="c1"># ANOVAs output non-directioanl 1-p value maps. Optionally convert them into a directional cluster index:</span>
<span class="nv">q_values</span><span class="o">=</span><span class="k">$(</span>cstats_fdr_range<span class="w"> </span>-i<span class="w"> </span>vox_p_fstat1.nii.gz<span class="w"> </span>-mas<span class="w"> </span><span class="nv">$MASK</span><span class="k">)</span><span class="w"> </span><span class="p">;</span><span class="w"> </span>cstats_fdr<span class="w"> </span>-i<span class="w"> </span>vox_p_fstat1.nii.gz<span class="w"> </span>-mas<span class="w"> </span><span class="nv">$MASK</span><span class="w"> </span>-o<span class="w"> </span>fstat1<span class="w"> </span>-v<span class="w"> </span>-a1<span class="w"> </span>Control_avg.nii.gz<span class="w"> </span>-a2<span class="w"> </span>Deep_avg.nii.gz<span class="w"> </span>-q<span class="w"> </span><span class="nv">$q_values</span>
<span class="c1"># Make averaged images for each group (-a1 and -a2 args) with the img_avg command</span>
</pre></div>
</div>
</section>
<section id="cstats-mirror-indices">
<h3><code class="docutils literal notranslate"><span class="pre">cstats_mirror_indices</span></code><a class="headerlink" href="#cstats-mirror-indices" title="Link to this heading">#</a></h3>
<p><a class="reference internal" href="unravel/cluster_stats/recursively_mirror_rev_cluster_indices.html#module-unravel.cluster_stats.recursively_mirror_rev_cluster_indices" title="unravel.cluster_stats.recursively_mirror_rev_cluster_indices"><code class="xref py py-mod docutils literal notranslate"><span class="pre">unravel.cluster_stats.recursively_mirror_rev_cluster_indices</span></code></a></p>
<ul class="simple">
<li><p>Recursively flip the content of rev_cluster_index.nii.gz images (to validate w/ clusters in left and right hemispheres)</p></li>
<li><p>Run this in the ./stats/ folder to process all subdirs with reverse cluster maps (cluster IDs go from large to small)</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use -m RH if a right hemisphere mask was used (otherwise use -m LH)</span>
cstats_mirror_indices<span class="w"> </span>-m<span class="w"> </span>RH<span class="w"> </span><span class="o">[</span>-i<span class="w"> </span>glob_pattern<span class="o">]</span>
</pre></div>
</div>
<hr class="docutils" />
<br>
</section>
</section>
<section id="segmentation-of-full-resolution-fluorescence-images">
<h2>Segmentation of Full-Resolution Fluorescence Images<a class="headerlink" href="#segmentation-of-full-resolution-fluorescence-images" title="Link to this heading">#</a></h2>
<section id="id1">
<h3>1) <code class="docutils literal notranslate"><span class="pre">seg_copy_tifs</span></code><a class="headerlink" href="#id1" title="Link to this heading">#</a></h3>
<p><a class="reference internal" href="unravel/segment/copy_tifs.html#module-unravel.segment.copy_tifs" title="unravel.segment.copy_tifs"><code class="xref py py-mod docutils literal notranslate"><span class="pre">unravel.segment.copy_tifs</span></code></a></p>
<ul class="simple">
<li><p>Copy or extract full res tif files to a target dir for training Ilastik to segment labels of interest</p></li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Copy/extract 3 slices from each sample, with at least 3 samples per condition.</p>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>seg_copy_tifs<span class="w"> </span>-i<span class="w"> </span>&lt;rel_path/raw_image&gt;<span class="w"> </span>-s<span class="w"> </span><span class="m">0100</span><span class="w"> </span><span class="m">0500</span><span class="w"> </span><span class="m">1000</span><span class="w"> </span><span class="o">[</span>-td<span class="w"> </span>ilastik_segmentation<span class="o">]</span><span class="w"> </span><span class="o">[</span>-d<span class="w"> </span><span class="nv">$DIRS</span><span class="o">]</span>
<span class="c1"># Default for target dir (-td) is current dir</span>
<span class="c1"># The name of the dir with full-res tifs can be passed in for -i</span>
</pre></div>
</div>
</section>
<section id="train-ilastik-to-segment-c-fos-cells-or-other-features">
<h3>2) <a class="reference external" href="https://b-heifets.github.io/UNRAVEL/guide.html#training-ilastik">Train Ilastik</a> to segment c-Fos+ cells or other features<a class="headerlink" href="#train-ilastik-to-segment-c-fos-cells-or-other-features" title="Link to this heading">#</a></h3>
</section>
<section id="seg-ilastik">
<h3>3) <code class="docutils literal notranslate"><span class="pre">seg_ilastik</span></code><a class="headerlink" href="#seg-ilastik" title="Link to this heading">#</a></h3>
<p><a class="reference internal" href="unravel/segment/ilastik_pixel_classification.html#module-unravel.segment.ilastik_pixel_classification" title="unravel.segment.ilastik_pixel_classification"><code class="xref py py-mod docutils literal notranslate"><span class="pre">unravel.segment.ilastik_pixel_classification</span></code></a></p>
<ul class="simple">
<li><p>Segment features of interest (e.g., c-Fos+ cells) in full-resulution images using a trained Ilastik project (pixel classification)</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>seg_ilastik<span class="w"> </span>-ie<span class="w"> </span>&lt;path/ilastik_executable&gt;<span class="w"> </span>-ilp<span class="w"> </span>&lt;path/ilastik_project.ilp&gt;<span class="w"> </span>-i<span class="w"> </span>&lt;rel_path<span class="w"> </span>to<span class="w"> </span>tif_dir<span class="w"> </span>or<span class="w"> </span>image&gt;<span class="w"> </span>-o<span class="w"> </span>seg_dir<span class="w"> </span>--labels<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">[</span>--rm_out_tifs<span class="o">]</span><span class="w"> </span><span class="o">[</span>--channel<span class="w"> </span><span class="m">1</span><span class="o">]</span><span class="w"> </span><span class="o">[</span>-d<span class="w"> </span><span class="nv">$DIRS</span><span class="o">]</span>
<span class="c1"># --labels is a space-separated list of labels to convert into binary .nii.gz images.</span>
<span class="c1"># --channel is for .czi images (1 is the second channel)</span>
</pre></div>
</div>
<hr class="docutils" />
<br>
</section>
</section>
<section id="cluster-validation-and-statistics">
<h2>Cluster Validation and Statistics<a class="headerlink" href="#cluster-validation-and-statistics" title="Link to this heading">#</a></h2>
<div class="mermaid">
            flowchart TD    
    A(cstats_org_data: Organize cell/label density data from cluster validation)
    A --&gt; B(cstats_group_data: Pool left and right hemisphere data)
    B --&gt; C(utils_prepend: Prepend CSV names with conditions)
    C --&gt; D(cstats: Run statistics to determine cluster validity)
    D --&gt; E(cstats_index: Create valid cluster maps and CSVs for sunburst plots)
    E --&gt; F(cstats_brain_model: Create files for 3D brain models)
    F --&gt; G(cstats_table: Create tables summarizing top regions and volumes)
    G --&gt; H(cstats_prism: Generate CSVs for plotting bar graphs with Prism)
    H --&gt; I(cstats_legend: Create legend files defining region abbreviations)
    I --&gt; J(Summarize cluster validation rates, aggregate files for 3D brains, compile SI tables, etc.)
        </div><section id="cstats-validation">
<h3><code class="docutils literal notranslate"><span class="pre">cstats_validation</span></code><a class="headerlink" href="#cstats-validation" title="Link to this heading">#</a></h3>
<p><a class="reference internal" href="unravel/cluster_stats/validation.html#module-unravel.cluster_stats.validation" title="unravel.cluster_stats.validation"><code class="xref py py-mod docutils literal notranslate"><span class="pre">unravel.cluster_stats.validation</span></code></a></p>
<ul class="simple">
<li><p>Warps cluster index from atlas space to tissue space, crops clusters, applies segmentation mask, and quantifies cell or label densities</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Cell density measurements in all clusters</span>
cstats_validation<span class="w"> </span>-m<span class="w"> </span>&lt;path/rev_cluster_index_to_warp_from_atlas_space.nii.gz&gt;<span class="w"> </span>-s<span class="w">  </span>&lt;rel_path/seg_img.nii.gz&gt;<span class="w"> </span><span class="o">[</span>-d<span class="w"> </span><span class="nv">$DIRS</span><span class="o">]</span>

<span class="c1"># Label density measurements in select clusters</span>
cstats_validation<span class="w"> </span>-m<span class="w"> </span>&lt;path/rev_cluster_index_to_warp_from_atlas_space.nii.gz&gt;<span class="w"> </span>-s<span class="w">  </span>&lt;rel_path/seg_img.nii.gz&gt;<span class="w"> </span>-de<span class="w"> </span>label_density<span class="w"> </span>-c<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="o">[</span>-d<span class="w"> </span><span class="nv">$DIRS</span><span class="o">]</span>

<span class="c1"># Use -n to save the cluster map in tissue space (-n rel_path/native_cluster_index.zarr). Slower than w/o saving.</span>
<span class="c1"># -inp nearestNeighbor is default, but for smoother clusters use multiLabel (slower)</span>

<span class="c1"># Processing multiple FDR q value thresholds and both hemispheres (assumes that cstats_mirror_indices has been run):</span>
<span class="k">for</span><span class="w"> </span>q<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.005<span class="w"> </span><span class="m">0</span>.01<span class="w"> </span><span class="m">0</span>.05<span class="w"> </span><span class="m">0</span>.1<span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>side<span class="w"> </span><span class="k">in</span><span class="w"> </span>LH<span class="w"> </span>RH<span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span>cstats_validation<span class="w">  </span>-m<span class="w"> </span>path/vstats/contrast/stats/contrast_vox_p_tstat1_q<span class="si">${</span><span class="nv">q</span><span class="si">}</span>/contrast_vox_p_tstat1_q<span class="si">${</span><span class="nv">q</span><span class="si">}</span>_rev_cluster_index_<span class="si">${</span><span class="nv">side</span><span class="si">}</span>.nii.gz<span class="w"> </span>-s<span class="w"> </span>rel_path/seg_img.nii.gz<span class="w"> </span><span class="o">[</span>-d<span class="w"> </span><span class="nv">$DIRS</span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">done</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">done</span>
</pre></div>
</div>
</section>
<section id="cstats-summary">
<h3><code class="docutils literal notranslate"><span class="pre">cstats_summary</span></code><a class="headerlink" href="#cstats-summary" title="Link to this heading">#</a></h3>
<p><a class="reference internal" href="unravel/cluster_stats/summary.html#module-unravel.cluster_stats.summary" title="unravel.cluster_stats.summary"><code class="xref py py-mod docutils literal notranslate"><span class="pre">unravel.cluster_stats.summary</span></code></a></p>
<ul class="simple">
<li><p>Aggregates and analyzes cluster validation data from <code class="docutils literal notranslate"><span class="pre">cstats_validation</span></code></p></li>
<li><p>Update parameters in /UNRAVEL/unravel/cstats/cluster_summary.ini and save it with the experiment</p></li>
<li><p>group1 and group2 must match conditions in the sample_key.csv</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Usage if running directly after ``cstats_validation``</span>
cstats_summary<span class="w"> </span>-c<span class="w"> </span>&lt;path/cluster_summary.ini&gt;<span class="w"> </span>-cvd<span class="w"> </span><span class="s1">&#39;psilocybin_v_saline_tstat1_q*&#39;</span><span class="w"> </span>-vd<span class="w"> </span>&lt;path/vstats_dir&gt;<span class="w"> </span>-sk<span class="w"> </span><span class="nv">$SAMPLE_KEY</span><span class="w"> </span>--groups<span class="w"> </span>&lt;group1&gt;<span class="w"> </span>&lt;group2&gt;<span class="w"> </span>-hg<span class="w"> </span>&lt;higher_group&gt;<span class="w"> </span><span class="o">[</span>-d<span class="w"> </span><span class="nv">$DIRS</span><span class="o">]</span>

<span class="c1"># Usage if running after ``cstats_validation`` and ``cstats_org_data``:</span>
cstats_summary<span class="w"> </span>-c<span class="w"> </span>&lt;path/cluster_summary.ini&gt;<span class="w"> </span>-sk<span class="w"> </span><span class="nv">$SAMPLE_KEY</span><span class="w">  </span>--groups<span class="w"> </span>&lt;group1&gt;<span class="w"> </span>&lt;group2&gt;<span class="w"> </span>-hg<span class="w"> </span>&lt;higher_group&gt;<span class="w"> </span><span class="o">[</span>-d<span class="w"> </span><span class="nv">$DIRS</span><span class="o">]</span>

<span class="c1"># See the help guide for cstats_validation if you want to pool data using condition prefixes</span>
</pre></div>
</div>
<hr class="docutils" />
<br>
</section>
</section>
<section id="sunburst-plots">
<h2>Sunburst Plots<a class="headerlink" href="#sunburst-plots" title="Link to this heading">#</a></h2>
<div class="note admonition">
<p class="admonition-title">Sunburst plots of regional volumes</p>
<ul class="simple">
<li><p>CSVs for making sunburst plots are output by <code class="docutils literal notranslate"><span class="pre">cstats_validation</span></code> for each valid cluster map.</p></li>
<li><p>Output location: main_experiment_dir/cstats/&lt;vstats_contrast&gt;_q<FDR q value>/_valid_clusters/valid_clusters_sunburst.csv</p></li>
<li><p>Or sunburst CSVs can be generated using <code class="docutils literal notranslate"><span class="pre">cstats_sunburst</span></code></p></li>
<li><p>Sunburst CSVs can be copy and pasted into the sunburst plot tool of the <a class="reference external" href="https://app.flourish.studio/login">Flourish web app</a></p></li>
</ul>
<figure class="align-center">
<a class="reference internal image-reference" href="_images/sunburst_1_flourish.jpg"><img alt="_images/sunburst_1_flourish.jpg" src="_images/sunburst_1_flourish.jpg" style="width: 50%;" />
</a>
</figure>
<ul class="simple">
<li><p>Make a free account w/ Flourish.</p></li>
<li><p>Login.</p></li>
<li><p>Select “New visualization”.</p></li>
</ul>
<figure class="align-center" id="id6">
<a class="reference internal image-reference" href="_images/sunburst_2_plot_types.jpg"><img alt="_images/sunburst_2_plot_types.jpg" src="_images/sunburst_2_plot_types.jpg" style="width: 50%;" />
</a>
<figcaption>
<p><span class="caption-text">Under “Hierarchy” select “Sunburst”</span><a class="headerlink" href="#id6" title="Link to this image">#</a></p>
</figcaption>
</figure>
<figure class="align-center">
<a class="reference internal image-reference" href="_images/sunburst_3_adding_data.jpg"><img alt="_images/sunburst_3_adding_data.jpg" src="_images/sunburst_3_adding_data.jpg" style="width: 100%;" />
</a>
</figure>
<ul class="simple">
<li><p>Select the “Data” tab.</p></li>
<li><p>Set it up like this with columns A-K. Categories/nesting: B-J, Size by: K.</p></li>
<li><p>Always delete the entirety of the columns before pasting in values.</p></li>
<li><p>Paste in values for columns A-K from a *_sunburst.csv.</p></li>
<li><p>Switch to the “Preview” tab to view the plot.</p></li>
</ul>
<figure class="align-center">
<a class="reference internal image-reference" href="_images/sunburst_4_RGB_values.jpg"><img alt="_images/sunburst_4_RGB_values.jpg" src="_images/sunburst_4_RGB_values.jpg" style="width: 30%;" />
</a>
</figure>
<ul class="simple">
<li><p>Paste the contents of sunburst_RGBs.csv into Colors –&gt; Custom overrides.</p></li>
<li><p>Location: UNRAVEL/unravel/core/csvs/sunburst_RGBs.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cstats_sunburst</span></code> can output it w/ <code class="docutils literal notranslate"><span class="pre">-rgb</span></code>.</p></li>
<li><p>Set Min font size under “Labels” to 0.5 to show labels.</p></li>
<li><p>Increase Min font size above the Max size to hide them.</p></li>
<li><p>Take a screenshot of the plot to save it.</p></li>
</ul>
</div>
<hr class="docutils" />
<br>
</section>
<section id="d-brain-models">
<h2>3D Brain Models<a class="headerlink" href="#d-brain-models" title="Link to this heading">#</a></h2>
<div class="note admonition">
<p class="admonition-title">Visualize cluster maps, etc. in a 3D brain</p>
<ul class="simple">
<li><p>Files for making 3D brains in DSI Studio are output by <code class="docutils literal notranslate"><span class="pre">cstats_validation</span></code> for each valid cluster map.</p></li>
<li><p>Output location: main_experiment_dir/cstats/3D_brains/</p></li>
<li><p>Alternate location: main_experiment_dir/cstats/<contrast>_q<q value>/_valid_clusters/</p></li>
<li><p>Output image: <contrast>_q<q value>_rev_cluster_index__valid_clusters_ABA_WB.nii.gz</p></li>
<li><p>Output look up table: <contrast>_q<q value>_rev_cluster_index__valid_clusters_rgba.txt</p></li>
<li><p>These files can be generated with <code class="docutils literal notranslate"><span class="pre">cstats_brain_model</span></code> (use -m for a bilateral representation of a unilateral map)</p></li>
</ul>
<h3 class="rubric" id="visualization-in-dsi-studio">Visualization in DSI Studio</h3>
<ul class="simple">
<li><p>Open DSI studio</p></li>
<li><p>Click on “Step T3”</p></li>
<li><p>Change the drop down to select all files and select the binary atlas (mask_CCFv3_2020_30um.nii.gz)</p></li>
<li><p>If you open the binary atlas in the 3D_brains folder, it is easier to open other files from there later</p></li>
<li><p>Make it visible: Slices –&gt; Add Isosurface –&gt; Full –&gt; OK –&gt; Zoom out (mouse wheel or 2 finger scroll)</p></li>
</ul>
<h4 class="rubric" id="display-settings">Display settings</h4>
<figure class="align-center">
<a class="reference internal image-reference" href="_images/brain_model_settings_1.jpg"><img alt="_images/brain_model_settings_1.jpg" src="_images/brain_model_settings_1.jpg" style="width: 50%;" />
</a>
</figure>
<figure class="align-center">
<a class="reference internal image-reference" href="_images/brain_model_settings_2.jpg"><img alt="_images/brain_model_settings_2.jpg" src="_images/brain_model_settings_2.jpg" style="width: 50%;" />
</a>
</figure>
<h4 class="rubric" id="layout">Layout</h4>
<figure class="align-center">
<a class="reference internal image-reference" href="_images/brain_model_layout.jpg"><img alt="_images/brain_model_layout.jpg" src="_images/brain_model_layout.jpg" style="width: 100%;" />
</a>
</figure>
<ul class="simple">
<li><p>The zoom and viewer dimensions determine the output video size.</p></li>
<li><p>This layout allows for 1080p videos with my MacBook (adjust as needed).</p></li>
<li><p>Move panels on the right down and make them as small as possible.</p></li>
<li><p>Line up the left edge of the viewer with View.</p></li>
<li><p>Zoom to the view 0.28 (lower right of viewer)</p></li>
<li><p>Zoom out to 0.18 for axial.</p></li>
</ul>
<h4 class="rubric" id="adding-regions-and-color">Adding Regions and Color</h4>
<ul class="simple">
<li><p>Regions –&gt; Open Region… –&gt; load <contrast>_q<q value>_rev_cluster_index__valid_clusters_ABA_WB.nii.gz</p></li>
<li><p>Regions Misc –&gt; Load Region Color… –&gt; load <contrast>_q<q value>_rev_cluster_index__valid_clusters_rgba.txt</p></li>
</ul>
<h4 class="rubric" id="making-figures">Making Figures</h4>
<ul class="simple">
<li><p>Use <code class="docutils literal notranslate"><span class="pre">z</span></code>, <code class="docutils literal notranslate"><span class="pre">x</span></code>, and <code class="docutils literal notranslate"><span class="pre">c</span></code> to snap to specific orientations.</p></li>
<li><p>Use View –&gt; Save Camera View… to save an oblique orientation</p></li>
<li><p>Load it with: View –&gt; Open Camera View…</p></li>
<li><p>Capture screenshots</p></li>
</ul>
<h4 class="rubric" id="recording-videos">Recording Videos</h4>
<ul class="simple">
<li><p>For a video: press <code class="docutils literal notranslate"><span class="pre">z</span></code> for a sagittal orientation (e.g., facing to the right), View –&gt; Save Rotation Video/Images…</p></li>
<li><p>The output .avi is large, but can be exported in another format</p></li>
<li><p>For example, in Adobe Premiere Pro –&gt; add the video to the timeline –&gt; right click to double video speed –&gt; export with SD resolution (480p) –&gt; scale to fit –&gt; export.</p></li>
<li><p>Composite videos with multiple cluster maps can be made with Adobe Premiere Pro using the exported videos.</p></li>
</ul>
</div>
<hr class="docutils" />
<br>
</section>
<section id="valid-cluster-info-tables">
<h2>Valid Cluster Info Tables<a class="headerlink" href="#valid-cluster-info-tables" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Cluster info .xlsx tables are output by <code class="docutils literal notranslate"><span class="pre">cstats_validation</span></code> for each valid cluster map.</p></li>
<li><p>Output location: valid_clusters_tables_and_legend</p></li>
<li><p>Alternatively, they can be made with <code class="docutils literal notranslate"><span class="pre">cstats_table</span></code> and <code class="docutils literal notranslate"><span class="pre">cstats_legend</span></code></p></li>
<li><p>Compile each <contrast>_q<q value>_valid_clusters_table.xlsx and legend.xlsx into one .xlsx SI table</p></li>
<li><p><a class="reference external" href="https://static-content.springer.com/esm/art%3A10.1038%2Fs41386-023-01613-4/MediaObjects/41386_2023_1613_MOESM2_ESM.xlsx">Example SI Table</a> from our <a class="reference external" href="https://www.nature.com/articles/s41386-023-01613-4">initial UNRAVEL paper</a></p></li>
</ul>
<hr class="docutils" />
<br>
</section>
<section id="region-wise-statistics">
<h2>Region-wise Statistics<a class="headerlink" href="#region-wise-statistics" title="Link to this heading">#</a></h2>
<div class="mermaid">
            flowchart TD
    A(((LSFM))) 
    A --&gt; B[3D autofluorescence image]
    B --&gt; C(Registration to an average template brain) 
    C --&gt; D(Optional: warp_to_native: Warp the atlas to full-resolution tissue space and save as .zarr)
    A --&gt; E[3D immunofluorescence image]
    E --&gt; F(seg_copy_tifs &amp; seg_ilastik: Segment c-Fos+ cells using Ilastik)
    F --&gt; G(rstats: Perform regional cell counting and volume measurements)
    D --&gt; G
    G --&gt; H(utils_agg_files: Aggregate CSV outputs from rstats across all sample folders)
    H --&gt; I(rstats_summary: Plot cell densities by region and summarize results)
        </div><section id="rstats">
<h3><code class="docutils literal notranslate"><span class="pre">rstats</span></code><a class="headerlink" href="#rstats" title="Link to this heading">#</a></h3>
<p><code class="xref py py-mod docutils literal notranslate"><span class="pre">unravel.region_stats.regional_cell_densities</span></code></p>
<ul class="simple">
<li><p>Quantify regional cell densities or label densities</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Usage if the atlas is already in native space from ``warp_to_native``:</span>
rstats<span class="w"> </span>-s<span class="w"> </span>&lt;rel_path/segmentation_image.nii.gz&gt;<span class="w"> </span>-a<span class="w"> </span>&lt;rel_path/native_atlas_split.nii.gz&gt;<span class="w"> </span>-c<span class="w"> </span>Saline<span class="w"> </span>-t<span class="w"> </span>cell_densities<span class="w"> </span><span class="o">[</span>-d<span class="w"> </span>&lt;paths<span class="w"> </span>to<span class="w"> </span>sample<span class="w"> </span>folders<span class="w"> </span><span class="k">in</span><span class="w"> </span>the<span class="w"> </span>Saline<span class="w"> </span>group<span class="w"> </span>or<span class="w"> </span>the<span class="w"> </span>folders<span class="w"> </span>containing<span class="w"> </span>them&gt;<span class="o">]</span>

<span class="c1"># Usage if the native atlas is not available; it is not saved (faster):</span>
rstats<span class="w"> </span>-s<span class="w"> </span>rel_path/segmentation_image.nii.gz<span class="w"> </span>-m<span class="w"> </span><span class="nv">$SPLIT</span><span class="w"> </span>-c<span class="w"> </span>Saline<span class="w"> </span>-t<span class="w"> </span>cell_densities<span class="w"> </span><span class="o">[</span>-d<span class="w"> </span>&lt;paths<span class="w"> </span>to<span class="w"> </span>sample<span class="w"> </span>folders<span class="w"> </span><span class="k">in</span><span class="w"> </span>the<span class="w"> </span>Saline<span class="w"> </span>group<span class="w"> </span>or<span class="w"> </span>the<span class="w"> </span>folders<span class="w"> </span>containing<span class="w"> </span>them&gt;<span class="o">]</span>
</pre></div>
</div>
<p>Aggregate outputs from <code class="docutils literal notranslate"><span class="pre">rstats</span></code> with <code class="docutils literal notranslate"><span class="pre">utils_agg_files</span></code>.</p>
</section>
<section id="rstats-summary">
<h3><code class="docutils literal notranslate"><span class="pre">rstats_summary</span></code><a class="headerlink" href="#rstats-summary" title="Link to this heading">#</a></h3>
<p><code class="xref py py-mod docutils literal notranslate"><span class="pre">unravel.region_stats.regional_cell_densities_summary</span></code></p>
<ul class="simple">
<li><p>Plot cell densities for each region and summarize results.</p></li>
<li><p>CSVs from <code class="docutils literal notranslate"><span class="pre">rstats</span></code> should be in the current directory</p></li>
<li><p>CSV columns:</p>
<ul>
<li><p>Region_ID,Side,Name,Abbr,Saline_sample06,Saline_sample07,…,MDMA_sample01,…,Meth_sample23,…</p></li>
</ul>
</li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Usage for Tukey tests:</span>
rstats_summary<span class="w"> </span>--groups<span class="w"> </span>Saline<span class="w"> </span>MDMA<span class="w"> </span>Meth<span class="w"> </span>-hemi<span class="w"> </span>&lt;both<span class="w"> </span>l<span class="w"> </span>or<span class="w"> </span>r&gt;<span class="w"> </span><span class="o">[</span>-y<span class="w"> </span>cell_density<span class="o">]</span><span class="w"> </span><span class="o">[</span>-div<span class="w"> </span><span class="m">10000</span><span class="o">]</span>
<span class="c1"># -div 10000 divides cells per cubic mm by 10000 (for plotting)</span>
<span class="c1"># -y is the y-axis label</span>

<span class="c1"># Usage for t-tests:</span>
rstats_summary<span class="w"> </span>--groups<span class="w"> </span>Saline<span class="w"> </span>MDMA<span class="w"> </span>-hemi<span class="w"> </span>&lt;both<span class="w"> </span>l<span class="w"> </span>or<span class="w"> </span>r&gt;<span class="w">  </span>-t<span class="w"> </span>t-test<span class="w"> </span>-c<span class="w"> </span>Saline<span class="w"> </span><span class="o">[</span>-alt<span class="w"> </span>two-sided<span class="o">]</span><span class="w"> </span><span class="o">[</span>-y<span class="w"> </span>cell_density<span class="o">]</span><span class="w"> </span><span class="o">[</span>-div<span class="w"> </span><span class="m">10000</span><span class="o">]</span><span class="w"> </span>
</pre></div>
</div>
<hr class="docutils" />
<br>
</section>
</section>
<section id="example-sample-folder-structure">
<h2>Example sample?? Folder Structure<a class="headerlink" href="#example-sample-folder-structure" title="Link to this heading">#</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>.
├──<span class="w"> </span>atlas_space<span class="w">  </span><span class="c1"># Dir with images warped to atlas space</span>
├──<span class="w"> </span>cfos_seg_ilastik_1<span class="w">  </span><span class="c1"># Example dir with segmentations from ilastik</span>
├──<span class="w"> </span>clusters<span class="w">  </span><span class="c1"># Dir with cell/label density CSVs from cstats_validation</span>
│<span class="w">   </span>├──<span class="w"> </span>Control_v_Treatment_vox_p_tstat1_q0.005
│<span class="w">   </span>│<span class="w">   </span>└──<span class="w"> </span>cell_density_data.csv
│<span class="w">   </span>└──<span class="w"> </span>Control_v_Treatment_vox_p_tstat2_q0.05
│<span class="w">       </span>└──<span class="w"> </span>cell_density_data.csv
├──<span class="w"> </span>parameters<span class="w">  </span><span class="c1"># Optional dir for things like metadata.txt</span>
├──<span class="w"> </span>reg_inputs<span class="w">  </span><span class="c1"># From reg_prep (autofl image resampled for reg) and seg_brain_mask (mask, masked autofl)</span>
├──<span class="w"> </span>regional_cell_densities<span class="w">  </span><span class="c1"># CSVs with regional cell densities data</span>
├──<span class="w"> </span>reg_outputs<span class="w">  </span><span class="c1"># Outputs from reg. These images are typically padded w/ empty voxels. </span>
└──<span class="w"> </span>image.czi<span class="w"> </span><span class="c1"># Or other raw/stitched image type</span>
</pre></div>
</div>
</section>
<section id="example-experiment-folder-structure">
<h2>Example Experiment Folder Structure<a class="headerlink" href="#example-experiment-folder-structure" title="Link to this heading">#</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>.
├──<span class="w"> </span>exp_notes.txt
├──<span class="w"> </span>env_var.sh
├──<span class="w"> </span>sample_key.csv
├──<span class="w"> </span>Control
│<span class="w">   </span>├──<span class="w"> </span>sample01
│<span class="w">   </span>└──<span class="w"> </span>sample02
├──<span class="w"> </span>Treatment
│<span class="w">   </span>├──<span class="w"> </span>sample03
│<span class="w">   </span>└──<span class="w"> </span>sample04
├──<span class="w"> </span>atlas
│<span class="w">   </span>├──<span class="w"> </span>atlas_CCFv3_2020_30um.nii.gz<span class="w">  </span><span class="c1"># Each atlas region has a unique intensity/ID</span>
│<span class="w">   </span>├──<span class="w"> </span>atlas_CCFv3_2020_30um_split.nii.gz<span class="w">  </span><span class="c1"># Intensities in the left hemisphere are increased by 20,000</span>
│<span class="w">   </span>├──<span class="w"> </span>average_template_CCFv3_30um.nii.gz<span class="w">  </span><span class="c1"># Average template brain that is aligned with the atlas</span>
│<span class="w">   </span>└──<span class="w"> </span>mask_CCFv3_2020_30um_RH_wo_root_ventricles_fibers_OB.nii.gz<span class="w">  </span><span class="c1"># Right hemisphere mask that excludes undefined regions (root), ventricles, fiber tracts, and the olfactory bulb</span>
├──<span class="w"> </span>check_reg<span class="w">  </span><span class="c1"># run check_reg from here</span>
├──<span class="w"> </span>brain_mask
│<span class="w">   </span>├──<span class="w"> </span>brain_mask.ilp<span class="w">  </span><span class="c1"># Ilastik project trained with the pixel classification workflow to segment the brain in resampled autofluo images</span>
│<span class="w">   </span>├──<span class="w"> </span>sample01_slice_0000.tif
│<span class="w">   </span>├──<span class="w"> </span>sample01_slice_0005.tif
│<span class="w">   </span>├──<span class="w"> </span>sample01_slice_0050.tif
│<span class="w">   </span>├──<span class="w"> </span>...
│<span class="w">   </span>└──<span class="w"> </span>sample04_slice_0050.tif
├──<span class="w"> </span>vstats<span class="w">  </span><span class="c1"># Voxel-wise stats</span>
│<span class="w">   </span>└──<span class="w"> </span>Control_v_Treatment<span class="w"> </span>
│<span class="w">       </span>├──<span class="w"> </span>Control_sample01_rb4_atlas_space_z.tif
│<span class="w">       </span>├──<span class="w"> </span>Control_sample02_rb4_atlas_space_z.tif
│<span class="w">       </span>├──<span class="w"> </span>Treatment_sample03_rb4_atlas_space_z.tif
│<span class="w">       </span>├──<span class="w"> </span>Treatment_sample04_rb4_atlas_space_z.tif
│<span class="w">       </span>└──<span class="w"> </span>stats<span class="w"> </span>
│<span class="w">           </span>├──<span class="w"> </span>Control_v_Treatment_vox_p_tstat1.nii.gz<span class="w">  </span><span class="c1"># 1 minus p value map showing where Control (group 1) &gt; Treatment (group2)</span>
│<span class="w">           </span>├──<span class="w"> </span>Control_v_Treatment_vox_p_tstat2.nii.gz<span class="w">  </span><span class="c1"># 1-p value map showing where Treatment (group 2) &gt; Control (group 1)</span>
│<span class="w">           </span>├──<span class="w"> </span>Control_v_Treatment_vox_p_tstat1_q0.005<span class="w">  </span><span class="c1"># cluster correction folder</span>
│<span class="w">           </span>│<span class="w">   </span>├──<span class="w"> </span><span class="m">1</span>-p_value_threshold.txt<span class="w">  </span><span class="c1"># FDR adjusted 1-p value threshold for the uncorrected 1-p value map</span>
│<span class="w">           </span>│<span class="w">   </span>├──<span class="w"> </span>p_value_threshold.txt<span class="w">  </span><span class="c1"># FDR adjusted p value threshold</span>
│<span class="w">           </span>│<span class="w">   </span>├──<span class="w"> </span>min_cluster_size_in_voxels.txt<span class="w">  </span><span class="c1"># Often 100 voxels for c-Fos. For sparser signals like amyloid beta plaques, consider 400 or more</span>
│<span class="w">           </span>│<span class="w">   </span>└──<span class="w"> </span>..._rev_cluster_index.nii.gz<span class="w"> </span><span class="c1"># cluster map (index) with cluster IDs going from large to small (input for cstats_validation)</span>
│<span class="w">           </span>├──<span class="w"> </span>...
│<span class="w">           </span>└──<span class="w"> </span>Control_v_Treatment_vox_p_tstat2_q0.05
├──<span class="w"> </span>cstats<span class="w">  </span><span class="c1"># cluster stats (validation)</span>
│<span class="w">   </span>├──<span class="w"> </span>Control_v_Treatment_vox_p_tstat1_q0.005
│<span class="w">   </span>│<span class="w">   </span>├──<span class="w"> </span>Control_sample01_cell_density_data.csv
│<span class="w">   </span>│<span class="w">   </span>├──<span class="w"> </span>Control_sample02_cell_density_data.csv
│<span class="w">   </span>│<span class="w">   </span>├──<span class="w"> </span>Treatment_sample03_cell_density_data.csv
│<span class="w">   </span>│<span class="w">   </span>├──<span class="w"> </span>Treatment_sample04_cell_density_data.csv
│<span class="w">   </span>│<span class="w">   </span>├──<span class="w"> </span>_valid_clusters<span class="w">  </span><span class="c1"># Contains data for sunburst plots, 3D brains, the xlsx table, etc.</span>
│<span class="w">   </span>│<span class="w">   </span>├──<span class="w"> </span>_valid_cluster_stats<span class="w">  </span><span class="c1"># Contains t-test_results.csv for adding asterisks to the xlsx table, etc.</span>
│<span class="w">   </span>│<span class="w">   </span>├──<span class="w"> </span>_valid_clusters_prism<span class="w">  </span><span class="c1"># For making valid cluster bar graphs with GraphPad Prism. Clusters are sorted by anatomy (refer to the xlsx table for annotating it)</span>
│<span class="w">   </span>│<span class="w">   </span>└──<span class="w"> </span>p_value_threshold.txt
│<span class="w">   </span>├──<span class="w"> </span>3D_brains<span class="w">  </span><span class="c1"># Use these for vizualization in DSI Studio</span>
│<span class="w">   </span>├──<span class="w"> </span>valid_clusters_tables_and_legend<span class="w">  </span><span class="c1"># Use these .xlsx tables to make an SI table</span>
│<span class="w">   </span>├──<span class="w"> </span>cluster_validation_summary_t-test.csv<span class="w">  </span><span class="c1"># Use this to summarize cluster validation rates, etc.</span>
│<span class="w">   </span>├──<span class="w"> </span>...
│<span class="w">   </span>└──<span class="w"> </span>Control_v_Treatment_vox_p_tstat2_q0.05
└──<span class="w"> </span>rstats<span class="w"> </span><span class="c1"># regional stats</span>
<span class="w">    </span>├──<span class="w"> </span>Control_sample01_regional_cell_densities.csv
<span class="w">    </span>├──<span class="w"> </span>...
<span class="w">    </span>├──<span class="w"> </span>Treatment_sample04_regional_cell_densities.csv
<span class="w">    </span>├──<span class="w"> </span>regional_cell_densities_all.csv
<span class="w">    </span>└──<span class="w"> </span>Folders<span class="w"> </span>with<span class="w"> </span>plots<span class="w"> </span><span class="k">for</span><span class="w"> </span>each<span class="w"> </span>region
</pre></div>
</div>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="installation.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Installation</p>
      </div>
    </a>
    <a class="right-next"
       href="unravel/toc.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">unravel package</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#command-help-guides">Command Help Guides</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#listing-commands">Listing Commands</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#common-commands">Common Commands</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#set-up">Set Up</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#back-up-raw-data">Back Up Raw Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#stitch-z-stacks">Stitch Z-stacks</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#make-sample-folders">Make Sample Folders</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#add-images-to-sample-directories">Add Images to sample?? Directories</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#log-paths-commands-etc">Log Paths, Commands, etc.</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#make-a-sample-key-csv">Make a sample_key.csv:</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#defining-common-variables-for-command-arguments">Defining Common Variables for Command Arguments</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#optional-clean-tiffs">Optional: Clean TIFFs</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analysis-overview">Analysis Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#training-ilastik">Training Ilastik</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#registration">Registration</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#io-metadata"><code class="docutils literal notranslate"><span class="pre">io_metadata</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reg-prep"><code class="docutils literal notranslate"><span class="pre">reg_prep</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#seg-copy-tifs"><code class="docutils literal notranslate"><span class="pre">seg_copy_tifs</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#seg-brain-mask"><code class="docutils literal notranslate"><span class="pre">seg_brain_mask</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reg"><code class="docutils literal notranslate"><span class="pre">reg</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reg-check"><code class="docutils literal notranslate"><span class="pre">reg_check</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#voxel-wise-statistics">Voxel-wise Statistics</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#vstats-prep"><code class="docutils literal notranslate"><span class="pre">vstats_prep</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#vstats-z-score"><code class="docutils literal notranslate"><span class="pre">vstats_z_score</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#utils-agg-files"><code class="docutils literal notranslate"><span class="pre">utils_agg_files</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#vstats-whole-to-avg"><code class="docutils literal notranslate"><span class="pre">vstats_whole_to_avg</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#vstats"><code class="docutils literal notranslate"><span class="pre">vstats</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cluster-wise-statistics">Cluster-wise Statistics</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#false-discovery-rate-fdr-correction">False Discovery Rate (FDR) Correction</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cstats-fdr-range"><code class="docutils literal notranslate"><span class="pre">cstats_fdr_range</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cstats-fdr"><code class="docutils literal notranslate"><span class="pre">cstats_fdr</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cstats-mirror-indices"><code class="docutils literal notranslate"><span class="pre">cstats_mirror_indices</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#segmentation-of-full-resolution-fluorescence-images">Segmentation of Full-Resolution Fluorescence Images</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">1) <code class="docutils literal notranslate"><span class="pre">seg_copy_tifs</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#train-ilastik-to-segment-c-fos-cells-or-other-features">2) Train Ilastik to segment c-Fos+ cells or other features</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#seg-ilastik">3) <code class="docutils literal notranslate"><span class="pre">seg_ilastik</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cluster-validation-and-statistics">Cluster Validation and Statistics</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cstats-validation"><code class="docutils literal notranslate"><span class="pre">cstats_validation</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cstats-summary"><code class="docutils literal notranslate"><span class="pre">cstats_summary</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sunburst-plots">Sunburst Plots</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#d-brain-models">3D Brain Models</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#valid-cluster-info-tables">Valid Cluster Info Tables</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#region-wise-statistics">Region-wise Statistics</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#rstats"><code class="docutils literal notranslate"><span class="pre">rstats</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#rstats-summary"><code class="docutils literal notranslate"><span class="pre">rstats_summary</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-sample-folder-structure">Example sample?? Folder Structure</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-experiment-folder-structure">Example Experiment Folder Structure</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  <div class="tocsection sourcelink">
    <a href="_sources/guide.md.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2024, the UNRAVEL team.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.3.7.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.3.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>