
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" data-theme="dark">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>unravel.image_io.reorient_nii &#8212; UNRAVEL docs</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "dark";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "dark";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=872d93e8" />
  
  <!-- So that users can add custom icons -->
  <script src="../../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../../_static/documentation_options.js?v=8d563738"></script>
    <script src="../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.1.4/dist/mermaid-layout-elk.esm.min.mjs"></script>
    <script type="module">import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs";import elkLayouts from "https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.1.4/dist/mermaid-layout-elk.esm.min.mjs";mermaid.registerLayoutLoaders(elkLayouts);mermaid.initialize({startOnLoad:false});</script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
    <script type="module">
import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs";
window.addEventListener("load", () => mermaid.run());
</script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/unravel/image_io/reorient_nii';</script>
    <link rel="icon" href="../../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="dark">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
  
    <p class="title logo__title">UNRAVEL docs</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../installation.html">
    Installation
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../guide.html">
    LSFM/STPT Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../guide_mms.html">
    MapMySections Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../unravel/toc.html">
    unravel package
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/b-heifets/UNRAVEL" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-github-square fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../installation.html">
    Installation
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../guide.html">
    LSFM/STPT Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../guide_mms.html">
    MapMySections Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../unravel/toc.html">
    unravel package
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/b-heifets/UNRAVEL" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-github-square fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">unravel.image_io.reorient_nii</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for unravel.image_io.reorient_nii</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Use ``io_reorient_nii`` (``reorient``) from UNRAVEL to set the orientation of a .nii.gz or its affine matrix.</span>

<span class="sd">Input:</span>
<span class="sd">    - path/input_image.nii.gz</span>

<span class="sd">Output:</span>
<span class="sd">    - A .nii.gz images with the new orientation (e.g., image_PIR.nii.gz or image_PIR_applied.nii.gz)</span>

<span class="sd">The axis codes are:</span>
<span class="sd">    R: Right / L: Left </span>
<span class="sd">    A: Anterior / P: Posterior</span>
<span class="sd">    S: Superior / I: Inferior</span>

<span class="sd">The orientation code is a 3-letter code that indicates the direction of the axes in the image.</span>

<span class="sd">For the RAS+ orientation (default for NIfTI): </span>
<span class="sd">    - The right side is at the positive direction of the x-axis</span>
<span class="sd">    - The anterior side is at the positive direction of the y-axis</span>
<span class="sd">    - The superior side is at the positive direction of the z-axis</span>

<span class="sd">The orientation code also indicates the orientation of the axes in the affine matrix.</span>

<span class="sd">Example affine for RAS+ orientation:</span>
<span class="sd">    [[1  0  0  0]</span>
<span class="sd">    [ 0  1  0  0]</span>
<span class="sd">    [ 0  0  1  0]</span>
<span class="sd">    [ 0  0  0  1]]</span>

<span class="sd">    - The 1st letter is R since the 1st diagonal value is positive (the right side is at the positive direction of the x-axis)</span>
<span class="sd">    - The 2nd letter is A since the 2nd diagonal value is positive (the anterior side is at the positive direction of the y-axis)</span>
<span class="sd">    - The 3rd letter is S since the 3rd diagonal value is positive (the superior side is at the positive direction of the z-axis)</span>

<span class="sd">Example affine for LPS+ orientation:</span>
<span class="sd">    [[-1  0  0  0]</span>
<span class="sd">    [  0 -1  0  0]</span>
<span class="sd">    [  0  0  1  0]</span>
<span class="sd">    [  0  0  0  1]]</span>

<span class="sd">        -For LPS, the 1st letter is L since the 1st diagonal value is negative.</span>
<span class="sd">        -The 2nd letter is P since the 2nd diagonal value is negative.</span>
<span class="sd">        -The 3rd letter is S since the 3rd diagonal value is positive.</span>

<span class="sd">Example affine for PIR+ orientation (default for CCFv3):</span>
<span class="sd">    [[ 0  0  1  0]</span>
<span class="sd">    [ -1  0  0  0]</span>
<span class="sd">    [  0 -1  0  0]</span>
<span class="sd">    [  0  0  0  1]]</span>

<span class="sd">For PIR:</span>
<span class="sd">    First letter determination: </span>
<span class="sd">        -The 1st column has a non-zero value at the 2nd row, so the 1st letter is either A or P (2nd letter of the default &#39;RAS&#39; orientation code).</span>
<span class="sd">        -Since the valud is negative, the 1st letter is P</span>
<span class="sd">    Second letter determination:</span>
<span class="sd">        -The 2nd column has a non-zero value at the 3rd row, so the 2nd letter is either S or I (3rd letter of the default &#39;RAS&#39; orientation code).</span>
<span class="sd">        -Since the value is negative, the 2nd letter is I</span>
<span class="sd">    Third letter determination:</span>
<span class="sd">        -The 3rd column has a non-zero value at the 1st row, so the 3rd letter is either R or L (1st letter of the default &#39;RAS&#39; orientation code).</span>
<span class="sd">        -Since the value is positive, the 3rd letter is R</span>

<span class="sd">Usage:</span>
<span class="sd">------</span>
<span class="sd">    io_reorient_nii -i image.nii.gz -t PIR [-o image_PIR.nii.gz] [-z] [-a] [-fc 2] [-v]</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">nibabel</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">nibabel.orientations</span><span class="w"> </span><span class="kn">import</span> <span class="n">axcodes2ornt</span><span class="p">,</span> <span class="n">ornt_transform</span><span class="p">,</span> <span class="n">io_orientation</span><span class="p">,</span> <span class="n">aff2axcodes</span><span class="p">,</span> <span class="n">apply_orientation</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rich</span><span class="w"> </span><span class="kn">import</span> <span class="nb">print</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rich.traceback</span><span class="w"> </span><span class="kn">import</span> <span class="n">install</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">unravel.core.help_formatter</span><span class="w"> </span><span class="kn">import</span> <span class="n">RichArgumentParser</span><span class="p">,</span> <span class="n">SuppressMetavar</span><span class="p">,</span> <span class="n">SM</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">unravel.core.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">Configuration</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unravel.core.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">log_command</span><span class="p">,</span> <span class="n">verbose_start_msg</span><span class="p">,</span> <span class="n">verbose_end_msg</span>


<div class="viewcode-block" id="parse_args">
<a class="viewcode-back" href="../../../unravel/image_io/reorient_nii.html#unravel.image_io.reorient_nii.parse_args">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_args</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">RichArgumentParser</span><span class="p">(</span><span class="n">formatter_class</span><span class="o">=</span><span class="n">SuppressMetavar</span><span class="p">,</span> <span class="n">add_help</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">docstring</span><span class="o">=</span><span class="vm">__doc__</span><span class="p">)</span>

    <span class="n">reqs</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s1">&#39;Required arguments&#39;</span><span class="p">)</span>
    <span class="n">reqs</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="s1">&#39;--input&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;path/img.nii.gz&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">SM</span><span class="p">)</span>
    <span class="n">reqs</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="s1">&#39;--target_ort&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Target orientation axis codes (e.g., RAS)&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">SM</span><span class="p">)</span>

    <span class="n">opts</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s1">&#39;Optional args&#39;</span><span class="p">)</span>
    <span class="n">reqs</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="s1">&#39;--output&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;path/img.nii.gz&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">SM</span><span class="p">)</span>
    <span class="n">opts</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-z&#39;</span><span class="p">,</span> <span class="s1">&#39;--zero_origin&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Provide flag to zero the origin of the affine matrix.&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">opts</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-a&#39;</span><span class="p">,</span> <span class="s1">&#39;--apply&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Provide flag to apply the new orientation to the ndarray data.&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">opts</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-fc&#39;</span><span class="p">,</span> <span class="s1">&#39;--form_code&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Set the sform and qform codes for spatial coordinate type (1 = scanner; 2 = aligned)&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="n">general</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s1">&#39;General arguments&#39;</span><span class="p">)</span>
    <span class="n">general</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-v&#39;</span><span class="p">,</span> <span class="s1">&#39;--verbose&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Increase verbosity. Default: False&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span></div>


<span class="c1"># TODO: Since .nii files from Fiji may have a data type that does not match the actual data type, we may need to infer the data type based on the actual min and max values. This could be used in img_io.py as well. nii.get_fdata() uses could be updated in other scripts as well.</span>

<div class="viewcode-block" id="transform_nii_affine">
<a class="viewcode-back" href="../../../unravel/image_io/reorient_nii.html#unravel.image_io.reorient_nii.transform_nii_affine">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">transform_nii_affine</span><span class="p">(</span><span class="n">nii</span><span class="p">,</span> <span class="n">target_ort</span><span class="p">,</span> <span class="n">zero_origin</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transform the affine matrix of a NIfTI image to a target orientation and return the new affine matrix</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        nii (nibabel.nifti1.Nifti1Image): NIfTI image</span>
<span class="sd">        target_ort (str): Target orientation axis codes (e.g., RAS)</span>
<span class="sd">        zero_origin (bool): Zero the origin of the affine matrix. Default: False</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Get the current axis codes</span>
    <span class="n">current_axcodes_tuple</span> <span class="o">=</span> <span class="n">aff2axcodes</span><span class="p">(</span><span class="n">nii</span><span class="o">.</span><span class="n">affine</span><span class="p">)</span> 
    <span class="n">current_axcodes</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_axcodes_tuple</span><span class="p">)</span> 
    <span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">suppress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Current affine matrix (</span><span class="si">{</span><span class="n">current_axcodes</span><span class="si">}</span><span class="s1">): </span><span class="se">\n</span><span class="si">{</span><span class="n">nii</span><span class="o">.</span><span class="n">affine</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># Get the current orientation</span>
    <span class="n">current_orientation</span> <span class="o">=</span> <span class="n">axcodes2ornt</span><span class="p">(</span><span class="n">current_axcodes_tuple</span><span class="p">)</span>

    <span class="c1"># Get the index of the target orientation</span>
    <span class="n">current_ort_first_col_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">current_orientation</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">current_ort_second_col_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">current_orientation</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">current_ort_third_col_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">current_orientation</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Convert the current affine to the target orientation</span>
    <span class="n">target_orientation</span> <span class="o">=</span> <span class="n">axcodes2ornt</span><span class="p">(</span><span class="n">target_ort</span><span class="p">)</span>

    <span class="c1"># Get the sign of the target orientation</span>
    <span class="n">sign_of_first_target_direction</span> <span class="o">=</span> <span class="n">target_orientation</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">sign_of_second_target_direction</span> <span class="o">=</span> <span class="n">target_orientation</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">sign_of_third_target_direction</span> <span class="o">=</span> <span class="n">target_orientation</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Get the index of the target orientation</span>
    <span class="n">new_ort_first_col_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">target_orientation</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">new_ort_second_col_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">target_orientation</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">new_ort_third_col_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">target_orientation</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Make an affine matrix for the target orientation</span>
    <span class="n">new_affine</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
    <span class="n">new_affine</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># Set the columns of the new affine matrix to the target orientation</span>
    <span class="n">new_affine</span><span class="p">[</span><span class="n">new_ort_first_col_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sign_of_first_target_direction</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">nii</span><span class="o">.</span><span class="n">affine</span><span class="p">[</span><span class="n">current_ort_first_col_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> 
    <span class="n">new_affine</span><span class="p">[</span><span class="n">new_ort_second_col_index</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sign_of_second_target_direction</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">nii</span><span class="o">.</span><span class="n">affine</span><span class="p">[</span><span class="n">current_ort_second_col_index</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> 
    <span class="n">new_affine</span><span class="p">[</span><span class="n">new_ort_third_col_index</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sign_of_third_target_direction</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">nii</span><span class="o">.</span><span class="n">affine</span><span class="p">[</span><span class="n">current_ort_third_col_index</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>

    <span class="c1"># Set the origin of the new affine matrix to the origin of the current affine matrix</span>
    <span class="n">new_affine</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">nii</span><span class="o">.</span><span class="n">affine</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>

    <span class="c1"># Zero the origin of the affine matrix</span>
    <span class="k">if</span> <span class="n">zero_origin</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">new_affine</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Get the axis codes of the new affine</span>
    <span class="n">new_axcodes_tuple</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">orientations</span><span class="o">.</span><span class="n">aff2axcodes</span><span class="p">(</span><span class="n">new_affine</span><span class="p">)</span> 
    <span class="n">new_axcodes</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_axcodes_tuple</span><span class="p">)</span> 
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">New affine matrix (</span><span class="si">{</span><span class="n">new_axcodes</span><span class="si">}</span><span class="s1">): </span><span class="se">\n</span><span class="si">{</span><span class="n">new_affine</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_affine</span></div>


<div class="viewcode-block" id="reorient_nii">
<a class="viewcode-back" href="../../../unravel/image_io/reorient_nii.html#unravel.image_io.reorient_nii.reorient_nii">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">reorient_nii</span><span class="p">(</span><span class="n">nii</span><span class="p">,</span> <span class="n">target_ort</span><span class="p">,</span> <span class="n">zero_origin</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">apply</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">form_code</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reorient a NIfTI image or its affine matrix to a target orientation.</span>

<span class="sd">    Args:</span>
<span class="sd">        nii (nibabel.nifti1.Nifti1Image): Input NIfTI image.</span>
<span class="sd">        target_ort (str): Target orientation axis codes (e.g., RAS).</span>
<span class="sd">        zero_origin (bool): Whether to zero the origin of the affine matrix.</span>
<span class="sd">        apply (bool): Apply the orientation change to the image data.</span>
<span class="sd">        form_code (int): Code for spatial coordinate type (e.g., 1 = scanner; 2 = aligned).</span>

<span class="sd">    Returns:</span>
<span class="sd">        nib.Nifti1Image: New NIfTI image with reoriented data and affine.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Load image data</span>
    <span class="n">data_type</span> <span class="o">=</span> <span class="n">nii</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get_data_dtype</span><span class="p">()</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">nii</span><span class="o">.</span><span class="n">dataobj</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

    <span class="c1"># Determine the actual min and max values</span>
    <span class="n">actual_min</span><span class="p">,</span> <span class="n">actual_max</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">img</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="c1"># # Infer true data type based on actual value range</span>
    <span class="c1"># if actual_min &gt;= 0 and actual_max &lt;= 255:</span>
    <span class="c1">#     inferred_type = np.uint8  # 8-bit unsigned</span>
    <span class="c1"># elif actual_min &gt;= 0 and actual_max &lt;= 65535:</span>
    <span class="c1">#     inferred_type = np.uint16  # 16-bit unsigned</span>
    <span class="c1"># elif np.issubdtype(data_type, np.floating) or actual_min &lt; 0 or actual_max &gt; 65535:</span>
    <span class="c1">#     inferred_type = np.float32  # 32-bit floating-point</span>
    <span class="c1"># else:</span>
    <span class="c1">#     inferred_type = data_type  # Fall back to metadata-specified type</span>

    <span class="k">if</span> <span class="n">apply</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Applying orientation change to the image data...&#39;</span><span class="p">)</span>
        <span class="n">current_orientation</span> <span class="o">=</span> <span class="n">io_orientation</span><span class="p">(</span><span class="n">nii</span><span class="o">.</span><span class="n">affine</span><span class="p">)</span>
        <span class="n">target_orientation</span> <span class="o">=</span> <span class="n">axcodes2ornt</span><span class="p">(</span><span class="n">target_ort</span><span class="p">)</span>
        <span class="n">orientation_change</span> <span class="o">=</span> <span class="n">ornt_transform</span><span class="p">(</span><span class="n">current_orientation</span><span class="p">,</span> <span class="n">target_orientation</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">apply_orientation</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">orientation_change</span><span class="p">)</span>

    <span class="c1"># Round values for integer types before casting</span>
    <span class="c1"># if np.issubdtype(inferred_type, np.integer):</span>
    <span class="c1">#     img = np.round(img).astype(inferred_type)</span>
    <span class="c1"># else:</span>
    <span class="c1">#     # For floating-point types, preserve precision</span>
    <span class="c1">#     img = img.astype(inferred_type)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">data_type</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">):</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">img</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">data_type</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># For floating-point types, preserve precision</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">data_type</span><span class="p">)</span>

    <span class="c1"># Generate the new affine matrix</span>
    <span class="n">new_affine</span> <span class="o">=</span> <span class="n">transform_nii_affine</span><span class="p">(</span><span class="n">nii</span><span class="p">,</span> <span class="n">target_ort</span><span class="p">,</span> <span class="n">zero_origin</span><span class="o">=</span><span class="n">zero_origin</span><span class="p">)</span>

    <span class="c1"># Create a new NIfTI image with the processed data and new affine</span>
    <span class="n">new_nii</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">new_affine</span><span class="p">)</span>
    <span class="c1"># new_nii.header.set_data_dtype(inferred_type)  # Preserve inferred data type</span>
    <span class="n">new_nii</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set_data_dtype</span><span class="p">(</span><span class="n">data_type</span><span class="p">)</span>  <span class="c1"># Preserve inferred data type</span>
    <span class="n">new_nii</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;xyzt_units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># mm, s</span>
    <span class="n">new_nii</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;regular&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;r&#39;</span>

    <span class="c1"># Update sform and qform codes if specified</span>
    <span class="k">if</span> <span class="n">form_code</span><span class="p">:</span>
        <span class="n">new_nii</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set_qform</span><span class="p">(</span><span class="n">new_affine</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="n">form_code</span><span class="p">)</span>
        <span class="n">new_nii</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set_sform</span><span class="p">(</span><span class="n">new_affine</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="n">form_code</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">new_nii</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set_qform</span><span class="p">(</span><span class="n">new_affine</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">nii</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;qform_code&#39;</span><span class="p">]))</span>
        <span class="n">new_nii</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set_sform</span><span class="p">(</span><span class="n">new_affine</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">nii</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;sform_code&#39;</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">new_nii</span></div>



<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../../../unravel/image_io/reorient_nii.html#unravel.image_io.reorient_nii.main">[docs]</a>
<span class="nd">@log_command</span>
<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="n">install</span><span class="p">()</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">()</span>
    <span class="n">Configuration</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">verbose</span>
    <span class="n">verbose_start_msg</span><span class="p">()</span>

    <span class="n">nii</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">input</span><span class="p">)</span>
    <span class="n">new_nii</span> <span class="o">=</span> <span class="n">reorient_nii</span><span class="p">(</span><span class="n">nii</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">target_ort</span><span class="p">,</span> <span class="n">zero_origin</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">zero_origin</span><span class="p">,</span> <span class="n">apply</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">apply</span><span class="p">,</span> <span class="n">form_code</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">form_code</span><span class="p">)</span>

    <span class="c1"># Save the new .nii.gz file</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">output</span><span class="p">:</span> 
        <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">new_nii</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">apply</span><span class="p">:</span>
            <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">new_nii</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.nii.gz&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">target_ort</span><span class="si">}</span><span class="s1">_applied.nii.gz&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">new_nii</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.nii.gz&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">target_ort</span><span class="si">}</span><span class="s1">.nii.gz&#39;</span><span class="p">))</span>

    <span class="n">verbose_end_msg</span><span class="p">()</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      Â© Copyright 2025, the UNRAVEL team.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.5.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>